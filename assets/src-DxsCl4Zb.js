function e(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function t(e){if(typeof e==`string`)return e.trim()||`0`;if(typeof e==`number`&&Number.isFinite(e)){let t=Math.floor(e);return String(t)}return`0`}function n(t){let n=e(t)?{...t}:{};return e(n.calendar)?n.calendar={...n.calendar}:n.calendar={},n.calendar.solarTerms!=null&&!e(n.calendar.solarTerms)&&delete n.calendar.solarTerms,n.calendar.trueSolarTime!=null&&!e(n.calendar.trueSolarTime)&&delete n.calendar.trueSolarTime,e(n.toggles)?n.toggles={...n.toggles}:n.toggles={},n.toggles.lifeStages==null&&n.toggles.lifeStage!=null&&(n.toggles.lifeStages=n.toggles.lifeStage),`lifeStage`in n.toggles&&delete n.toggles.lifeStage,n.strategies!=null&&(e(n.strategies)?(n.strategies={...n.strategies},n.strategies.lifeStages==null&&n.strategies.lifeStage!=null&&(n.strategies.lifeStages=n.strategies.lifeStage),`lifeStage`in n.strategies&&delete n.strategies.lifeStage):delete n.strategies),n}var r=[{from:`0`,to:`1`,migrate:n}];function i(n){let i=t(n?.schemaVersion),a=e(n)?{...n,schemaVersion:i}:{schemaVersion:i};for(;;){let e=t(a.schemaVersion);if(e===`1`)break;let n=r.find(t=>t.from===e);if(!n){a.schemaVersion=`1`;break}a=n.migrate(a),a.schemaVersion=n.to}return a}function a(e){if(!e||typeof e!=`object`||Array.isArray(e))return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}function o(e,t){if(t==null)return e;if(Array.isArray(e)||Array.isArray(t))return Array.isArray(t)?t:e;if(a(e)&&a(t)){let n={...e};for(let[e,r]of Object.entries(t))e in n?n[e]=o(n[e],r):n[e]=r;return n}return t}function s(e){return Array.isArray(e)?e:[e]}function c(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;let n={...e},r=new Set([...Object.keys(e??{}),...Object.keys(t??{})]);for(let i of r){let r=e[i],a=t[i];if(r==null){n[i]=a;continue}if(a==null){n[i]=r;continue}n[i]=[...s(r),...s(a)]}return n}function l(e,t){let n=e?.overlayBlocks?.[t];return!n||typeof n!=`object`?null:n}function u(e,t){let n=e?.ruleSpecBlocks?.[t];return!n||typeof n!=`object`||typeof n.target!=`string`||!(`spec`in n)?null:n}function d(e,t){let n=e??{},r=t??{},i=[...n.overlayBlocks??[],...r.overlayBlocks??[]],a=[...n.ruleSpecBlocks??[],...r.ruleSpecBlocks??[]],o={};return i.length&&(o.overlayBlocks=i),a.length&&(o.ruleSpecBlocks=a),Object.keys(o).length?o:void 0}function f(e){let t=new Set,n=[];for(let r of e)t.has(r)||(t.add(r),n.push(r));return n}function p(e,t,n=[]){let r=e.extends;if(!r||n.includes(e.id))return e;let i=(t.presets??[]).find(e=>e?.id===r);if(!i)return e;let a=p(i,t,[...n,e.id]),s=o(a.overlay??{},e.overlay??{}),c=d(a.include,e.include),l=f([...a.aliases??[],...e.aliases??[]]),u=f([...a.sources??[],...e.sources??[]]);return{...e,overlay:Object.keys(s??{}).length?s:e.overlay,include:c,aliases:l.length?l:e.aliases,sources:u.length?u:e.sources}}function m(e,t){let n=p(e,t),r={};for(let e of n.include?.overlayBlocks??[]){let n=l(t,e);n&&(r=o(r,n))}n.overlay&&(r=o(r,n.overlay));let i=n.include?.ruleSpecBlocks??[];if(i.length){let e={};for(let n of i){let r=u(t,n);if(!r)continue;let i=r.target,a=e[i],o=r.spec;e[i]=a==null?o:[...s(a),...s(o)]}let n=r.extensions??{};r.extensions=n,n.ruleSpecs=c(n.ruleSpecs,e)}return{id:n.id,name:n.name,description:n.description,aliases:n.aliases,sources:n.sources,overlay:r}}function h(e){let t={};for(let n of e)for(let e of n.presets??[]){if(!e||typeof e.id!=`string`)continue;let r=m(e,n);t[r.id]={preset:r,packId:n.id};for(let e of r.aliases??[])t[e]={preset:r,packId:n.id}}return t}function g(e){let t=e.extensions??{},n=t.presetPacks??t.schoolPacks??t?.schools?.packs;if(!n)return[];let r=Array.isArray(n)?n:[n],i=[];for(let e of r)!e||typeof e!=`object`||typeof e.schemaVersion==`string`&&typeof e.id==`string`&&Array.isArray(e.presets)&&i.push(e);return i}var _={schemaVersion:`1`,id:`builtin`,name:`Built-in school preset pack`,description:`Data-only presets and reusable ruleSpec blocks.`,ruleSpecBlocks:{"yongshin.ziping.roleBoost":{target:`yongshin`,spec:{id:`yongshin.ziping.roleBoost`,version:`0.3`,description:`Month-main-tenGod → yongshin role bias (Ziping/격국 style).`,base:`default`,mode:`append`,macros:[{kind:`monthTenGodRoleBias`,basis:`main`,bonuses:{OFFICER:.35,WEALTH:.28,OUTPUT:.15,RESOURCE:-.08,COMPANION:-.18},idPrefix:`ZIPING_ROLE`,explainTemplate:`월지(본기) 십성({tenGod}) → 역할({role}) 기반 용신 가산`,tags:[`SCHOOL`,`ZIPING`]}]}},"yongshin.tongguan.bridge":{target:`yongshin`,spec:{id:`yongshin.tongguan.bridge`,version:`0.2`,description:`Tongguan bridge bias: intensity×bonus to bridge element.`,base:`default`,mode:`append`,macros:[{kind:`tongguanBridge`,intensityField:`intensity`,minIntensityVar:`config.strategies.yongshin.bridge.minIntensity`,bonusVar:`config.strategies.yongshin.bridge.bonus`,idPrefix:`TONGGUAN`,explainTemplate:`통관({pair}) 구조 → 브리지 오행({bridge}) 가산 (강도×보너스)`,tags:[`SCHOOL`,`TONGGUAN`]}]}},"yongshin.follow.jonggyeok":{target:`yongshin`,spec:{id:`yongshin.follow.jonggyeok`,version:`0.2`,description:`Follow(jonggyeok) signal → boost dominant element as yongshin.`,base:`default`,mode:`append`,macros:[{kind:`followJonggyeok`,minFactor:.55,bonus:1.25,mode:`ANY`,idPrefix:`FOLLOW_YONGSHIN`,tags:[`SCHOOL`,`FOLLOW`]}]}},"gyeokguk.ziping.monthGyeokTenGod":{target:`gyeokguk`,spec:{id:`gyeokguk.ziping.monthGyeokTenGod`,version:`0.2`,description:`Month-gyeok(월지 투간/회지) tenGod → base gyeokguk scoring.`,base:`default`,mode:`append`,macros:[{kind:`monthGyeokTenGod`,idPrefix:`ZIPING_MONTH_GYEOK`,bonus:1,tags:[`SCHOOL`,`ZIPING`]}]}},"gyeokguk.hwagyeok.patterns":{target:`gyeokguk`,spec:{id:`gyeokguk.hwagyeok.patterns`,version:`0.2`,description:`HwaGyeok: patterns.transformations.best.huaqiFactor → gyeokguk.HUA_QI`,base:`default`,mode:`append`,macros:[{kind:`transformationsBest`,factor:`huaqi`,minFactor:.55,bonus:1.2,key:`gyeokguk.HUA_QI`,requireDayMasterInvolved:!0,idPrefix:`HWAGYEOK`,explainTemplate:`합화(化氣) best(huaqiFactor) → 화격(HUA_QI) 가산`,tags:[`SCHOOL`,`HWAGYEOK`]}]}},"yongshin.zhuanwang.oneElement":{target:`yongshin`,spec:{id:`yongshin.zhuanwang.oneElement`,version:`0.2`,description:`One-element dominance → boost dominant element as yongshin (scaled by factor).`,base:`default`,mode:`append`,macros:[{kind:`oneElementDominance`,factor:`zhuanwang`,minFactor:.55,bonus:1.2,idPrefix:`ZHUANWANG_YONGSHIN`,tags:[`SCHOOL`,`ZHUAN_WANG`]}]}},"gyeokguk.zhuanwang.oneElement":{target:`gyeokguk`,spec:{id:`gyeokguk.zhuanwang.oneElement`,version:`0.2`,description:`One-element dominance → score special frame gyeokguk.ZHUAN_WANG (scaled by factor).`,base:`default`,mode:`append`,macros:[{kind:`oneElementDominance`,factor:`zhuanwang`,minFactor:.55,bonus:1.2,key:`gyeokguk.ZHUAN_WANG`,idPrefix:`ZHUANWANG_GYEOK`,tags:[`SCHOOL`,`ZHUAN_WANG`]}]}}},presets:[{id:`balance`,name:`균형(扶抑) 중심`,description:`오행 불균형(deficiency) + 신강/신약(role) 수학 모델을 중심으로 용신을 잡는다.`,aliases:[`扶抑`,`균형`,`balance`,`fuyi`],sources:[`docs/16_yongshin_methods.md`],overlay:{toggles:{rules:!0},strategies:{strength:{model:`deLingDiShi`},yongshin:{weights:{balance:1,role:.75,climate:0,medicine:.2,tongguan:0,follow:0,johooTemplate:0,transformations:0,oneElement:0},climate:{enabled:!1}}}}},{id:`johoo`,name:`조후(調候/窮通寶鑑) 중심`,description:`월지(월령)의 한난조습(env) 불균형을 먼저 보고, 기후 결핍(need)을 오행 점수로 환원한다.`,aliases:[`調候`,`조후`,`궁통보감`,`窮通寶鑑`,`johoo`,`qiongtong`],sources:[`docs/18_school_sources.md`,`docs/20_johoo_template.md`],overlay:{toggles:{rules:!0},strategies:{strength:{model:`deLingDiShi`},yongshin:{weights:{balance:.25,role:.2,climate:1.2,medicine:.15,tongguan:0,follow:0,johooTemplate:.55,transformations:0,oneElement:0},climate:{enabled:!0},climateUrgency:{enabled:!0,threshold:.55,maxBoost:1.25,reduceOthers:.2},johooTemplate:{enabled:!0,seasonMandatoryBoost:.35,stemPreferenceBoost:.25,enforceSummerWinter:!0},methodSelector:{enabled:!0,climate:{enabled:!0,threshold:.55,maxBoost:1.25,reduceOthers:.2},medicine:{enabled:!0,threshold:.2,maxBoost:.75,reduceOthers:.1},johooTemplate:{enabled:!0,scaleBy:`climate`}}}}}},{id:`johoo.strict`,name:`조후(調候) 우선(엄격)`,description:`조후를 최우선(调候为急)으로 두고, 다른 방법(扶抑/격국/특수격)을 더 약하게 처리한다.`,aliases:[`調候.엄격`,`조후.엄격`,`johoo.strict`],sources:[`docs/20_johoo_template.md`],overlay:{toggles:{rules:!0},strategies:{strength:{model:`deLingDiShi`},yongshin:{weights:{balance:.15,role:.1,climate:1.45,medicine:.1,tongguan:0,follow:0,johooTemplate:.85,transformations:0,oneElement:0},climate:{enabled:!0},climateUrgency:{enabled:!0,threshold:.5,maxBoost:1.35,reduceOthers:.35},johooTemplate:{enabled:!0,seasonMandatoryBoost:.45,stemPreferenceBoost:.3,enforceSummerWinter:!0},methodSelector:{enabled:!0,climate:{enabled:!0,threshold:.5,maxBoost:1.35,reduceOthers:.35},johooTemplate:{enabled:!0,scaleBy:`always`}}}}}},{id:`tongguan`,name:`통관(通關) 중심(실험)`,description:`수화/목금 등 상극 구조에서 “브리지 오행”이 강하면 해당 오행을 용신 후보로 올린다.`,aliases:[`通關`,`통관`,`tongguan`,`bridge`],sources:[`docs/22_tongguan_distribution.md`],include:{ruleSpecBlocks:[`yongshin.tongguan.bridge`]},overlay:{toggles:{rules:!0},strategies:{strength:{model:`deLingDiShi`},yongshin:{weights:{balance:.75,role:.3,climate:0,medicine:0,tongguan:1.1,follow:0,johooTemplate:0,transformations:0,oneElement:0},bridge:{minIntensity:.22,bonus:1.4},climate:{enabled:!1}}}}},{id:`gyeokguk`,name:`격국(格局/子平) 기반`,description:`월지 “투간/회지” 십성(격)을 우선하고, 그 격의 역할(role)을 용신 후보에 가산한다(온건한 편향).`,aliases:[`ziping`,`格局`,`子平`,`격국`,`자평`,`자평진전`,`子平真诠`,`zipingzhenquan`,`渊海子平`,`淵海子平`,`yuanhaiziping`,`hybrid.gyeokguk`],sources:[`docs/19_gyeokguk_quality.md`],include:{ruleSpecBlocks:[`yongshin.ziping.roleBoost`,`gyeokguk.ziping.monthGyeokTenGod`]},overlay:{toggles:{rules:!0},strategies:{patterns:{follow:{enabled:!0,jonggyeok:{enabled:!0,typeAware:{enabled:!0}}}},strength:{model:`deLingDiShi`},yongshin:{weights:{balance:.9,role:.7,climate:0,medicine:0,tongguan:0,follow:0,johooTemplate:0,transformations:0,oneElement:0},climate:{enabled:!1}}}}},{id:`ziping.strict`,name:`자평진전(子平真诠) 월령우선(엄격)`,description:`“용신은 월령을 먼저 본다(专求月令)”를 최대한 강조: 격국(month.gyeok)과 role bias를 핵심으로 두고, 특수 프레임(종격/화격/전왕)은 기본적으로 약하게 처리.`,aliases:[`子平真诠.엄격`,`자평.엄격`,`zipingzhenquan.strict`],sources:[`docs/19_gyeokguk_quality.md`],include:{ruleSpecBlocks:[`yongshin.ziping.roleBoost`,`gyeokguk.ziping.monthGyeokTenGod`]},overlay:{toggles:{rules:!0},strategies:{strength:{model:`deLingDiShi`},yongshin:{weights:{balance:.55,role:1.05,climate:0,medicine:0,tongguan:0,follow:0,johooTemplate:0,transformations:0,oneElement:0},climate:{enabled:!1}},gyeokguk:{competition:{enabled:!0,methods:[`tenGod`,`follow`,`transformations`,`oneElement`],power:2.3,minKeep:.25,renormalize:!0,signals:{tenGod:`monthQuality`,follow:`auto`,transformations:`auto`,oneElement:`auto`}}}}}},{id:`integrated.3d`,name:`통합(구조+균형+조후) 3차원 프리셋`,description:`구조(格局)·균형(扶抑)·조후(調候) 3축을 함께 사용한다.`,aliases:[`구조균형조화`,`integrated`,`3d`,`kci.integrated`],sources:[`docs/17_schools.md`],include:{ruleSpecBlocks:[`yongshin.ziping.roleBoost`,`gyeokguk.ziping.monthGyeokTenGod`]},overlay:{toggles:{rules:!0},strategies:{strength:{model:`deLingDiShi`},yongshin:{weights:{balance:.7,role:.65,climate:.95,medicine:.25,tongguan:0,follow:0,johooTemplate:.35,transformations:0,oneElement:0},climate:{enabled:!0},climateUrgency:{enabled:!0,threshold:.55,maxBoost:1.15,reduceOthers:.2},johooTemplate:{enabled:!0,seasonMandatoryBoost:.3,stemPreferenceBoost:.22,enforceSummerWinter:!0},methodSelector:{enabled:!0,climate:{enabled:!0,threshold:.55,maxBoost:1.15,reduceOthers:.2},medicine:{enabled:!0,threshold:.2,maxBoost:.7,reduceOthers:.1}}},gyeokguk:{competition:{enabled:!0,methods:[`tenGod`,`follow`,`transformations`,`oneElement`],power:2,minKeep:.2,renormalize:!0,signals:{tenGod:`monthQuality`,follow:`auto`,transformations:`auto`,oneElement:`auto`}}}}}},{id:`sanmingtonghui`,name:`三命通会(신살/격국 병행) 실험`,description:`神煞를 더 그대로 노출하기 위해 신살 조건 감쇠를 완화(비활성)하고, 격국+십성 관점을 함께 쓴다.`,aliases:[`三命通会`,`三命會通`,`sanming`,`sanmingtonghui`,`wanminying`,`万民英`],sources:[`docs/18_school_sources.md`,`docs/11_shinsal_conditions.md`],include:{ruleSpecBlocks:[`yongshin.ziping.roleBoost`,`gyeokguk.ziping.monthGyeokTenGod`]},overlay:{toggles:{rules:!0,fortune:!0},strategies:{strength:{model:`deLingDiShi`},shinsal:{conditions:{enabled:!1}},yongshin:{weights:{balance:.8,role:.75,climate:0,medicine:0,tongguan:0,follow:0,johooTemplate:0,transformations:0,oneElement:0},climate:{enabled:!1}},gyeokguk:{competition:{enabled:!0,methods:[`tenGod`,`follow`,`transformations`,`oneElement`],power:2,minKeep:.2,renormalize:!0,signals:{tenGod:`monthQuality`,follow:`auto`,transformations:`auto`,oneElement:`auto`}}}}}},{id:`follow`,name:`종격/从格(从势/从旺) 중심(실험)`,description:`신강/신약이 극단 + 세력 우세일 때 흐름을 따르는 패턴을 강조한다.`,aliases:[`從格`,`从格`,`종격`,`follow`,`cong`,`congge`],sources:[`docs/27_jonggyeok_condition_pack.md`],include:{ruleSpecBlocks:[`yongshin.follow.jonggyeok`]},overlay:{toggles:{rules:!0},strategies:{patterns:{follow:{enabled:!0,jonggyeok:{enabled:!0,typeAware:{enabled:!0}}}},strength:{model:`deLingDiShi`},yongshin:{weights:{balance:.25,role:.15,climate:0,medicine:0,tongguan:0,follow:1.2,johooTemplate:0,transformations:0,oneElement:0},follow:{enabled:!0,weakThreshold:-.78,minDominanceRatio:2.2},climate:{enabled:!1}}}}},{id:`ditiansui`,name:`적천수(滴天髓) 종합(扶抑+調候+通關+從勢)`,description:`扶抑/調候/通關/從勢를 함께 켠 “종합” 프리셋(실험적).`,aliases:[`滴天髓`,`적천수`,`DiTianSui`,`DTS`,`dts`,`ditian`,`di-tian-sui`],sources:[`docs/16_yongshin_methods.md`,`docs/20_johoo_template.md`,`docs/22_tongguan_distribution.md`,`docs/27_jonggyeok_condition_pack.md`],overlay:{toggles:{rules:!0},strategies:{patterns:{follow:{enabled:!0,jonggyeok:{enabled:!0,typeAware:{enabled:!0}}}},strength:{model:`deLingDiShi`},yongshin:{weights:{balance:.55,role:.35,climate:.7,medicine:.6,tongguan:.75,follow:1,johooTemplate:.35,transformations:0,oneElement:0},climate:{enabled:!0},climateUrgency:{enabled:!0,threshold:.55,maxBoost:1.1,reduceOthers:.2},methodSelector:{enabled:!0,climate:{enabled:!0,threshold:.55,maxBoost:1.1,reduceOthers:.2},medicine:{enabled:!0,threshold:.18,maxBoost:.9,reduceOthers:.15},tongguan:{enabled:!0,threshold:.25},follow:{enabled:!0,threshold:.55,weakThreshold:-.78,minDominanceRatio:2.2},johooTemplate:{enabled:!0,scaleBy:`climate`}},johooTemplate:{enabled:!0,seasonMandatoryBoost:.35,stemPreferenceBoost:.25,enforceSummerWinter:!0},bridge:{minIntensity:.22,bonus:1.4},follow:{enabled:!0,weakThreshold:-.78,minDominanceRatio:2.2}}}}},{id:`hwagyeok`,name:`화격/化气(합화) 중심(실험)`,description:`천간오합 합화 신호(patterns.transformations.best.huaqiFactor)가 강할 때 화격을 올린다(실험).`,aliases:[`化气`,`화격`,`합화`,`huagyeok`,`huagi`,`huaqi`,`transform`,`transformation`],sources:[`docs/25_transformations_huaqi.md`],include:{ruleSpecBlocks:[`gyeokguk.hwagyeok.patterns`]},overlay:{toggles:{rules:!0},strategies:{strength:{model:`deLingDiShi`},patterns:{transformations:{enabled:!0,threshold:.55,competition:{enabled:!0,startRatio:.78,maxPenalty:.35},huaqi:{enabled:!0,requireDayMasterInvolved:!0,shareThreshold:.45,qualityThreshold:.55,distanceExponent:2.5,harmThreshold:.18,weights:{share:.2,season:.15,root:.1,quality:.2,distance:.15,day:.1,noHarm:.1,origWeak:0},penalties:{broken:.25,mixed:.1,zhuo:.08}}}},yongshin:{weights:{balance:.4,role:.2,climate:0,medicine:0,tongguan:0,follow:0,johooTemplate:0,transformations:1.1,oneElement:0},methodSelector:{enabled:!0,transformations:{enabled:!0,threshold:.55}}},gyeokguk:{competition:{enabled:!0,methods:[`tenGod`,`follow`,`transformations`,`oneElement`],power:2,minKeep:.2,renormalize:!0}}}}},{id:`zhuanwang`,name:`专旺/일행득기 중심(실험)`,description:`오행 분포가 극도로 편중(일행득기/专旺)될 때, 신호를 용신 및 격국 후보에 직접 반영한다.`,aliases:[`专旺`,`전왕`,`일행득기`,`oneElement`,`one-element`,`concentration`],sources:[`docs/26_one_element_zhuanwang.md`],include:{ruleSpecBlocks:[`yongshin.zhuanwang.oneElement`,`gyeokguk.zhuanwang.oneElement`]},overlay:{toggles:{rules:!0},strategies:{strength:{model:`deLingDiShi`},patterns:{oneElement:{enabled:!0,thresholds:{topMin:.62,dominanceRatioMin:2.6,entropyMax:1.25},zhuanwang:{enabled:!0,requireDayMasterMatch:!0,lingThreshold:.55,diThreshold:.35,shiThreshold:.25,qualityThreshold:.55,strongThreshold:0,harmThreshold:.18,weights:{match:.2,ling:.2,di:.2,shi:.1,quality:.2,strong:.1,noHarm:.1},penalties:{broken:.25,mixed:.1,zhuo:.08}}}},yongshin:{weights:{balance:.45,role:.2,climate:0,medicine:0,tongguan:0,follow:0,johooTemplate:0,transformations:0,oneElement:0}},gyeokguk:{competition:{enabled:!0,methods:[`tenGod`,`follow`,`transformations`,`oneElement`],power:2,minKeep:.2,renormalize:!0}}}}},{id:`shinsal.virtueStrict`,name:`신살: 천덕/월덕 “일상견(日上見)” 엄격`,description:`천덕/월덕(및 합) 계열을 “일간/일지 중심”으로 판정한다. (고전 문구: 须要日上见)`,aliases:[`deokStrict`,`일상견`,`日上見`,`二德扶持`,`tianYueDe`],sources:[`docs/11_shinsal_conditions.md`],overlay:{strategies:{shinsal:{monthDeokScope:`dayOnly`}}}},{id:`qiongTongBaoJian`,name:`穷通宝鉴/궁통보감 프로필`,description:`조후(調候) 중심 접근을 빠르게 적용하기 위한 프로필. 현재 엔진에서는 johoo.strict와 동일하게 동작(확장 여지).`,extends:`johoo.strict`,aliases:[`qiongTong`,`qiongtong`,`qiongTongBaoJian`,`qiongtongbaojian`,`궁통보감`,`窮通寶鑑`,`穷通宝鉴`],sources:[`docs/18_school_sources.md`]},{id:`zipingzhenquan`,name:`子平真诠/자평진전 프로필`,description:`월령/격국 기반으로 용신·격국을 강하게 보는 프로필. 현재 엔진에서는 ziping.strict에 매핑(확장 여지).`,extends:`ziping.strict`,aliases:[`zipingZhenquan`,`zipingzhenquan`,`자평진전`,`子平真诠`,`子平真詮`],sources:[`docs/18_school_sources.md`]},{id:`yuhaiziping`,name:`渊海子平/연해자평 프로필`,description:`자평(子平) 계열의 종합적 관점을 반영하는 실용 프로필. 현재 엔진에서는 integrated.3d에 매핑(확장 여지).`,extends:`integrated.3d`,aliases:[`yuanhai`,`yuanhaiziping`,`yuhaiziping`,`연해자평`,`渊海子平`,`淵海子平`],sources:[`docs/18_school_sources.md`]},{id:`shenfengTongkao`,name:`神峰通考/신봉통고 프로필`,description:`고전 자평서의 종합적 프레임을 반영하는 프로필. 현재 엔진에서는 integrated.3d에 매핑(확장 여지).`,extends:`integrated.3d`,aliases:[`shenfeng`,`shenfengTongkao`,`신봉통고`,`神峰通考`],sources:[`docs/18_school_sources.md`]}]},v=(_.presets??[]).map(e=>m(e,_)),y=h([_]);function b(){return[...v]}function x(e){return e?y[e]?.preset??null:null}function S(e){return[_,...g(e)]}function C(e,t){return e?t.length===1&&t[0]===_?y[e]?.preset??null:h(t)[e]?.preset??null:null}function w(e,t){return c(e,t)}function T(e,t,n){let r=C(t,n?.length?n:[_]);if(!r)return e;let i=e.extensions?.ruleSpecs,a=r.overlay.extensions?.ruleSpecs,s=o(e,r.overlay),c=w(i,a);if(c!=null){let e=s.extensions??{};s.extensions=e,e.ruleSpecs=c}return s}const E={schemaVersion:`1`,calendar:{yearBoundary:`liChun`,monthBoundary:`jieqi`,dayBoundary:`midnight`,hourBoundary:`doubleHour`,solarTerms:{method:`meeus`,alwaysCompute:!1},trueSolarTime:{enabled:!1,equationOfTime:`off`,applyTo:`hourOnly`}},toggles:{pillars:!0,relations:!0,tenGods:!0,hiddenStems:!0,elementDistribution:!0,fortune:!0,rules:!0,lifeStages:!0,stemRelations:!0}};function D(e){let t=[],n=e=>{if(typeof e!=`string`)return;let n=e.trim();if(!n)return;let r=n.split(/[+,]/).map(e=>e.trim()).filter(Boolean);t.push(...r)};if(Array.isArray(e))for(let t of e)n(t);else n(e);let r=new Set,i=[];for(let e of t)r.has(e)||(r.add(e),i.push(e));return i}function O(e){let t=i(e),n=S(t),r=D((()=>{let e=t?.school?.id;if(e!=null)return e;let n=t.extensions??{},r=n?.presets?.school??n?.preset?.school??n?.school;if(r!=null)return r;let i=t.strategies??{};return i?.school??i?.schoolId??null})()),a=E;for(let e of r)a=T(a,e,n);return o(a,t)}function k(e){let t=1779033703^e.length,n=3144134277^e.length,r=1013904242^e.length,i=2773480762^e.length;for(let a=0;a<e.length;a++){let o=e.charCodeAt(a);t=Math.imul(t^o,2246822507),n=Math.imul(n^o,3266489909),r=Math.imul(r^o,668265263),i=Math.imul(i^o,374761393)}return t^=n>>>16,n^=r>>>13,r^=i>>>11,i^=t>>>9,t=Math.imul(t,2654435761),n=Math.imul(n,2246822507),r=Math.imul(r,3266489909),i=Math.imul(i,668265263),[t>>>0,n>>>0,r>>>0,i>>>0,(t^r)>>>0,(n^i)>>>0,t+n>>>0,r+i>>>0].map(e=>e.toString(16).padStart(8,`0`)).join(``)}function A(e,t){return JSON.stringify(j(e),null,t)}function j(e){if(e===null)return null;let t=typeof e;if(t===`number`||t===`string`||t===`boolean`||t!==`object`)return e;if(Array.isArray(e))return e.map(j);let n={},r=Object.keys(e).sort();for(let t of r)n[t]=j(e[t]);return n}function M(e,t){return(e%t+t)%t}const N=[`甲`,`乙`,`丙`,`丁`,`戊`,`己`,`庚`,`辛`,`壬`,`癸`],P=[`子`,`丑`,`寅`,`卯`,`辰`,`巳`,`午`,`未`,`申`,`酉`,`戌`,`亥`];var F=[`WOOD`,`WOOD`,`FIRE`,`FIRE`,`EARTH`,`EARTH`,`METAL`,`METAL`,`WATER`,`WATER`],I=[`YANG`,`YIN`,`YANG`,`YIN`,`YANG`,`YIN`,`YANG`,`YIN`,`YANG`,`YIN`],L=[`WATER`,`EARTH`,`WOOD`,`WOOD`,`EARTH`,`FIRE`,`FIRE`,`EARTH`,`METAL`,`METAL`,`EARTH`,`WATER`],R=[`YANG`,`YIN`,`YANG`,`YIN`,`YANG`,`YIN`,`YANG`,`YIN`,`YANG`,`YIN`,`YANG`,`YIN`];function z(e){return N[M(e,10)]}function B(e){return P[M(e,12)]}function V(e){return F[M(e,10)]}function H(e){return L[M(e,12)]}function U(e){return I[M(e,10)]}function W(e){return R[M(e,12)]}function G(e,t){return{stem:M(e,10),branch:M(t,12)}}function ee(e){return G(M(e,60)%10,M(e,60)%12)}function K(e){let t=M(e.stem,10),n=t-M(e.branch,12);return n%2==0?M(t+10*M(n/2,6),60):null}function q(e){let t=N.indexOf(e);return t>=0?t:null}function J(e){let t=P.indexOf(e);return t>=0?t:null}var te=864e5,Y=2440587.5;function ne(e){let t=e.y,n=e.m,r=e.d,i=Math.floor((14-n)/12),a=t+4800-i,o=n+12*i-3;return r+Math.floor((153*o+2)/5)+365*a+Math.floor(a/4)-Math.floor(a/100)+Math.floor(a/400)-32045}function re(e){return e/te+Y}function ie(e){return(e-Y)*te}var ae=Math.PI/180,oe=180/Math.PI;function se(e){let t=e%360;return t<0?t+360:t}function ce(e){return Math.sin(e*ae)}function le(e){return e*oe}var ue=[[175347046,0,0],[3341656,4.6692568,6283.07585],[34894,4.6261,12566.1517],[3497,2.7441,5753.3849],[3418,2.8289,3.5231],[3136,3.6277,77713.7715],[2676,4.4181,7860.4194],[2343,6.1352,3930.2097],[1324,.7425,11506.7698],[1273,2.0371,529.691],[1199,1.1096,1577.3435],[990,5.233,5884.927],[902,2.045,26.298],[857,3.508,398.149],[780,1.179,5223.694],[753,2.533,5507.553],[505,4.583,18849.228],[492,4.205,775.523],[357,2.92,.067],[317,5.849,11790.629],[284,1.899,796.298],[271,.315,10977.079],[243,.345,5486.778],[206,4.806,2544.314],[205,1.869,5573.143],[202,2.458,6069.777],[156,.833,213.299],[132,3.411,2942.463],[126,1.083,20.775],[115,.645,.98],[103,.636,4694.003],[102,.976,15720.839],[102,4.267,7.114],[99,6.21,2146.17],[98,.68,155.42],[86,5.98,161000.69],[85,1.3,6275.96],[85,3.67,71430.7],[80,1.81,17260.15],[79,3.04,12036.46],[75,1.76,5088.63],[74,3.5,3154.69],[74,4.68,801.82],[70,.83,9437.76],[62,3.98,8827.39],[61,1.82,7084.9],[57,2.78,6286.6],[56,4.39,14143.5],[56,3.47,6279.55],[52,.19,12139.55],[52,1.33,1748.02],[51,.28,5856.48],[49,.49,1194.45],[41,5.37,8429.24],[41,2.4,19651.05],[39,6.17,10447.39],[37,6.04,10213.29],[37,2.57,1059.38],[36,1.71,2352.87],[36,1.78,6812.77],[33,.59,17789.85],[30,.44,83996.85],[30,2.74,1349.87],[25,3.16,4690.48]],de=[[628331966747,0,0],[206059,2.678235,6283.07585],[4303,2.6351,12566.1517],[425,1.59,3.523],[119,5.796,26.298],[109,2.966,1577.344],[93,2.59,18849.23],[72,1.14,529.69],[68,1.87,398.15],[67,4.41,5507.55],[59,2.89,5223.69],[56,2.17,155.42],[45,.4,796.3],[36,.47,775.52],[29,2.65,7.11],[21,5.34,.98],[19,1.85,5486.78],[19,4.97,213.3],[17,2.99,6275.96],[16,.03,2544.31],[16,1.43,2146.17],[15,1.21,10977.08],[12,2.83,1748.02],[12,3.26,5088.63],[12,5.27,1194.45],[12,2.08,4694],[11,.77,553.57],[10,1.3,6286.6],[10,4.24,1349.87],[9,2.7,242.73],[9,5.64,951.72],[8,5.3,2352.87],[6,2.65,9437.76],[6,4.67,4690.48]],fe=[[52919,0,0],[8720,1.0721,6283.0758],[309,.867,12566.152],[27,.05,3.52],[16,5.19,26.3],[16,3.68,155.42],[10,.76,18849.23],[9,2.06,77713.77],[7,.83,775.52],[5,4.66,1577.34],[4,1.03,7.11],[4,3.44,5573.14],[3,5.14,796.3],[3,6.05,5507.55],[3,1.19,242.73],[3,6.12,529.69],[3,.31,398.15],[3,2.28,553.57],[2,4.38,5223.69],[2,3.75,.98]],pe=[[289,5.844,6283.076],[35,0,0],[17,5.49,12566.15],[3,5.2,155.42],[1,4.72,3.52],[1,5.3,18849.23],[1,5.97,242.73]],me=[[114,3.142,0],[8,4.13,6283.08],[1,3.84,12566.15]],he=[[1,3.14,0]];function ge(e,t){let n=0;for(let r=0;r<e.length;r++){let[i,a,o]=e[r];n+=i*Math.cos(a+o*t)}return n}function _e(e){let t=ge(ue,e),n=ge(de,e),r=ge(fe,e),i=ge(pe,e),a=ge(me,e),o=ge(he,e);return se(le((t+n*e+r*e**2+i*e**3+a*e**4+o*e**5)/1e8))}function ve(e,t){let n=e+(t-.5)/12;if(e<-500){let e=(n-1820)/100;return-20+32*e*e}if(e<500){let e=n/100;return 10583.6-1014.41*e+33.78311*e**2-5.952053*e**3-.1798452*e**4+.022174192*e**5+.0090316521*e**6}if(e<1600){let e=(n-1e3)/100;return 1574.2-556.01*e+71.23472*e**2+.319781*e**3-.8503463*e**4-.005050998*e**5+.0083572073*e**6}if(e<1700){let e=n-1600;return 120-.9808*e-.01532*e**2+e**3/7129}if(e<1800){let e=n-1700;return 8.83+.1603*e-.0059285*e**2+13336e-8*e**3-e**4/1174e3}if(e<1860){let e=n-1800;return 13.72-.332447*e+.0068612*e**2+.0041116*e**3-37436e-8*e**4+121272e-10*e**5-1.699e-7*e**6+875e-12*e**7}if(e<1900){let e=n-1860;return 7.62+.5737*e-.251754*e**2+.01680668*e**3-.0004473624*e**4+e**5/233174}if(e<1920){let e=n-1900;return-2.79+1.494119*e-.0598939*e**2+.0061966*e**3-197e-6*e**4}if(e<1941){let e=n-1920;return 21.2+.84493*e-.0761*e**2+.0020936*e**3}if(e<1961){let e=n-1950;return 29.07+.407*e-e**2/233+e**3/2547}if(e<1986){let e=n-1975;return 45.45+1.067*e-e**2/260-e**3/718}if(e<2005){let e=n-2e3;return 63.86+.3345*e-.060374*e**2+.0017275*e**3+651814e-9*e**4+2373599e-11*e**5}if(e<2050){let e=n-2e3;return 62.92+.32217*e+.005589*e**2}if(e<2150){let e=(n-1820)/100;return-20+32*e*e-.5628*(2150-n)}let r=(n-1820)/100;return-20+32*r*r}function ye(e){let t=ie(e),n=new Date(t);return ve(n.getUTCFullYear(),n.getUTCMonth()+1)}function be(e){let t=e+ye(e)/86400,n=(t-2451545)/36525,r=se(_e((t-2451545)/365250)+180),i=125.04-1934.136*n;return se(r-.00569-.00478*ce(i))}var xe=[{id:`XIAOHAN`,longitude:285,approx:{m:1,d:6}},{id:`DAHAN`,longitude:300,approx:{m:1,d:20}},{id:`LICHUN`,longitude:315,approx:{m:2,d:4}},{id:`YUSHUI`,longitude:330,approx:{m:2,d:19}},{id:`JINGZHE`,longitude:345,approx:{m:3,d:6}},{id:`CHUNFEN`,longitude:0,approx:{m:3,d:20}},{id:`QINGMING`,longitude:15,approx:{m:4,d:5}},{id:`GUYU`,longitude:30,approx:{m:4,d:20}},{id:`LIXIA`,longitude:45,approx:{m:5,d:5}},{id:`XIAOMAN`,longitude:60,approx:{m:5,d:21}},{id:`MANGZHONG`,longitude:75,approx:{m:6,d:6}},{id:`XIAZHI`,longitude:90,approx:{m:6,d:21}},{id:`XIAOSHU`,longitude:105,approx:{m:7,d:7}},{id:`DASHU`,longitude:120,approx:{m:7,d:23}},{id:`LIQIU`,longitude:135,approx:{m:8,d:7}},{id:`CHUSHU`,longitude:150,approx:{m:8,d:23}},{id:`BAILU`,longitude:165,approx:{m:9,d:8}},{id:`QIUFEN`,longitude:180,approx:{m:9,d:23}},{id:`HANLU`,longitude:195,approx:{m:10,d:8}},{id:`SHUANGJIANG`,longitude:210,approx:{m:10,d:23}},{id:`LIDONG`,longitude:225,approx:{m:11,d:7}},{id:`XIAOXUE`,longitude:240,approx:{m:11,d:22}},{id:`DAXUE`,longitude:255,approx:{m:12,d:7}},{id:`DONGZHI`,longitude:270,approx:{m:12,d:21}}],Se=new Map(xe.map(e=>[e.id,e])),Ce=new Map(xe.map(e=>[Ee(e.longitude),e.approx])),we=new Set([`XIAOHAN`,`LICHUN`,`JINGZHE`,`QINGMING`,`LIXIA`,`MANGZHONG`,`XIAOSHU`,`LIQIU`,`BAILU`,`HANLU`,`LIDONG`,`DAXUE`]),Te=864e5;function Ee(e){return M(e,360)}function De(e,t){let n=Ee(e-t+180)-180;return n<=-180?n+360:n}function Oe(e){return be(e)}function ke(e){let t=Se.get(e);if(!t)throw Error(`Unknown solar term id: ${e}`);return Ee(t.longitude)}function Ae(e){return we.has(e)}function je(e){let t=ke(e);return Math.floor(Ee(t-315)/30)}function Me(e,t){let n=Date.UTC(e,2,20,0,0,0)+Math.round(Ee(t)/360*365.2422)*Te,r=new Date(n);return{m:r.getUTCMonth()+1,d:r.getUTCDate()}}function Ne(e,t,n){let r=re(Date.UTC(e,n.m-1,n.d,0,0,0)),i=r-30,a=De(Oe(i),t);for(let e=1;e<=60;e++){let n=r-30+e,o=De(Oe(n),t);if(a===0)return{aJd:i,bJd:i};if(o===0)return{aJd:n,bJd:n};if(a*o<0)return{aJd:i,bJd:n};i=n,a=o}throw Error(`Unable to bracket solar term for year=${e}, target=${t}° within ±30 days of ${n.m}/${n.d}.`)}function Pe(e,t,n){if(e===t)return e;let r=e,i=t,a=De(Oe(r),n),o=De(Oe(i),n);if(a===0)return r;if(o===0)return i;if(a*o>0)return Math.abs(a)<Math.abs(o)?r:i;for(let e=0;e<64;e++){let e=(r+i)/2,t=De(Oe(e),n);if(t===0)return e;if(a*t<0?(i=e,o=t):(r=e,a=t),(i-r)*Te<1e3)break}return(r+i)/2}function Fe(e,t,n){let r=Ee(t),i=Ce.get(r)??Me(e,r);if(n===`approx`)return Date.UTC(e,i.m-1,i.d,0,0,0);let{aJd:a,bJd:o}=Ne(e,r,i),s=Pe(a,o,r);return Math.round(ie(s))}var Ie=new Map,Le=new Map;function Re(e,t){let n=`${t}:${e}`,r=Ie.get(n);if(r)return r;let i=xe.map(n=>({id:n.id,year:e,longitude:Ee(n.longitude),utcMs:Fe(e,n.longitude,t)})).sort((e,t)=>e.utcMs-t.utcMs);return Ie.set(n,i),i}function ze(e,t){let n=`${t}:${e}`,r=Le.get(n);if(r)return r;let i=Re(e,t).filter(e=>Ae(e.id)).sort((e,t)=>e.utcMs-t.utcMs);return Le.set(n,i),i}function Be(e,t){return{baseYear:e,method:t,terms:[...Re(e-1,t),...Re(e,t),...Re(e+1,t)].sort((e,t)=>e.utcMs-t.utcMs)}}function Ve(e,t){let n=ze(e,t).find(e=>e.id===`LICHUN`);if(!n)throw Error(`Invariant: LICHUN missing from Jie terms`);return n.utcMs}var He=29.530588853,Ue=2451550.09765;function We(e){return e*Math.PI/180}function Ge(e){let t=e%360;return t<0?t+360:t}function Ke(e){let t=e/1236.85,n=t*t,r=n*t,i=r*t,a=Ue+He*e;a+=1337e-7*n-15e-8*r+73e-11*i;let o=We(Ge(2.5534+29.1053567*e-14e-7*n-11e-8*r)),s=We(Ge(201.5643+385.81693528*e+.0107582*n+1238e-8*r-58e-9*i)),c=We(Ge(160.7108+390.67050284*e-.0016118*n-227e-8*r+11e-9*i)),l=We(Ge(124.7746-1.5637558*e+.0020691*n+215e-8*r)),u=1-.002516*t-74e-7*n,d=-.4072*Math.sin(s)+.17241*u*Math.sin(o)+.01608*Math.sin(2*s)+.01039*Math.sin(2*c)+.00739*u*Math.sin(s-o)-.00514*u*Math.sin(s+o)+.00208*u*u*Math.sin(2*o)-.00111*Math.sin(s-2*c)-57e-5*Math.sin(s+2*c)+56e-5*u*Math.sin(2*s+o)-42e-5*Math.sin(3*s)+42e-5*u*Math.sin(o+2*c)+38e-5*u*Math.sin(o-2*c)-24e-5*u*Math.sin(2*s-o)-17e-5*Math.sin(l)-7e-5*Math.sin(s+2*o)+4e-5*Math.sin(2*s-2*c)+4e-5*Math.sin(3*o)+3e-5*Math.sin(s+o-2*c)+3e-5*Math.sin(2*s+2*c)-3e-5*Math.sin(s+o+2*c)+3e-5*Math.sin(s-o+2*c)-2e-5*Math.sin(s-o-2*c)-2e-5*Math.sin(3*s+o)+2e-5*Math.sin(4*s),f=We(Ge(299.77+.107408*e-.009173*n)),p=We(Ge(251.88+.016321*e)),m=We(Ge(251.83+26.651886*e)),h=We(Ge(349.42+36.412478*e)),g=We(Ge(84.66+18.206239*e)),_=We(Ge(141.74+53.303771*e)),v=We(Ge(207.14+2.453732*e)),y=We(Ge(154.84+7.30686*e)),b=We(Ge(34.52+27.261239*e)),x=We(Ge(207.19+.121824*e)),S=We(Ge(291.34+1.844379*e)),C=We(Ge(161.72+24.198154*e)),w=We(Ge(239.56+25.513099*e)),T=We(Ge(331.55+3.592518*e)),E=325e-6*Math.sin(f)+165e-6*Math.sin(p)+164e-6*Math.sin(m)+126e-6*Math.sin(h)+11e-5*Math.sin(g)+62e-6*Math.sin(_)+6e-5*Math.sin(v)+56e-6*Math.sin(y)+47e-6*Math.sin(b)+42e-6*Math.sin(x)+4e-5*Math.sin(S)+37e-6*Math.sin(C)+35e-6*Math.sin(w)+23e-6*Math.sin(T);return a+d+E}function qe(e){return Math.floor((e-Ue)/He)}function Je(e){let t=qe(e),n=Ke(t);return n<e&&(t+=1,n=Ke(t)),{k:t,jde:n}}function Ye(e,t,n){let r=Fe(e-1,270,n),i=Ke(Je(re(r)).k+1),a=Math.round(ie(i)),o=a+t*6e4,s=new Date(o),c=s.getUTCFullYear(),l=s.getUTCMonth()+1,u=s.getUTCDate(),d=Date.UTC(c,l-1,u,0,0,0)-t*6e4;return{localYear:e,offsetMinutes:t,method:n,winterSolsticeUtcMs:r,newMoonUtcMs:a,localDate:{y:c,m:l,d:u},boundaryUtcMs:d,algorithm:`secondNewMoonAfterWinterSolstice`}}function Xe(e,t){let n=Date.UTC(e.y,e.m-1,e.d+t),r=new Date(n);return{y:r.getUTCFullYear(),m:r.getUTCMonth()+1,d:r.getUTCDate()}}function Ze(e,t){return t===`midnight`?e.date:t===`ziSplit23`&&e.time.h===23?Xe(e.date,1):e.date}function Qe(e){return ee(M(ne(e)+49,60))}function $e(e,t,n){let r=t.h,i=r===23?0:Math.floor((r+1)/2);return G(M(M(e,5)*2+i,10),i)}function et(e,t){let n=null;for(let r of t)if(r.utcMs<=e)n=r;else break;return n?je(n.id)??10:10}function tt(e,t,n,r,i,a){let o=e;if(r===`liChun`){if(n==null)throw Error(`liChunUtcMs is required when yearBoundary=liChun`);t<n&&--o}return r===`lunarNewYear`&&t<Ye(e,i,a).boundaryUtcMs&&--o,G(M(o-4,10),M(o-4,12))}function nt(e,t){return G(M(M(M(e,5)*2+2,10)+t,10),M(2+t,12))}function rt(e){return M(e+10,12)}function it(e){return e.terms.find(t=>t.year===e.baseYear&&t.id===`LICHUN`)?.utcMs??null}function at(e,t,n,r){if(n===`gregorianMonth`)return rt(t.date.m);if(!r)throw Error(`jieBoundariesAround is required when monthBoundary=jieqi (approx fallback removed)`);return et(e,r.terms)}var ot=864e5;function st(e){let t=new Date(e),n=t.getUTCFullYear(),r=Date.UTC(n,t.getUTCMonth(),t.getUTCDate()),i=Date.UTC(n,0,1),a=Math.floor((r-i)/ot)+1,o=t.getUTCHours()+t.getUTCMinutes()/60+t.getUTCSeconds()/3600+t.getUTCMilliseconds()/36e5,s=2*Math.PI/365*(a-1+(o-12)/24);return 229.18*(75e-6+.001868*Math.cos(s)-.032077*Math.sin(s)-.014615*Math.cos(2*s)-.040849*Math.sin(2*s))}function ct(e,t){return 4*(t-e/60*15)}function lt(e){let{utcMs:t,offsetMinutes:n,location:r,policy:i}=e;if(!i?.enabled)return{enabled:!1,applied:!1,method:`none`,totalCorrectionMinutes:0,reason:`disabled`,formula:`Δ = 0 (trueSolarTime.disabled)`};let a=r?.lon;if(typeof a!=`number`||!Number.isFinite(a))return{enabled:!0,applied:!1,method:`none`,totalCorrectionMinutes:0,reason:`location.lon missing`,formula:`Δ = 0 (no longitude)`};let o=n/60*15,s=ct(n,a),c=i.equationOfTime===`approx`?st(t):0,l=s+c;return{enabled:!0,applied:!0,method:i.equationOfTime===`approx`?`approx`:`none`,longitudeDeg:a,standardMeridianDeg:o,longitudeCorrectionMinutes:s,equationOfTimeMinutes:c,totalCorrectionMinutes:l,formula:`T_solar = T_civil + 4*(lon-stdMeridian) + EoT`}}function ut(e,t){let n=e.time.h*60+e.time.min+t,r=Math.floor(n/1440),i=n-r*1440,a=Math.floor(i/60),o=Math.floor(i-a*60);return{date:Xe(e.date,r),time:{h:a,min:o},offsetMinutes:e.offsetMinutes}}var dt=Object.fromEntries([`CHUNG`,`YUKHAP`,`HYEONG`,`JA_HYEONG`,`SAMHYEONG`,`HAE`,`PA`,`WONJIN`,`SAMHAP`,`BANGHAP`].map((e,t)=>[e,t]));function ft(e,t){let n=dt[e.type]??999,r=dt[t.type]??999;if(n!==r)return n-r;let i=e.members.length,a=t.members.length;if(i!==a)return i-a;for(let n=0;n<Math.min(i,a);n++){let r=e.members[n]??0,i=t.members[n]??0;if(r!==i)return r-i}return 0}function pt(e){return M(e+6,12)}function mt(e){return M(1-e,12)}function ht(e){return M(7-e,12)}function gt(e){return W(e)===`YANG`?M(e+9,12):M(e+3,12)}function _t(e){return W(e)===`YANG`?M(e+7,12):M(e+5,12)}function vt(e,t){let n=Math.min(M(e,12),M(t,12)),r=Math.max(M(e,12),M(t,12));return n===2&&r===5||n===2&&r===8||n===5&&r===8||n===1&&r===7||n===1&&r===10||n===7&&r===10||n===0&&r===3}function yt(e){let t=M(e,12);return t===4||t===6||t===9||t===11}function bt(e){let t=M(e,12);return[t,M(t+4,12),M(t+8,12)].sort((e,t)=>e-t)}function xt(e){let t=M(e-2,12),n=2+3*Math.floor(t/3);return[M(n,12),M(n+1,12),M(n+2,12)].sort((e,t)=>e-t)}function St(e,t){let n=new Set,r=[];for(let i of e){let e=t(i);n.has(e)||(n.add(e),r.push(i))}return r}function Ct(e,t){return`${Math.min(e,t)}-${Math.max(e,t)}`}function wt(e){return[...e].sort((e,t)=>e-t).join(`-`)}function Tt(e){let t=e.map(e=>M(e,12)),n=[];for(let e=0;e<t.length;e++)for(let r=e+1;r<t.length;r++){let i=t[e],a=t[r];pt(i)===a&&n.push({type:`CHUNG`,members:[i,a].sort((e,t)=>e-t)}),mt(i)===a&&n.push({type:`YUKHAP`,members:[i,a].sort((e,t)=>e-t)}),ht(i)===a&&n.push({type:`HAE`,members:[i,a].sort((e,t)=>e-t)}),gt(i)===a&&n.push({type:`PA`,members:[i,a].sort((e,t)=>e-t)}),_t(i)===a&&n.push({type:`WONJIN`,members:[i,a].sort((e,t)=>e-t)}),i===a&&yt(i)&&n.push({type:`JA_HYEONG`,members:[i,a]}),i!==a&&vt(i,a)&&n.push({type:`HYEONG`,members:[i,a].sort((e,t)=>e-t)})}let r=St(n.filter(e=>e.members.length===2),e=>`${e.type}:${Ct(e.members[0],e.members[1])}`),i=new Set(t),a=[];for(let e of t){let t=bt(e);t.every(e=>i.has(e))&&a.push({type:`SAMHAP`,members:t});let n=xt(e);n.every(e=>i.has(e))&&a.push({type:`BANGHAP`,members:n})}for(let e of[[2,5,8],[1,7,10]])e.every(e=>i.has(e))&&a.push({type:`SAMHYEONG`,members:[...e].sort((e,t)=>e-t)});let o=St(a,e=>`${e.type}:${wt(e.members)}`);return[...r,...o].sort(ft)}const X=[`WOOD`,`FIRE`,`EARTH`,`METAL`,`WATER`];function Et(){return{WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0}}function Dt(e){return{WOOD:e.WOOD,FIRE:e.FIRE,EARTH:e.EARTH,METAL:e.METAL,WATER:e.WATER}}function Ot(e,t,n){return e[t]+=n,e}function kt(e,t){return{WOOD:e.WOOD+t.WOOD,FIRE:e.FIRE+t.FIRE,EARTH:e.EARTH+t.EARTH,METAL:e.METAL+t.METAL,WATER:e.WATER+t.WATER}}var At=`MAIN`,jt=`MIDDLE`,Mt=`RESIDUAL`,Nt=(e,t)=>({stem:e,role:t});const Pt=[[Nt(9,At)],[Nt(5,At),Nt(9,jt),Nt(7,Mt)],[Nt(0,At),Nt(2,jt),Nt(4,Mt)],[Nt(1,At)],[Nt(4,At),Nt(1,jt),Nt(9,Mt)],[Nt(2,At),Nt(6,jt),Nt(4,Mt)],[Nt(3,At),Nt(5,Mt)],[Nt(5,At),Nt(3,jt),Nt(1,Mt)],[Nt(6,At),Nt(8,jt),Nt(4,Mt)],[Nt(7,At)],[Nt(4,At),Nt(7,jt),Nt(3,Mt)],[Nt(8,At),Nt(0,Mt)]];function Ft(e,t,n){return e<=0?[]:t===`equal`?Array.from({length:e},()=>1/e):e===1?[n?.one??1]:e===2?[n?.two?.main??.7,n?.two?.residual??.3]:[n?.three?.main??.6,n?.three?.middle??.3,n?.three?.residual??.1]}function It(e){let t=e.reduce((e,t)=>e+(Number.isFinite(t)?t:0),0);return t<=0?e.map(()=>0):e.map(e=>e/t)}function Lt(e,t={scheme:`standard`}){let n=Pt[M(e,12)]??[],r=It(Ft(n.length,t.scheme??`standard`,t.standard));return n.map((e,t)=>({...e,weight:r[t]??0}))}const Rt={heavenStemWeight:1,branchTotalWeight:1};function zt(e,t={}){let n=t.heavenStemWeight??Rt.heavenStemWeight,r=t.branchTotalWeight??Rt.branchTotalWeight,i=t.hiddenStemWeights??{scheme:`standard`},a=Et(),o=Et();for(let t of e){Ot(a,V(t.stem),n);for(let e of Lt(t.branch,i))Ot(o,V(e.stem),r*e.weight)}return{heaven:a,hidden:o,total:kt(Dt(a),o)}}const Bt=[`JANG_SAENG`,`MOK_YOK`,`GWAN_DAE`,`GEON_ROK`,`JE_WANG`,`SWOE`,`BYEONG`,`SA`,`MYO`,`JEOL`,`TAE`,`YANG`];var Vt=[11,6,2,9,2,9,5,0,8,3],Ht=[11,6,2,9,8,3,5,0,8,3];function Ut(e,t){let n=M(e,10);return t.earthRule===`FOLLOW_WATER`?Ht[n]??0:Vt[n]??0}function Wt(e,t,n){let r=Ut(e,n),i=M(t,12),a;return a=n.yinReversalEnabled&&U(e)===`YIN`?M(r-i,12):M(i-r,12),{stage:Bt[a],index:a,startBranch:r}}var Gt=Object.fromEntries([`HAP`,`CHUNG`].map((e,t)=>[e,t]));function Kt(e,t){let n=Gt[e.type]??999,r=Gt[t.type]??999;if(n!==r)return n-r;let[i,a]=e.members,[o,s]=t.members;return i===o?a===s?0:a-s:i-o}function qt(e){return M(e+5,10)}function Jt(e,t){let n=Math.min(M(e,10),M(t,10)),r=Math.max(M(e,10),M(t,10));if(n===0&&r===5)return`EARTH`;if(n===1&&r===6)return`METAL`;if(n===2&&r===7)return`WATER`;if(n===3&&r===8)return`WOOD`;if(n===4&&r===9)return`FIRE`}function Yt(e,t){let n=Math.min(M(e,10),M(t,10)),r=Math.max(M(e,10),M(t,10));return n===0&&r===6||n===1&&r===7||n===2&&r===8||n===3&&r===9}function Xt(e,t){let n=new Set,r=[];for(let i of e){let e=t(i);n.has(e)||(n.add(e),r.push(i))}return r}function Zt(e){let t=e.map(e=>M(e,10)),n=[];for(let e=0;e<t.length;e++)for(let r=e+1;r<t.length;r++){let i=t[e],a=t[r];qt(i)===a&&n.push({type:`HAP`,members:[Math.min(i,a),Math.max(i,a)],resultElement:Jt(i,a)}),Yt(i,a)&&n.push({type:`CHUNG`,members:[Math.min(i,a),Math.max(i,a)]})}return Xt(n,e=>`${e.type}:${e.members[0]}-${e.members[1]}`).sort(Kt)}const Qt={WOOD:`FIRE`,FIRE:`EARTH`,EARTH:`METAL`,METAL:`WATER`,WATER:`WOOD`},$t={WOOD:`EARTH`,EARTH:`WATER`,WATER:`FIRE`,FIRE:`METAL`,METAL:`WOOD`};function en(e,t){return Qt[e]===t}function tn(e,t){return $t[e]===t}function nn(e,t){return e===t}function rn(e,t){let n=V(e),r=V(t),i=U(e)===U(t);return nn(n,r)?i?`BI_GYEON`:`GEOB_JAE`:en(n,r)?i?`SIK_SHIN`:`SANG_GWAN`:en(r,n)?i?`PYEON_IN`:`JEONG_IN`:tn(n,r)?i?`PYEON_JAE`:`JEONG_JAE`:tn(r,n)?i?`PYEON_GWAN`:`JEONG_GWAN`:i?`BI_GYEON`:`GEOB_JAE`}const an={stemWeight:1,branchWeight:1,hiddenStemWeights:{scheme:`standard`},includeBranchYinYang:!1};function on(){return{WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0}}function sn(){return{YANG:0,YIN:0}}function cn(){return{BI_GYEON:0,GEOB_JAE:0,SIK_SHIN:0,SANG_GWAN:0,PYEON_JAE:0,JEONG_JAE:0,PYEON_GWAN:0,JEONG_GWAN:0,PYEON_IN:0,JEONG_IN:0}}function ln(e,t,n){return Lt(t,n).map(t=>({...t,tenGod:rn(e,t.stem)}))}function un(e,t){let n={...an,...t},r=e.day.stem,i=on(),a=sn(),o=cn(),s=[e.year.stem,e.month.stem,e.day.stem,e.hour.stem],c=[e.year.branch,e.month.branch,e.day.branch,e.hour.branch];for(let e of s)i[V(e)]+=n.stemWeight,a[U(e)]+=n.stemWeight,o[rn(r,e)]+=n.stemWeight;let l={year:ln(r,e.year.branch,n.hiddenStemWeights),month:ln(r,e.month.branch,n.hiddenStemWeights),day:ln(r,e.day.branch,n.hiddenStemWeights),hour:ln(r,e.hour.branch,n.hiddenStemWeights)};for(let e of[`year`,`month`,`day`,`hour`])for(let t of l[e]){let e=n.branchWeight*t.weight;i[V(t.stem)]+=e,a[U(t.stem)]+=e,o[t.tenGod]+=e}if(n.includeBranchYinYang)for(let e of c)a[W(e)]+=n.branchWeight;return{elements:i,yinYang:a,tenGods:o,hiddenStems:l}}var dn={directionRule:`sex_yearStemYinYang`,startBoundary:`jie`,startAgeMethod:`threeDaysOneYear`,firstDecadeOffsetSteps:1,decadeLengthYears:10,maxDecades:10,maxYears:120,maxMonths:24,maxDays:0,axis:`ageOnly`};function fn(e,t){return typeof e==`number`&&Number.isFinite(e)?e:t}function pn(e,t){if(e===`threeDaysOneYear`||e===`oneDayFourMonths`)return e;if(e&&typeof e==`object`&&!Array.isArray(e)){let t=e;if(t.kind===`ratioDaysPerYear`){let e=fn(t.daysPerYear,NaN);if(Number.isFinite(e)&&e>0)return{kind:`ratioDaysPerYear`,daysPerYear:e,label:typeof t.label==`string`?t.label:void 0}}if(t.kind===`ratioMsPerYear`){let e=fn(t.msPerYear,NaN);if(Number.isFinite(e)&&e>0)return{kind:`ratioMsPerYear`,msPerYear:e,label:typeof t.label==`string`?t.label:void 0}}}return t}function mn(e){let t=e.strategies?.fortune??{},n=t.directionRule===`fixedForward`||t.directionRule===`fixedBackward`||t.directionRule===`sex_yearStemYinYang`?t.directionRule:dn.directionRule,r=t.axis===`utcByGregorianYear`||t.axis===`ageOnly`?t.axis:dn.axis,i=Math.max(0,Math.floor(fn(t.maxDecades,dn.maxDecades))),a=Math.max(0,Math.floor(fn(t.maxYears,dn.maxYears))),o=Math.max(0,Math.floor(fn(t.maxMonths,dn.maxMonths))),s=Math.max(0,Math.floor(fn(t.maxDays,dn.maxDays))),c=Math.max(1,Math.floor(fn(t.decadeLengthYears,dn.decadeLengthYears))),l=Math.floor(fn(t.firstDecadeOffsetSteps,dn.firstDecadeOffsetSteps)),u=pn(t.startAgeMethod??t.startAge,dn.startAgeMethod);return{...dn,directionRule:n,axis:r,maxDecades:i,maxYears:a,maxMonths:o,maxDays:s,decadeLengthYears:c,firstDecadeOffsetSteps:l,startAgeMethod:u}}var hn=864e5,gn=365.2425;function _n(e,t){return{stem:M(e.stem+t,10),branch:M(e.branch+t,12)}}function vn(e){return e===`FORWARD`?1:-1}function yn(e,t,n){if(n===`fixedForward`)return`FORWARD`;if(n===`fixedBackward`)return`BACKWARD`;if(e!==`M`&&e!==`F`)return`FORWARD`;let r=U(t);return(e===`M`?1:-1)*(r===`YANG`?1:-1)>=0?`FORWARD`:`BACKWARD`}function bn(e,t){let n=null,r=null;for(let i of t.terms){let t=i.id;if(i.utcMs<=e)n={id:t,utcMs:i.utcMs};else{r={id:t,utcMs:i.utcMs};break}}return{prev:n,next:r}}function xn(e,t){let n=e/hn,r=e=>{let t=Math.max(0,Math.floor(e)),n=Math.max(0,e-t),r=Math.max(0,Math.floor(n*12)),i=Math.max(0,n*12-r);return{years:t,months:r,days:Math.max(0,Math.round(i*30))}},i=(e,t)=>{let i=n/e;return{years:i,formula:`startAgeYears = (Δdays / ${e})  // ${t}`,parts:r(i)}};if(t===`threeDaysOneYear`)return{...i(3,`三日一歲`),formula:`startAgeYears = (Δdays / 3)  // 三日一歲`};if(t===`oneDayFourMonths`)return i(3,`一日四月 ≡ 三日一歲`);if(typeof t==`object`&&t&&!Array.isArray(t)){let n=t;if(n.kind===`ratioDaysPerYear`){let e=n.daysPerYear;if(typeof e==`number`&&Number.isFinite(e)&&e>0)return i(e,n.label??`ratioDaysPerYear(${e})`)}if(n.kind===`ratioMsPerYear`){let t=n.msPerYear;if(typeof t==`number`&&Number.isFinite(t)&&t>0){let i=e/t;return{years:i,formula:`startAgeYears = (Δms / ${t})  // ${n.label??`ratioMsPerYear(${t})`}`,parts:r(i)}}}}return i(3,`三日一歲(fallback)`)}function Sn(e,t,n){return Date.UTC(e.y,e.m-1,e.d,t.h,t.min,0)-n*6e4}function Cn(e,t,n){return t===`ziSplit23`?{startUtcMs:Sn(Xe(e,-1),{h:23,min:0},n),endUtcMs:Sn(e,{h:23,min:0},n)}:{startUtcMs:Sn(e,{h:0,min:0},n),endUtcMs:Sn(Xe(e,1),{h:0,min:0},n)}}function wn(e,t){let n=new Date(e);return n.setUTCFullYear(n.getUTCFullYear()+t),n.getTime()}function Tn(e){return G(M(e-4,10),M(e-4,12))}function En(e,t){return(t-e)/(hn*gn)}function Dn(e){let{request:t,parsedUtcMs:n,birthLocalDateTime:r,localYear:i,solarTermMethod:a,jieBoundariesAround:o,natalYearPillar:s,natalMonthPillar:c,policy:l,calendar:u}=e;if(!o)return{policy:l,start:{direction:yn(t.sex,s.stem,l.directionRule),boundary:{id:`LICHUN`,utcMs:n},deltaMs:0,startAgeYears:0,startUtcMsApprox:n,formula:`startAgeYears = 0 (no solar-term boundaries available)`},decades:[],years:[]};let d=yn(t.sex,s.stem,l.directionRule),{prev:f,next:p}=bn(n,o),m=d===`FORWARD`?p??f:f??p;if(!m)throw Error(`Invariant: unable to find any jie boundary`);let h=Math.abs(m.utcMs-n),{years:g,formula:_,parts:v}=xn(h,l.startAgeMethod),y=Math.round(n+hn*gn*g),b={direction:d,boundary:{id:m.id,utcMs:m.utcMs},deltaMs:h,startAgeYears:g,startAgeParts:v,startUtcMsApprox:y,formula:_},x=[],S=vn(d),C=l.decadeLengthYears,w=l.firstDecadeOffsetSteps;for(let e=0;e<l.maxDecades;e++){let t=_n(c,S*(w+e)),n=g+e*C,r=n+C,i={kind:`DECADE`,index:e,startAgeYears:n,endAgeYears:r,pillar:t};l.axis===`utcByGregorianYear`&&(i.startUtcMs=wn(y,e*C),i.endUtcMs=wn(y,(e+1)*C)),x.push(i)}let T=Ve(i,a),E=u.yearBoundary===`liChun`&&n<T?i-1:i,D=[];for(let e=0;e<l.maxYears;e++){let t=E+e,r=Ve(t,a),i=Ve(t+1,a);D.push({kind:`YEAR`,solarYear:t,pillar:Tn(t),startUtcMs:r,endUtcMs:i,approxStartAgeYears:En(n,r),approxEndAgeYears:En(n,i)})}let O;if(l.maxMonths>0){let e=Math.ceil(l.maxMonths/12)+2,t=[];for(let n=E;n<=E+e;n++)t.push(...ze(n,a));t.sort((e,t)=>e.utcMs-t.utcMs);let r=t.findIndex(e=>e.year===E&&e.id===`LICHUN`);if(r>=0){O=[];let e=E;for(let i=0;i<l.maxMonths;i++){let a=t[r+i],o=t[r+i+1];if(!a||!o)break;i>0&&a.id===`LICHUN`&&(e+=1);let s=je(a.id),c=Tn(e).stem,l=nt(c,s);O.push({kind:`MONTH`,solarYear:e,monthOrder:s,startJie:a.id,pillar:l,startUtcMs:a.utcMs,endUtcMs:o.utcMs,approxStartAgeYears:En(n,a.utcMs),approxEndAgeYears:En(n,o.utcMs)})}}}let k;if(l.maxDays>0){let e=Ze(r,u.dayBoundary);k=[];for(let t=0;t<l.maxDays;t++){let i=Xe(e,t),a=Qe(i),{startUtcMs:o,endUtcMs:s}=Cn(i,u.dayBoundary,r.offsetMinutes);k.push({kind:`DAY`,localDate:{y:i.y,m:i.m,d:i.d},pillar:a,startUtcMs:o,endUtcMs:s,approxStartAgeYears:En(n,o),approxEndAgeYears:En(n,s)})}}return{policy:l,start:b,decades:x,years:D,months:O,days:k}}function On(e,t){return{meta:{...e.meta,...t.meta},dayStem:{...e.dayStem??{},...t.dayStem??{}},monthBranchStem:{...e.monthBranchStem??{},...t.monthBranchStem??{}},monthBranchBranch:{...e.monthBranchBranch??{},...t.monthBranchBranch??{}},dayPillar:{...e.dayPillar??{},...t.dayPillar??{}}}}function kn(e){if(typeof e!=`string`)return null;let t=e.trim();if(t.length<2)return null;let n=t[0],r=t[1],i=q(n),a=J(r);return i==null||a==null?null:G(i,a)}function An(e){let t=Array.from({length:10},()=>[]),n=e?.branches??{};for(let[e,r]of Object.entries(n)){let n=q(e);if(n==null)continue;let i=[];for(let e of r??[]){let t=J(String(e));t!=null&&i.push(t)}t[n]=Array.from(new Set(i.map(e=>M(e,12))))}return{byStem:t,description:e?.description}}function jn(e){let t=Array.from({length:12},()=>[]),n=e?.stems??{};for(let[e,r]of Object.entries(n)){let n=J(e);if(n==null)continue;let i=[];for(let e of r??[]){let t=q(String(e));t!=null&&i.push(t)}t[n]=Array.from(new Set(i.map(e=>M(e,10))))}return{byBranch:t,description:e?.description}}function Mn(e){let t=Array.from({length:12},()=>[]),n=e?.branches??{};for(let[e,r]of Object.entries(n)){let n=J(e);if(n==null)continue;let i=[];for(let e of r??[]){let t=J(String(e));t!=null&&i.push(t)}t[n]=Array.from(new Set(i.map(e=>M(e,12))))}return{byBranch:t,description:e?.description}}function Nn(e){let t=new Set,n=new Set;for(let n of e?.primary??[]){let e=kn(n);if(!e)continue;let r=K(e);r!=null&&t.add(M(r,60))}for(let t of e?.extended??[]){let e=kn(t);if(!e)continue;let r=K(e);r!=null&&n.add(M(r,60))}return{primary:t,extended:n,requiresDayPillar:e?.requiresDayPillar??!0,description:e?.description}}function Pn(e){let t={id:e?.meta?.id??`shinsal.catalog.unknown`,version:e?.meta?.version??`0`,description:e?.meta?.description},n={};for(let[t,r]of Object.entries(e?.dayStem??{}))n[t]=An(r);let r={};for(let[t,n]of Object.entries(e?.monthBranchStem??{}))r[t]=jn(n);let i={};for(let[t,n]of Object.entries(e?.monthBranchBranch??{}))i[t]=Mn(n);let a={};for(let[t,n]of Object.entries(e?.dayPillar??{}))a[t]=Nn(n);return{meta:t,dayStem:n,monthBranchStem:r,monthBranchBranch:i,dayPillar:a}}const Fn={meta:{id:`shinsal.catalog.base`,version:`0.4`,description:`Baseline shinsal catalog (천을/태극/문창/문곡/양인/비인 + 록신/국인 + 천관/천복 + 천주/복성/금여/홍염 + 월덕/월덕합/천덕 + day-pillar sets: 괴강/백호).`},dayStem:{CHEON_EUL_GUI_IN:{branches:{甲:[`丑`,`未`],乙:[`子`,`申`],丙:[`亥`,`酉`],丁:[`亥`,`酉`],戊:[`丑`,`未`],己:[`子`,`申`],庚:[`丑`,`未`],辛:[`寅`,`午`],壬:[`巳`,`卯`],癸:[`巳`,`卯`]}},TAE_GEUK_GUI_IN:{branches:{甲:[`子`,`午`],乙:[`子`,`午`],丙:[`卯`,`酉`],丁:[`卯`,`酉`],戊:[`辰`,`戌`,`丑`,`未`],己:[`辰`,`戌`,`丑`,`未`],庚:[`寅`,`亥`],辛:[`寅`,`亥`],壬:[`巳`,`申`],癸:[`巳`,`申`]}},MUN_CHANG_GUI_IN:{branches:{甲:[`巳`],乙:[`午`],丙:[`申`],丁:[`酉`],戊:[`申`],己:[`酉`],庚:[`亥`],辛:[`子`],壬:[`寅`],癸:[`卯`]}},MUN_GOK_GUI_IN:{branches:{甲:[`亥`],乙:[`子`],丙:[`寅`],丁:[`卯`],戊:[`寅`],己:[`卯`],庚:[`巳`],辛:[`午`],壬:[`申`],癸:[`酉`]}},LOK_SHIN:{branches:{甲:[`寅`],乙:[`卯`],丙:[`巳`],丁:[`午`],戊:[`巳`],己:[`午`],庚:[`申`],辛:[`酉`],壬:[`亥`],癸:[`子`]}},GUK_IN_GUI_IN:{branches:{甲:[`戌`],乙:[`亥`],丙:[`丑`],丁:[`寅`],戊:[`丑`],己:[`寅`],庚:[`辰`],辛:[`巳`],壬:[`未`],癸:[`申`]}},CHEON_JU_GUI_IN:{branches:{甲:[`巳`],乙:[`午`],丙:[`巳`],丁:[`午`],戊:[`申`],己:[`酉`],庚:[`亥`],辛:[`子`],壬:[`寅`],癸:[`卯`]}},CHEON_GWAN_GUI_IN:{branches:{甲:[`未`],乙:[`辰`],丙:[`巳`],丁:[`寅`],戊:[`丑`],己:[`戌`],庚:[`亥`],辛:[`申`],壬:[`酉`],癸:[`午`]}},CHEON_BOK_GUI_IN:{branches:{甲:[`酉`],乙:[`申`],丙:[`子`],丁:[`亥`],戊:[`卯`],己:[`寅`],庚:[`午`],辛:[`巳`],壬:[`午`],癸:[`巳`]}},BOK_SEONG_GUI_IN:{branches:{甲:[`寅`,`子`],乙:[`卯`,`丑`],丙:[`寅`,`子`],丁:[`亥`],戊:[`申`],己:[`未`],庚:[`午`],辛:[`巳`],壬:[`辰`],癸:[`卯`,`丑`]}},GEUM_YEO_GUI_IN:{branches:{甲:[`辰`],乙:[`巳`],丙:[`未`],丁:[`申`],戊:[`未`],己:[`申`],庚:[`戌`],辛:[`亥`],壬:[`丑`],癸:[`寅`]}},HONG_YEOM_SAL:{branches:{甲:[`午`],乙:[`申`],丙:[`寅`],丁:[`未`],戊:[`辰`],己:[`辰`],庚:[`戌`],辛:[`酉`],壬:[`子`],癸:[`申`]}}},monthBranchStem:{WOL_DEOK_GUI_IN:{stems:{寅:[`丙`],卯:[`甲`],辰:[`壬`],巳:[`庚`],午:[`丙`],未:[`甲`],申:[`壬`],酉:[`庚`],戌:[`丙`],亥:[`甲`],子:[`壬`],丑:[`庚`]}},WOL_DEOK_HAP:{stems:{寅:[`辛`],卯:[`己`],辰:[`丁`],巳:[`乙`],午:[`辛`],未:[`己`],申:[`丁`],酉:[`乙`],戌:[`辛`],亥:[`己`],子:[`丁`],丑:[`乙`]}},CHEON_DEOK_GUI_IN_STEM:{stems:{寅:[`丁`],辰:[`壬`],巳:[`辛`],未:[`甲`],申:[`癸`],戌:[`丙`],亥:[`乙`],丑:[`庚`]}},CHEON_DEOK_HAP:{stems:{寅:[`壬`],辰:[`丁`],巳:[`丙`],未:[`己`],申:[`戊`],戌:[`辛`],亥:[`庚`],丑:[`乙`]}}},monthBranchBranch:{CHEON_DEOK_GUI_IN_BRANCH:{branches:{卯:[`申`],午:[`亥`],酉:[`寅`],子:[`巳`]}}},dayPillar:{KUI_GANG:{requiresDayPillar:!0,primary:[`庚辰`,`壬辰`,`庚戌`,`戊戌`],extended:[`戊辰`,`壬戌`]},BAEK_HO:{requiresDayPillar:!0,primary:[`甲辰`,`乙未`,`丙戌`,`丁丑`,`戊辰`,`壬戌`,`癸丑`]}}},In=[`CHUNG`,`HYEONG`,`JA_HYEONG`,`SAMHYEONG`,`HAE`,`PA`,`WONJIN`],Ln={envByMonthBranch:[{temp:-.7,moist:.3},{temp:-.6,moist:.2},{temp:-.4,moist:.1},{temp:-.2,moist:.2},{temp:0,moist:.2},{temp:.4,moist:-.1},{temp:.7,moist:-.2},{temp:.5,moist:.1},{temp:.2,moist:-.3},{temp:0,moist:-.5},{temp:-.1,moist:-.4},{temp:-.5,moist:.2}],elementEffect:{WOOD:{temp:.2,moist:.1},FIRE:{temp:.6,moist:-.3},EARTH:{temp:.1,moist:-.2},METAL:{temp:-.2,moist:-.3},WATER:{temp:-.6,moist:.4}},needScale:`none`};function Rn(e,t){return e.temp*t.temp+e.moist*t.moist}function zn(e){return{temp:-e.temp,moist:-e.moist}}function Bn(e){return Math.sqrt(e.temp*e.temp+e.moist*e.moist)}function Vn(e,t){return{temp:e.temp*t,moist:e.moist*t}}function Hn(e,t){if(t===`unit`){let t=Bn(e);return t<=1e-9?{...e}:Vn(e,1/t)}return{...e}}function Un(e,t){let n=(t%12+12)%12;return e.envByMonthBranch[n]??{temp:0,moist:0}}function Wn(e,t){let n=Un(e,t),r=Hn(zn(n),e.needScale),i={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};for(let t of X)i[t]=Rn(e.elementEffect[t],r);return{env:n,need:r,scores:i}}function Gn(e,t){if(!t||typeof t!=`object`)return e;let n={envByMonthBranch:e.envByMonthBranch.map(e=>({...e})),elementEffect:{...e.elementEffect},needScale:t.needScale===`unit`||t.needScale===`none`?t.needScale:e.needScale},r=t.envByMonthBranchHanja??t.envByMonthBranch;if(r&&typeof r==`object`&&!Array.isArray(r))for(let[e,t]of Object.entries(r)){let r=typeof e==`string`?J(e):null;if(r==null||!t||typeof t!=`object`)continue;let i=typeof t.temp==`number`?t.temp:n.envByMonthBranch[r].temp,a=typeof t.moist==`number`?t.moist:n.envByMonthBranch[r].moist;n.envByMonthBranch[r]={temp:i,moist:a}}let i=t.envByMonthBranchIndex;if(i&&typeof i==`object`&&!Array.isArray(i))for(let[e,t]of Object.entries(i)){let r=Number(e);if(!Number.isFinite(r))continue;let i=(r%12+12)%12;if(!t||typeof t!=`object`)continue;let a=typeof t.temp==`number`?t.temp:n.envByMonthBranch[i].temp,o=typeof t.moist==`number`?t.moist:n.envByMonthBranch[i].moist;n.envByMonthBranch[i]={temp:a,moist:o}}let a=t.elementEffect;if(a&&typeof a==`object`&&!Array.isArray(a))for(let e of X){let t=a[e];if(!t||typeof t!=`object`)continue;let r=typeof t.temp==`number`?t.temp:n.elementEffect[e].temp,i=typeof t.moist==`number`?t.moist:n.elementEffect[e].moist;n.elementEffect[e]={temp:r,moist:i}}return n}function Kn(e){let t=M(e,12);return t===2||t===3||t===4?`SPRING`:t===5||t===6||t===7?`SUMMER`:t===8||t===9||t===10?`AUTUMN`:`WINTER`}var qn={甲:[`庚`],乙:[`癸`],丙:[`壬`],丁:[`甲`],戊:[`甲`],己:[`丙`],庚:[`丁`],辛:[`壬`],壬:[`戊`],癸:[`辛`]};function Jn(e,t){return typeof e==`number`&&Number.isFinite(e)?e:t}function Yn(e){let t=e.strategies?.yongshin?.johooTemplate??e.strategies?.johooTemplate??{};return{enabled:t?.enabled===!0,seasonMandatoryBoost:Jn(t?.seasonMandatoryBoost,.35),stemPreferenceBoost:Jn(t?.stemPreferenceBoost,.25),enforceSummerWinter:t?.enforceSummerWinter!==!1,stemPreferencesOverride:t?.stemPreferencesOverride&&typeof t?.stemPreferencesOverride==`object`?t.stemPreferencesOverride:void 0}}function Xn(e){let t={...qn},n=e.stemPreferencesOverride;if(!n)return t;for(let[e,r]of Object.entries(n)){if(!Array.isArray(r))continue;let n=r.map(e=>typeof e==`string`?e.trim():``).filter(Boolean);n.length!==0&&(t[e]=n)}return t}function Zn(e){return e===`WINTER`?[`FIRE`]:e===`SUMMER`?[`WATER`]:[]}function Qn(e,t){let n=Yn(e);if(!n.enabled)return null;let r=Kn(t.monthBranch),i=z(t.dayStem),a=B(t.monthBranch),o=[...Xn(n)[i]??[]],s=o.map(e=>q(e)).filter(e=>typeof e==`number`),c=s.map(e=>V(e)),l=Zn(r),u={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0},d=[];for(let e of l)u[e]+=n.seasonMandatoryBoost;l.length>0&&d.push(`seasonMandatory:${r}`);for(let e of s){let t=V(e);u[t]+=n.stemPreferenceBoost}if(s.length>0&&d.push(`stemPreference:${i}`),n.enforceSummerWinter){let e=r===`WINTER`?`丙`:r===`SUMMER`?`癸`:null;if(e){let t=q(e);typeof t==`number`&&s.indexOf(t)===-1&&(o.push(e),s.push(t),c.push(V(t)),u[V(t)]+=n.stemPreferenceBoost,d.push(`seasonStemHelper:${r}:${e}`))}}let f={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};for(let e of X)f[e]=(t.climateScores[e]??0)+(u[e]??0);let p=[...X].map(e=>({element:e,score:f[e]})).sort((e,t)=>t.score-e.score);return{enabled:!0,seasonGroup:r,dayStem:t.dayStem,monthBranch:t.monthBranch,dayStemHanja:i,monthBranchHanja:a,preferredStems:s,preferredStemHanja:o,preferredElements:c,mandatoryElements:l,bonus:u,combinedScores:f,ranking:p,primary:p[0]?.element??`WOOD`,secondary:p[1]?.element??p[0]?.element??`WOOD`,reasons:d}}const $n=[`JI_SAL`,`DOHWA`,`WOL_SAL`,`MANG_SHIN_SAL`,`JANGSEONG`,`BAN_AN_SAL`,`YEOKMA`,`YUK_HAE_SAL`,`HUAGAI`,`GEOB_SAL`,`JAESAL`,`CHEON_SAL`];function er(e){return X.reduce((t,n)=>t+e[n],0)}function tr(e){let t=er(e);return t<=0?{normalized:Et(),sum:0}:{normalized:{WOOD:e.WOOD/t,FIRE:e.FIRE/t,EARTH:e.EARTH/t,METAL:e.METAL/t,WATER:e.WATER/t},sum:t}}function nr(e,t){return e===t?`COMPANION`:en(e,t)?`RESOURCE`:en(t,e)?`OUTPUT`:tn(t,e)?`WEALTH`:tn(e,t)?`OFFICER`:`COMPANION`}function rr(e){return Object.entries(e).filter(([,e])=>typeof e==`number`&&Number.isFinite(e)).sort((e,t)=>t[1]-e[1]).map(([e,t])=>({tenGod:e,score:t}))}function ir(e,t){let n=Kn(t),r=e.strategies?.yongshin?.climate??{},{env:i,need:a,scores:o}=Wn(Gn(Ln,r?.model??r),t);return{seasonGroup:n,env:i,need:a,scores:o}}function ar(e,t,n){let r=e[t],i=e[n],a=Math.min(r,i),o=r+i;if(o<=0)return 0;let s=1-Math.abs(r-i)/o;return Math.max(0,Math.min(1,2*a*s))}function or(e){let t={waterFire:{a:`WATER`,b:`FIRE`,bridge:`WOOD`,intensity:ar(e,`WATER`,`FIRE`)},fireMetal:{a:`FIRE`,b:`METAL`,bridge:`EARTH`,intensity:ar(e,`FIRE`,`METAL`)},metalWood:{a:`METAL`,b:`WOOD`,bridge:`WATER`,intensity:ar(e,`METAL`,`WOOD`)},woodEarth:{a:`WOOD`,b:`EARTH`,bridge:`FIRE`,intensity:ar(e,`WOOD`,`EARTH`)},earthWater:{a:`EARTH`,b:`WATER`,bridge:`METAL`,intensity:ar(e,`EARTH`,`WATER`)}},n=Math.max(t.waterFire.intensity,t.fireMetal.intensity,t.metalWood.intensity,t.woodEarth.intensity,t.earthWater.intensity),r=[t.waterFire.intensity,t.fireMetal.intensity,t.metalWood.intensity,t.woodEarth.intensity,t.earthWater.intensity],i=r.reduce((e,t)=>e+t,0),a=i>0?n/i:0,o=(()=>{if(i<=0)return 0;let e=r.map(e=>e<=0?0:e/i),t=e.length,n=Math.log(t);if(n<=0)return 0;let a=0;for(let t of e)t>0&&(a+=-t*Math.log(t));return Math.max(0,Math.min(1,a/n))})(),s=a;return t.waterFire.weightedIntensity=t.waterFire.intensity*s,t.fireMetal.weightedIntensity=t.fireMetal.intensity*s,t.metalWood.weightedIntensity=t.metalWood.intensity*s,t.woodEarth.weightedIntensity=t.woodEarth.intensity*s,t.earthWater.weightedIntensity=t.earthWater.intensity*s,{pairs:t,maxIntensity:n,sumIntensity:i,dominance:a,dispersion:o,effectiveMaxIntensity:n*s}}function Z(e){return Number.isFinite(e)?Math.max(0,Math.min(1,e)):0}function sr(e,t){let n=X.map(e=>({element:e,value:t[e]??0}));n.sort((e,t)=>t.value-e.value);let r=n[0],i=n[1]??{element:r.element,value:0},a=1e-12,o=0;for(let e of n){let t=Math.max(0,e.value);t>a&&(o+=-t*Math.log(t))}let s=o/Math.log(X.length),c=r.value/Math.max(a,i.value),l=e.strategies?.patterns?.elements?.oneElement??e.strategies?.patterns?.oneElement??e.strategies?.oneElement??{},u=l?.enabled!==!1,d=l?.thresholds&&typeof l.thresholds==`object`?l.thresholds:l,f=typeof d.topMin==`number`&&Number.isFinite(d.topMin)?d.topMin:.52,p=typeof d.dominanceRatioMin==`number`&&Number.isFinite(d.dominanceRatioMin)?d.dominanceRatioMin:2.2,m=typeof d.entropyMax==`number`&&Number.isFinite(d.entropyMax)?d.entropyMax:.78,h=u&&r.value>=f&&c>=p&&s<=m,g=Z((r.value-f)/Math.max(a,1-f)),_=Z((c-p)/Math.max(a,p)),v=Z((m-s)/Math.max(a,m)),y=u?Z(g*_*v):0;return{elements:{top:{element:r.element,value:r.value,second:i.value,dominanceRatio:c,entropy:s},oneElement:{enabled:u,isOneElement:h,element:r.element,factor:y,thresholds:{topMin:f,dominanceRatioMin:p,entropyMax:m}}}}}function cr(e,t){let n=t?.patterns?.elements?.oneElement;if(!n||typeof n!=`object`)return;let r=e.strategies?.patterns?.elements?.oneElement??e.strategies?.patterns?.oneElement??e.strategies?.oneElement??{},i=r?.zhuanwang??r?.zhuanWang??r?.zhuan_wang??{};if(i?.enabled!==!0)return;let a=(e,t)=>typeof e==`number`&&Number.isFinite(e)?e:t,o=i?.requireDayMasterMatch!==!1,s=a(i.dayNotMatchPenalty,o?0:.15),c=a(i.lingThreshold,.55),l=a(i.diThreshold,.35),u=a(i.shiThreshold,.25),d=a(i.qualityThreshold,.55),f=a(i.strongThreshold,0),p=a(i.harmThreshold,.18),m=a(i.rootNorm,2.2),h=a(i.shiNorm,1.6),g=a(i.rootResAlpha,.6),_=a(i.shiResAlpha,.7),v=i.branchWeights??{},y={year:a(v.year,.7),month:a(v.month,1.1),day:a(v.day,.9),hour:a(v.hour,.7)},b=i.positionWeights??{},x={year:a(b.year,.6),month:a(b.month,1),hour:a(b.hour,.8)},S=i.weights??{},C={match:a(S.match,.2),ling:a(S.ling,.2),di:a(S.di,.2),shi:a(S.shi,.1),quality:a(S.quality,.2),strong:a(S.strong,.1),noHarm:a(S.noHarm,.1)},w=Object.values(C).reduce((e,t)=>e+t,0),T=w>0?Object.fromEntries(Object.entries(C).map(([e,t])=>[e,t/w])):C,E=i.penalties??{},D={broken:a(E.broken,.25),mixed:a(E.mixed,.1),zhuo:a(E.zhuo,.08)},O=e=>{switch(e){case`WOOD`:return`METAL`;case`FIRE`:return`WATER`;case`EARTH`:return`WOOD`;case`METAL`:return`FIRE`;case`WATER`:return`EARTH`}},k=e=>{let t=0,n=0;for(let r of e){let e=typeof r.w==`number`&&Number.isFinite(r.w)?r.w:0;if(e<=0)continue;let i=Z(typeof r.v==`number`&&Number.isFinite(r.v)?r.v:0);t+=e,n+=e*Math.log(i+1e-12)}return t<=0?0:Z(Math.exp(n/t))},A=typeof n.factor==`number`&&Number.isFinite(n.factor)?Z(n.factor):0,j=n.element??`WOOD`,M=j===(t?.dayMaster?.element??j),N=typeof t?.strength?.index==`number`?t.strength.index:0,P=mr(t?.month?.element??j,j),F=Z((P+1)/2),I=Z((F-c)/Math.max(1e-9,1-c)),L=0,R=0,z=t?.strength?.details?.delingdiShi;if(z&&typeof z==`object`&&M)typeof z?.deDi?.normalized==`number`&&Number.isFinite(z.deDi.normalized)&&(L=Z(z.deDi.normalized)),typeof z?.deShi?.normalized==`number`&&Number.isFinite(z.deShi.normalized)&&(R=Z(z.deShi.normalized));else{let n=e.weights?.hiddenStems??{},r=[{branch:t.chart.pillars.year.branch,w:y.year},{branch:t.chart.pillars.month.branch,w:y.month},{branch:t.chart.pillars.day.branch,w:y.day},{branch:t.chart.pillars.hour.branch,w:y.hour}],i=0,a=0;for(let e of r)for(let t of Lt(e.branch,n??{})){let n=V(t.stem);n===j&&(i+=t.weight*e.w),en(n,j)&&(a+=t.weight*e.w)}L=Z(Math.max(0,i+g*a)/Math.max(1e-9,m));let o=[{stem:t.chart.pillars.year.stem,w:x.year},{stem:t.chart.pillars.month.stem,w:x.month},{stem:t.chart.pillars.hour.stem,w:x.hour}],s=0,c=0;for(let e of o){let t=V(e.stem);t===j&&(s+=e.w),en(t,j)&&(c+=e.w)}R=Z(Math.max(0,s+_*c)/Math.max(1e-9,h))}let B=Z((L-l)/Math.max(1e-9,1-l)),H=Z((R-u)/Math.max(1e-9,1-u)),U=t?.month?.gyeok?.quality??{},W=typeof U.multiplier==`number`&&Number.isFinite(U.multiplier)?Z(U.multiplier):1,G=typeof U.clarity==`number`&&Number.isFinite(U.clarity)?Z(U.clarity):1,ee=typeof U.integrity==`number`&&Number.isFinite(U.integrity)?Z(U.integrity):1,K=U.broken===!0,q=U.mixed===!0,J=U.qingZhuo===`ZHUO`,te=Z((W-d)/Math.max(1e-9,1-d)),Y=O(j),ne=typeof t?.elements?.normalized?.[Y]==`number`?t.elements.normalized[Y]:0,re=p<=0?1:Z((p-ne)/Math.max(1e-9,p)),ie=Z((N-f)/Math.max(1e-9,1-f)),ae=M?1:Z(s),oe=k([{v:ae,w:T.match??0},{v:I,w:T.ling??0},{v:B,w:T.di??0},{v:H,w:T.shi??0},{v:te,w:T.quality??0},{v:ie,w:T.strong??0},{v:re,w:T.noHarm??0}]),se=[];o&&!M&&se.push(`DAY_MASTER_NOT_MATCH`),K&&se.push(`MONTH_GYEOK_BROKEN`),q&&se.push(`MONTH_GYEOK_MIXED`),J&&se.push(`MONTH_GYEOK_ZHUO`),ie<=.001&&se.push(`NOT_STRONG`),I<=.001&&se.push(`NOT_IN_SEASON`),o&&!M&&(oe=0),K&&(oe*=Z(1-D.broken)),q&&(oe*=Z(1-D.mixed)),J&&(oe*=Z(1-D.zhuo));let ce=Z(oe),le=Z(A*ce);n.zhuanwangConditionFactor=ce,n.zhuanwangFactor=le,n.zhuanwangDetails={enabled:!0,requireDayMasterMatch:o,weights:{...T},thresholds:{lingThreshold:c,diThreshold:l,shiThreshold:u,qualityThreshold:d,strongThreshold:f,harmThreshold:p,rootNorm:m,shiNorm:h,rootResAlpha:g,shiResAlpha:_,dayNotMatchPenalty:s},signals:{baseFactor:A,zhuanwangCondition:ce,zhuanwangFactor:le,dominantElementShare:typeof t?.elements?.normalized?.[j]==`number`?t.elements.normalized[j]:0,strengthIndex:N,dayMatch:M?1:0,lingScore:P,ling01:F,diNorm:L,shiNorm:R,monthQuality:W,monthClarity:G,monthIntegrity:ee,harmElementShare:ne,fMatch:ae,fLing:I,fDi:B,fShi:H,fQuality:te,fStrong:ie,fNoHarm:re},flags:{dayMasterMatch:M,monthBroken:K,monthMixed:q,monthZhuo:J},reasons:se}}function lr(e,t){let n=e.strategies?.patterns?.follow??e.strategies?.patterns?.jonggyeok??e.strategies?.follow??{};if(n?.enabled!==!0)return;let r=(e,t)=>typeof e==`number`&&Number.isFinite(e)?e:t,i=e.strategies?.yongshin?.methodSelector?.follow??e.strategies?.yongshin?.follow??{},a=r(n.weakThreshold,r(i?.weakThreshold,-.78)),o=r(n.strongThreshold,r(i?.strongThreshold,Math.abs(a))),s=r(n.minDominanceRatio,r(i?.minDominanceRatio,2.2)),c=r(n.oneElementBoost,r(i?.oneElementBoost,0)),l=t.strength.index,u=t.strength.support,d=t.strength.pressure,f=1e-9,p=l<a?Z((a-l)/Math.max(f,a+1)):0,m=d/Math.max(f,u),h=Z(p*Z((m-s)/Math.max(f,s))),g=l>o?Z((l-o)/Math.max(f,1-o)):0,_=u/Math.max(f,d),v=Z(g*Z((_-s)/Math.max(f,s))),y=`NONE`,b=0,x=0;v>h?(x=v,y=v>0?`SUPPORT`:`NONE`,b=_):(x=h,y=h>0?`PRESSURE`:`NONE`,b=m);let S=t.strength.components,C=S.companions>=S.resources?`COMPANION`:`RESOURCE`,w=(()=>{let e=S.outputs,t=S.wealth,n=S.officers,r=`OUTPUT`,i=e;return t>=i&&(i=t,r=`WEALTH`),n>=i&&(i=n,r=`OFFICER`),r})(),T=y===`SUPPORT`?C:y===`PRESSURE`?w:`COMPANION`,E=(e=>{for(let n of X)if(t.dayMasterRoleByElement[n]===e)return n;return t.dayMaster.element})(T),D=t.patterns?.elements?.oneElement,O=typeof D?.factor==`number`&&Number.isFinite(D.factor)?D.factor:0,k=typeof D?.zhuanwangFactor==`number`&&Number.isFinite(D.zhuanwangFactor)?D.zhuanwangFactor:0,A=Z(y===`SUPPORT`&&k>0?k:O),j=Z(x*(1+A*c)),M=n.jonggyeok??n.conditions??n.conditionPack??{},N=M?.enabled===!0,P=1,F=j,I;if(N){let n=M.applyTo===`PRESSURE`||M.applyTo===`SUPPORT`?M.applyTo:`BOTH`;if(!(n===`BOTH`||n===y))P=1,F=j,I={enabled:!0,applyTo:n,weights:{},thresholds:{},signals:{applied:0},flags:{applied:!1},reasons:[`NOT_APPLIED`]};else if(y===`NONE`)P=0,F=0,I={enabled:!0,applyTo:n,weights:{},thresholds:{},signals:{applied:1},flags:{applied:!0},reasons:[`MODE_NONE`]};else{let i=M.thresholds??{},a=M.weights??{},o=M.penalties??{},s=r(i.share,r(M.shareThreshold,.28)),c=r(i.season,r(M.seasonThreshold,.45)),f=r(i.root,r(M.rootThreshold,.35)),p=r(i.purity,r(M.purityThreshold,.55)),m=r(i.quality,r(M.qualityThreshold,.55)),h=r(i.counter,r(M.counterThreshold,.18)),g=r(i.opposition,r(M.oppositionThreshold,.4)),_=r(i.rootNorm,r(M.rootNorm,2.2)),v=r(i.rootResAlpha,r(M.rootResAlpha,.6)),C={month:r((i.rootWeights??M.rootWeights)?.month,.65),day:r((i.rootWeights??M.rootWeights)?.day,.35)},w={share:r(a.share,.15),season:r(a.season,.15),root:r(a.root,.1),purity:r(a.purity,.15),quality:r(a.quality,.15),noCounter:r(a.noCounter,.15),lowOpp:r(a.lowOpp,.15)},T=Object.values(w).reduce((e,t)=>e+t,0),D=T>0?Object.fromEntries(Object.entries(w).map(([e,t])=>[e,t/T])):w,O={broken:r(o.broken,.25),mixed:r(o.mixed,.1),zhuo:r(o.zhuo,.08)},k=t.month.gyeok.quality,A=typeof k?.multiplier==`number`&&Number.isFinite(k.multiplier)?k.multiplier:0,N=k?.broken===!0,L=k?.mixed===!0,R=k?.qingZhuo===`ZHUO`,z=e=>e===`WOOD`?`METAL`:e===`FIRE`?`WATER`:e===`EARTH`?`WOOD`:e===`METAL`?`FIRE`:`EARTH`,B=typeof t?.elements?.normalized?.[E]==`number`?t.elements.normalized[E]:0,H=Z((B-s)/Math.max(1e-9,1-s)),U=t.month.element,W=mr(U,E),G=Z((W+1)/2),ee=Z((G-c)/Math.max(1e-9,1-c)),K=e.weights?.hiddenStems??{},q=t.chart.pillars.month.branch,J=t.chart.pillars.day.branch,te=Lt(q,K),Y=Lt(J,K),ne=0,re=0;for(let e of te){let t=V(e.stem);t===E?ne+=C.month*e.weight:en(t,E)&&(re+=C.month*e.weight)}for(let e of Y){let t=V(e.stem);t===E?ne+=C.day*e.weight:en(t,E)&&(re+=C.day*e.weight)}let ie=ne+v*re,ae=Z(_<=0?0:ie/_),oe=Z((ae-f)/Math.max(1e-9,1-f)),se=y===`SUPPORT`?Math.max(1e-9,u):Math.max(1e-9,d),ce=(y===`SUPPORT`?Math.max(S.companions,S.resources):Math.max(S.outputs,Math.max(S.wealth,S.officers)))/se,le=Z((ce-p)/Math.max(1e-9,1-p)),ue=Math.max(1e-9,t.strength.total),de=y===`SUPPORT`?d/ue:u/ue,fe=g<=0?1:Z((g-de)/Math.max(1e-9,g)),pe=z(E),me=typeof t?.elements?.normalized?.[pe]==`number`?t.elements.normalized[pe]:0,he=h<=0?1:Z((h-me)/Math.max(1e-9,h)),ge=Z((A-m)/Math.max(1e-9,1-m)),_e=(e=>{let t=0,n=0;for(let r of e)r.w>0&&(t+=r.w,n+=r.w*Math.log(Math.max(1e-9,Z(r.v))));return t<=0?0:Z(Math.exp(n/t))})([{v:H,w:D.share??0},{v:ee,w:D.season??0},{v:oe,w:D.root??0},{v:le,w:D.purity??0},{v:ge,w:D.quality??0},{v:he,w:D.noCounter??0},{v:fe,w:D.lowOpp??0}]);N&&(_e=Z(_e*(1-O.broken))),L&&(_e=Z(_e*(1-O.mixed))),R&&(_e=Z(_e*(1-O.zhuo)));let ve=[];B<s&&ve.push(`DOM_SHARE_LOW`),G<c&&ve.push(`SEASON_NOT_SUPPORT_DOM`),ae<f&&ve.push(`ROOT_WEAK`),ce<p&&ve.push(`ROLE_MIXED`),de>g&&ve.push(`OPPOSITION_HIGH`),me>h&&ve.push(`COUNTER_HIGH`),N&&ve.push(`MONTH_GYEOK_BROKEN`),L&&ve.push(`MONTH_GYEOK_MIXED`),R&&ve.push(`MONTH_GYEOK_ZHUO`),P=_e,F=Z(j*_e),I={enabled:!0,applyTo:n,weights:{...D},thresholds:{shareThreshold:s,seasonThreshold:c,rootThreshold:f,purityThreshold:p,qualityThreshold:m,counterThreshold:h,oppositionThreshold:g,rootNorm:_,rootResAlpha:v,rootWeights:C},signals:{applied:1,basePotential:x,potentialBoosted:j,jonggyeokCondition:_e,jonggyeokFactor:F,dominantElementShare:B,strengthIndex:l,dominanceRatio:b,modeSupport:y===`SUPPORT`?1:0,monthSupportScore:W,monthSupport01:G,rootScore:ie,root01:ae,rolePurity:ce,oppositionShare:de,harmElementShare:me,monthQuality:A,fShare:H,fSeason:ee,fRoot:oe,fPurity:le,fQuality:ge,fNoCounter:he,fLowOpp:fe},flags:{applied:!0,monthBroken:N,monthMixed:L,monthZhuo:R},reasons:ve}}}let L=t.tenGodScores??{},[R,z]=(e=>{switch(e){case`COMPANION`:return[`BI_GYEON`,`GEOB_JAE`];case`RESOURCE`:return[`JEONG_IN`,`PYEON_IN`];case`OUTPUT`:return[`SIK_SHIN`,`SANG_GWAN`];case`WEALTH`:return[`JEONG_JAE`,`PYEON_JAE`];case`OFFICER`:return[`JEONG_GWAN`,`PYEON_GWAN`];default:return[`BI_GYEON`,`GEOB_JAE`]}})(T),B=typeof L[R]==`number`&&Number.isFinite(L[R])?L[R]:0,H=typeof L[z]==`number`&&Number.isFinite(L[z])?L[z]:0,U=B+H,W=B>=H?R:z,G=B>=H?z:R,ee=B>=H?B:H,K=B>=H?H:B,q=U>0?ee/U:.5,J=U>0?Z(Math.abs(B-H)/U):0,te=y!==`NONE`&&x>0?W:void 0,Y=`NONE`;y!==`NONE`&&x>0&&(T===`WEALTH`?Y=`CONG_CAI`:T===`OUTPUT`?Y=`CONG_ER`:T===`RESOURCE`?Y=`CONG_YIN`:T===`COMPANION`?Y=`CONG_BI`:T===`OFFICER`&&(Y=W===`PYEON_GWAN`?`CONG_SHA`:`CONG_GUAN`));let ne=y!==`NONE`&&x>0?{primary:W,secondary:G,primaryScore:ee,secondaryScore:K,total:U,primaryShare:q,confidence:J}:void 0;if(N&&I&&I.flags?.applied===!0&&y!==`NONE`&&x>0&&Y!==`NONE`){let e=M?.typeAware??M?.type??{};if(e?.enabled===!0){let t=e.thresholds??{},n=e.weights??{},i=r(t.subtypeConfidence,.25),a=r(t.directCounterShare??t.directCounter,.12),o=(t.perType??t.byType??{})[Y]??{},s=r(o.subtypeConfidence,i),c=r(o.directCounterShare??o.directCounter,a),l=r(n.subtype,.12),u=r(n.directCounter,.1),d=s<=0?1:Z((J-s)/Math.max(1e-9,1-s)),f=Object.values(L).reduce((e,t)=>e+(typeof t==`number`&&Number.isFinite(t)?t:0),0),p=e=>f>0?r(L[e],0)/f:0,m=e.officerCounterWeights??e.counters?.officer??{},h=r(m.SANG_GWAN,1),g=r(m.SIK_SHIN,.6),_=(()=>{switch(Y){case`CONG_CAI`:return[{tg:`BI_GYEON`,w:1},{tg:`GEOB_JAE`,w:1}];case`CONG_ER`:return[{tg:`JEONG_IN`,w:1},{tg:`PYEON_IN`,w:1}];case`CONG_YIN`:return[{tg:`JEONG_JAE`,w:1},{tg:`PYEON_JAE`,w:1}];case`CONG_BI`:return[{tg:`JEONG_GWAN`,w:1},{tg:`PYEON_GWAN`,w:1}];case`CONG_GUAN`:case`CONG_SHA`:return[{tg:`SANG_GWAN`,w:h},{tg:`SIK_SHIN`,w:g}];default:return[]}})(),v=0,y=0;for(let e of _)e.w>0&&(v+=e.w*p(e.tg),y+=e.w);v=Z(y>0?v/y:0);let b=c<=0?1:Z((c-v)/Math.max(1e-9,c)),x=(l>0?l:0)+(u>0?u:0),S=1e-12,C=x<=0?1:Z(Math.exp(((l>0?l:0)*Math.log(Math.max(S,d))+(u>0?u:0)*Math.log(Math.max(S,b)))/x)),w=P,T=F;P=Z(P*C),F=Z(j*P);let E=I;E.weights={...E.weights??{},subtype:l,directCounter:u},E.thresholds={...E.thresholds??{},subtypeConfidence:s,directCounterShare:c},E.signals={...E.signals??{},jonggyeokConditionBase:typeof E.signals?.jonggyeokCondition==`number`?E.signals.jonggyeokCondition:w,jonggyeokFactorBase:typeof E.signals?.jonggyeokFactor==`number`?E.signals.jonggyeokFactor:T,subtypeConfidence:J,fSubtype:d,directCounterShare:v,fNoDirectCounter:b,typeAwareFactor:C,jonggyeokCondition:P,jonggyeokFactor:F},E.flags={...E.flags??{},typeAwareApplied:!0,tenGodMixed:J<s,directCounterHigh:v>c},E.reasons=Array.isArray(E.reasons)?E.reasons.slice():[],J<s&&E.reasons.push(`TEN_GOD_MIXED`),v>c&&E.reasons.push(`DIRECT_COUNTER_HIGH`)}}t.patterns.follow={enabled:!0,potentialRaw:x,potential:j,mode:y,dominanceRatio:b,dominantRole:T,dominantElement:E,followType:Y,followTenGod:te,followTenGodSplit:ne,oneElementFactor:A,oneElementBoost:c,jonggyeokConditionFactor:P,jonggyeokFactor:F,jonggyeokDetails:I}}function ur(e,t){let n=e.strategies?.patterns?.transformations??{},r=n?.enabled!==!1,i=(e,t)=>typeof e==`number`&&Number.isFinite(e)?e:t,a=i(n.threshold,.55),o=i(n.weightShare,.6),s=i(n.weightSeason,.4),c=i(n.weightRoot,.1),l=i(n.weightPosition,.1),u=n.normalizeWeights!==!1,d=n.positionWeights??{},f={year:i(d.year,.15),month:i(d.month,.35),day:i(d.day,.35),hour:i(d.hour,.15)},p=f.year+f.month+f.day+f.hour,m=p>0?{year:f.year/p,month:f.month/p,day:f.day/p,hour:f.hour/p}:{year:.25,month:.25,day:.25,hour:.25},h=n.rootWeights??{},g={month:i(h.month,.65),day:i(h.day,.35)},_=g.month+g.day,v=_>0?{month:g.month/_,day:g.day/_}:{month:.5,day:.5},y=n.break??{},b=y?.enabled!==!1,x=y.weights??{},S={stemClash:i(x.stemClash,.12),branchDamage:i(x.branchDamage,.08),interBranchDamage:i(x.interBranchDamage,.08)},C=n.competition??{},w=C?.enabled===!0,T=i(C.startRatio,.75),E=i(C.maxPenalty,.4),D=n.huaqi??{},O=D?.enabled===!0,k=D?.requireDayMasterInvolved!==!1,A=i(D.dayNotInvolvedPenalty,k?0:.15),j=i(D.shareThreshold,.45),M=i(D.qualityThreshold,.55),N=i(D.rootThreshold,.35),P=i(D.harmThreshold,.18),F=i(D.origWeakThreshold,.28),I=i(D.distanceExponent,2.5),L=D.weights??{},R={share:i(L.share,.2),season:i(L.season,.15),root:i(L.root,.1),quality:i(L.quality,.2),distance:i(L.distance,.15),day:i(L.day,.1),noHarm:i(L.noHarm,.1),origWeak:i(L.origWeak,0)},z=Object.values(R).reduce((e,t)=>e+t,0),B=z>0?Object.fromEntries(Object.entries(R).map(([e,t])=>[e,t/z])):{...R},U=D.penalties??{},W={broken:i(U.broken,.25),mixed:i(U.mixed,.1),zhuo:i(U.zhuo,.08)},G=e=>{switch(e){case`WOOD`:return`METAL`;case`FIRE`:return`WATER`;case`EARTH`:return`WOOD`;case`METAL`:return`FIRE`;case`WATER`:return`EARTH`}},ee=e=>{let t=0,n=0;for(let r of e){let e=typeof r.w==`number`&&Number.isFinite(r.w)?r.w:0;if(e<=0)continue;let i=Z(typeof r.v==`number`&&Number.isFinite(r.v)?r.v:0);t+=e,n+=e*Math.log(i+1e-12)}return t<=0?0:Z(Math.exp(n/t))},{pillars:K,stems:q,normalized:J,hiddenStemPolicy:te,damagedBranches:Y,byType:ne}=t,re=H(K.month.branch),ie={};for(let e of q)ie[e]=(ie[e]??0)+1;let ae=[{a:0,b:5,result:`EARTH`,pair:`甲己`},{a:1,b:6,result:`METAL`,pair:`乙庚`},{a:2,b:7,result:`WATER`,pair:`丙辛`},{a:3,b:8,result:`WOOD`,pair:`丁壬`},{a:4,b:9,result:`FIRE`,pair:`戊癸`}],oe=e=>e===0?6:e===6?0:e===1?7:e===7?1:e===2?8:e===8?2:e===3?9:e===9?3:null,se=new Set(q),ce=new Set(Y??[]),le=[{idx:0,name:`year`,stem:K.year.stem,branch:K.year.branch,w:m.year},{idx:1,name:`month`,stem:K.month.stem,branch:K.month.branch,w:m.month},{idx:2,name:`day`,stem:K.day.stem,branch:K.day.branch,w:m.day},{idx:3,name:`hour`,stem:K.hour.stem,branch:K.hour.branch,w:m.hour}],ue=(e,t)=>{let n=Lt(e,te??{scheme:`standard`}),r=0;for(let e of n)V(e.stem)===t&&(r+=e.weight);return r},de=ae.map(e=>{let t=ie[e.a]??0,n=ie[e.b]??0,i=t>0&&n>0,d=J[e.result]??0,f=mr(re,e.result),p=Z((f+1)/2),m=0,h=0,g=[],_=[],y=[],x=[];for(let t of le)t.stem===e.a&&(m+=t.w,g.push(t.branch),y.push(t.idx)),t.stem===e.b&&(h+=t.w,_.push(t.branch),x.push(t.idx));m=Z(m),h=Z(h);let C=Z(Math.sqrt(m*h)),w=0;for(let e of y)for(let t of x){let n=Math.abs(e-t);n>=1&&(w=Math.max(w,1/n))}w=Z(w);let T=ue(K.month.branch,e.result),E=ue(K.day.branch,e.result),D=Z(v.month*T+v.day*E),O=D,k=o+s+c+l,A=u&&k>0?o/k:o,j=u&&k>0?s/k:s,M=u&&k>0?c/k:c,N=u&&k>0?l/k:l,P=Z(A*d+j*p+M*O+N*C),F=r&&i?Z((P-a)/Math.max(1e-9,1-a)):0,I=0;if(i){let t=oe(e.a),n=oe(e.b);t!=null&&se.has(t)&&(I+=1),n!=null&&se.has(n)&&(I+=1)}let L=0;for(let e of g)ce.has(e)&&(L+=1);for(let e of _)ce.has(e)&&(L+=1);let R=0,z=new Set(g),B=new Set(_);for(let e of[`CHUNG`,`HAE`,`PA`,`WONJIN`,`HYEONG`]){let t=ne?.[e]??[];for(let e of t){let t=e.some(e=>z.has(e)),n=e.some(e=>B.has(e));t&&n&&(R+=1)}}let V=b?S.stemClash*I+S.branchDamage*L+S.interBranchDamage*R:0,H=b?Z(1/(1+V)):1,U=F*H;return{pair:e.pair,stems:{a:e.a,b:e.b},resultElement:e.result,present:i,counts:{a:t,b:n},support:{elementShare:d,seasonScore:f,season01:p,rootScore:D,root01:O,pos:{a:m,b:h,pair:C},distanceFactor:w,blended:P,weights:{share:A,season:j,root:M,position:N,total:k}},break:{stemClash:I,branchDamage:L,interBranchDamage:R,penalty:V,factor:H,weights:{stemClash:S.stemClash,branchDamage:S.branchDamage,interBranchDamage:S.interBranchDamage}},rawFactor:F,factor:U}}),fe,pe=-1,me=-1;for(let e of de){let t=typeof e.factor==`number`?e.factor:0;t>pe?(me=pe,pe=t,fe=e):t>me&&(me=t)}let he=pe>0&&me>0?Z(me/pe):0,ge=w?Z((he-T)/Math.max(1e-9,1-T)):0,_e=w?Z(1-E*ge):1,ve;if(fe&&pe>0){let e=pe*_e;if(ve={pair:fe.pair,resultElement:fe.resultElement,factor:pe,blended:fe.support.blended,rawFactor:fe.rawFactor,breakFactor:fe.break?.factor,secondFactor:me>0?me:0,competitionFactor:_e,effectiveFactor:e},O){let n=t.monthGyeokQuality,r=typeof n?.multiplier==`number`&&Number.isFinite(n.multiplier)?n.multiplier:1,i=typeof n?.clarity==`number`&&Number.isFinite(n.clarity)?n.clarity:1,a=typeof n?.integrity==`number`&&Number.isFinite(n.integrity)?n.integrity:1,o=n?.broken===!0,s=n?.mixed===!0,c=n?.qingZhuo===`ZHUO`,l=K.day.stem===fe.stems.a||K.day.stem===fe.stems.b,u=fe.support.elementShare,d=fe.support.season01,f=typeof fe.support.root01==`number`&&Number.isFinite(fe.support.root01)?fe.support.root01:0,p=typeof fe.support.distanceFactor==`number`&&Number.isFinite(fe.support.distanceFactor)?fe.support.distanceFactor:0,m=Z(p**+I),h=G(fe.resultElement),g=typeof J[h]==`number`?J[h]:0,_=V(fe.stems.a),v=V(fe.stems.b),y=.5*((typeof J[_]==`number`?J[_]:0)+(typeof J[v]==`number`?J[v]:0)),b=Z((u-j)/Math.max(1e-9,1-j)),x=Z((r-M)/Math.max(1e-9,1-M)),S=Z((f-N)/Math.max(1e-9,1-N)),C=d,w=m,T=l?1:Z(A),E=P<=0?1:Z((P-g)/Math.max(1e-9,P)),D=F<=0?1:Z((F-y)/Math.max(1e-9,F)),O=ee([{v:b,w:B.share??0},{v:C,w:B.season??0},{v:S,w:B.root??0},{v:x,w:B.quality??0},{v:w,w:B.distance??0},{v:T,w:B.day??0},{v:E,w:B.noHarm??0},{v:D,w:B.origWeak??0}]),L=[];k&&!l&&L.push(`DAY_MASTER_NOT_INVOLVED`),o&&L.push(`MONTH_GYEOK_BROKEN`),s&&L.push(`MONTH_GYEOK_MIXED`),c&&L.push(`MONTH_GYEOK_ZHUO`),k&&!l&&(O=0),o&&(O*=Z(1-W.broken)),s&&(O*=Z(1-W.mixed)),c&&(O*=Z(1-W.zhuo)),ve.huaqiConditionFactor=Z(O),ve.huaqiFactor=Z(e*O),ve.huaqiDetails={enabled:!0,requireDayMasterInvolved:k,weights:{...B},thresholds:{shareThreshold:j,qualityThreshold:M,rootThreshold:N,harmThreshold:P,origWeakThreshold:F,distanceExponent:I},signals:{effectiveFactor:e,share:u,season01:d,root01:f,distanceRaw:p,distance:m,monthQuality:r,monthClarity:i,monthIntegrity:a,harmElementShare:g,origShare:y,fShare:b,fSeason:C,fRoot:S,fQuality:x,fDist:w,fDay:T,fNoHarm:E,fOrigWeak:D},flags:{dayInvolved:l,monthBroken:o,monthMixed:s,monthZhuo:c},reasons:L}}}return{enabled:r,threshold:a,competition:{enabled:w,startRatio:T,maxPenalty:E,ratio:he,factor:_e},weightShare:o,weightSeason:s,weightRoot:c,weightPosition:l,normalizeWeights:u,positionWeights:m,rootWeights:v,break:{enabled:b,weights:S},candidates:de,best:ve}}var dr={damageWeights:{CHUNG:1,HAE:.7,PA:.7,WONJIN:.5,HYEONG:.8},clarityWeights:{gap:.25,alignment:.2,method:.2,purity:.2,root:.15},qingThreshold:.66,integrityThreshold:.6,brokenDamageThreshold:1,rootNorm:1,enabled:!0};function fr(e){let{config:t,monthBranch:n,gyeokStem:r,gyeokTenGod:i,gyeokMethod:a,monthGyeokCandidates:o,branches:s,hiddenStemPolicy:c,tenGodScoresRanking:l,detectedRelations:u,byType:d}=e,f=t.strategies?.gyeokguk?.quality??{},p={enabled:f.enabled??dr.enabled,damageWeights:{...dr.damageWeights,...f.damageWeights??{}},clarityWeights:{...dr.clarityWeights,...f.weights??f.clarityWeights??{}},qingThreshold:typeof f.qingThreshold==`number`?f.qingThreshold:dr.qingThreshold,integrityThreshold:typeof f.integrityThreshold==`number`?f.integrityThreshold:dr.integrityThreshold,brokenDamageThreshold:typeof f.brokenDamageThreshold==`number`?f.brokenDamageThreshold:dr.brokenDamageThreshold,rootNorm:typeof f.rootNorm==`number`?f.rootNorm:dr.rootNorm};if(p.enabled===!1)return{clarity:1,integrity:1,damage:0,qingZhuo:`QING`,broken:!1,mixed:!1,multiplier:1,reasons:[`quality:disabled`],details:{gap:1,alignmentRank:0,rootScore:0,rootNorm:p.rootNorm,damageByType:{},damageRelations:[]}};let m=o[0]?.score??0,h=o[1]?.score??0,g=m>0?Z((m-h)/m):0,_=l.findIndex(e=>e.tenGod===i),v=_<0?0:Z(1-.25*_),y=(()=>{switch(a){case`MAIN_EXPOSED`:return 1;case`VISIBLE_HIDDEN`:return .9;case`GROUP_SUPPORTED`:return .85;default:return .7}})(),b=new Set(o.filter(e=>e.visibleInChart).map(e=>e.tenGod)).size,x=b>1,S=b<=1?1:Z(1-.3*(b-1)),C=V(r),w=0;for(let e of s)for(let t of Lt(e,c))V(t.stem)===C&&(w+=t.weight);let T=p.rootNorm>0?Z(w/p.rootNorm):0,E=e=>(d[e]??[]).filter(e=>e.includes(n)).length,D={CHUNG:E(`CHUNG`),HAE:E(`HAE`),PA:E(`PA`),WONJIN:E(`WONJIN`),HYEONG:[`HYEONG`,`JA_HYEONG`,`SAMHYEONG`].reduce((e,t)=>e+E(t),0)},O=p.damageWeights,k=D.CHUNG*(typeof O.CHUNG==`number`?O.CHUNG:0)+D.HAE*(typeof O.HAE==`number`?O.HAE:0)+D.PA*(typeof O.PA==`number`?O.PA:0)+D.WONJIN*(typeof O.WONJIN==`number`?O.WONJIN:0)+D.HYEONG*(typeof O.HYEONG==`number`?O.HYEONG:0),A=Z(1/(1+Math.max(0,k))),j=k>=p.brokenDamageThreshold,M=p.clarityWeights??{},N={gap:typeof M.gap==`number`?M.gap:dr.clarityWeights.gap,alignment:typeof M.alignment==`number`?M.alignment:dr.clarityWeights.alignment,method:typeof M.method==`number`?M.method:dr.clarityWeights.method,purity:typeof M.purity==`number`?M.purity:dr.clarityWeights.purity,root:typeof M.root==`number`?M.root:dr.clarityWeights.root},P=N.gap+N.alignment+N.method+N.purity+N.root,F=P>0?1/P:1,I=Z((N.gap*g+N.alignment*v+N.method*y+N.purity*S+N.root*T)*F),L=I>=p.qingThreshold&&A>=p.integrityThreshold&&!x?`QING`:`ZHUO`,R=Z(A*(.5+.5*I)),z=u.filter(e=>e.members.includes(n)&&(e.type===`CHUNG`||e.type===`HAE`||e.type===`PA`||e.type===`WONJIN`||e.type===`HYEONG`||e.type===`JA_HYEONG`||e.type===`SAMHYEONG`)),B=[];return B.push(`method:${a}`),x&&B.push(`mixedVisible:${b}`),g<.2&&B.push(`gap:low`),_>1&&B.push(`alignmentRank:${_}`),T>=.7&&B.push(`root:strong`),k>0&&B.push(`damage:${k.toFixed(2)}`),B.push(`qingZhuo:${L}`),{clarity:I,integrity:A,damage:k,qingZhuo:L,broken:j,mixed:x,multiplier:R,reasons:B,details:{gap:g,alignmentRank:_,rootScore:w,rootNorm:p.rootNorm,damageByType:D,damageRelations:z}}}function pr(e){let t=(e.BI_GYEON??0)+(e.GEOB_JAE??0),n=(e.PYEON_IN??0)+(e.JEONG_IN??0),r=(e.SIK_SHIN??0)+(e.SANG_GWAN??0),i=(e.PYEON_JAE??0)+(e.JEONG_JAE??0),a=(e.PYEON_GWAN??0)+(e.JEONG_GWAN??0),o=t+n,s=r+i+a,c=o+s;return{index:c<=0?0:(o-s)/c,support:o,pressure:s,total:c,components:{companions:t,resources:n,outputs:r,wealth:i,officers:a}}}function mr(e,t){return e===t?1:en(e,t)?.6:en(t,e)?-.6:tn(e,t)?-.8:tn(t,e)?-.3:0}function hr(e){let t=pr(e.tenGods),n=e.config.strategies?.strength?.model??`base`;if(n===`deLingDiShi`||n===`delingdiShi`||n===`delingsh`||n===`deLing`){let n=V(e.dayMasterStem),r=H(e.monthBranch),i=e.config.strategies?.strength??{},a=(e,t)=>typeof e==`number`&&Number.isFinite(e)?e:t,o=a(i.lingScale,.18),s=a(i.diScale,.14),c=a(i.shiScale,.1),l=a(i.rootNorm,2.2),u=a(i.shiNorm,1.6),d=a(i.rootResAlpha,.6),f=a(i.shiResAlpha,.7),p={year:a(i.positionWeights?.year,.6),month:a(i.positionWeights?.month,1),hour:a(i.positionWeights?.hour,.8)},m=mr(r,n),h=m*o,g=[a(i.branchWeights?.year,.7),a(i.branchWeights?.month,1.1),a(i.branchWeights?.day,.9),a(i.branchWeights?.hour,.7)],_=0,v=0;for(let t=0;t<e.branches.length;t++){let r=e.branches[t],i=g[t]??1;for(let t of Lt(r,e.hiddenStemPolicy??{})){let e=V(t.stem);e===n&&(_+=t.weight*i),en(e,n)&&(v+=t.weight*i)}}let y=Math.max(0,_+d*v),b=Z(y/Math.max(1e-9,l)),x=b*s,S=[{pos:`year`,stem:e.stems[0],w:p.year},{pos:`month`,stem:e.stems[1],w:p.month},{pos:`hour`,stem:e.stems[3],w:p.hour}],C=0,w=0;for(let e of S){let t=V(e.stem);t===n&&(C+=e.w),en(t,n)&&(w+=e.w)}let T=Math.max(0,C+f*w),E=Z(T/Math.max(1e-9,u)),D=E*c,O=Math.max(0,t.support*(1+h+x+D)),k=t.pressure,A=O+k;return{index:A<=0?0:(O-k)/A,support:O,pressure:k,total:A,components:t.components,model:`deLingDiShi`,details:{delingdiShi:{deLing:{monthElement:r,dayMasterElement:n,score:m,factor:o},deDi:{sameElement:_,resourceElement:v,score:y,normalized:b,factor:s},deShi:{sameElement:C,resourceElement:w,score:T,normalized:E,factor:c,positionWeights:p},adjusted:{support:O,pressure:k,total:A}}}}}if(n!==`seasonalRoots`)return{...t,model:`base`};let r=V(e.dayMasterStem),i=H(e.monthBranch),a=e.config.strategies?.strength?.seasonScale,o=e.config.strategies?.strength?.rootScale,s=typeof a==`number`&&Number.isFinite(a)?a:.14,c=typeof o==`number`&&Number.isFinite(o)?o:.1,l=mr(i,r),u=l*s,d=0,f=0;for(let t of e.branches)for(let n of Lt(t,e.hiddenStemPolicy??{})){let e=V(n.stem);e===r&&(d+=n.weight),en(e,r)&&(f+=n.weight)}let p=Math.max(0,d+.6*f),m=p*c,h=Math.max(0,t.support*(1+u+m)),g=t.pressure,_=h+g;return{index:_<=0?0:(h-g)/_,support:h,pressure:g,total:_,components:t.components,model:`seasonalRoots`,details:{season:{monthElement:i,seasonGroup:e.seasonGroup,dayMasterElement:r,score:l,factor:s},roots:{sameElement:d,resourceElement:f,score:p,factor:c},adjusted:{support:h,pressure:g,total:_}}}}function gr(e,t){let n=Lt(e,t??{}),r=n.find(e=>e.role===`MAIN`)??n[0];if(!r)throw Error(`Invariant: hidden stems table empty for branch`);return r.stem}var _r={JI_SAL:0,DOHWA:1,WOL_SAL:2,MANG_SHIN_SAL:3,JANGSEONG:4,BAN_AN_SAL:5,YEOKMA:6,YUK_HAE_SAL:7,HUAGAI:8,GEOB_SAL:9,JAESAL:10,CHEON_SAL:11};function vr(e){return M(8-3*(M(e,12)%4),12)}function yr(e){let t=vr(e),n={};for(let e of $n)n[e]=M(t+_r[e],12);return n}function br(e){return M(3-e,12)}function xr(e){return Mr(br(e))}function Sr(e){let t=K(e)??0,n=M(10-2*Math.floor(M(t,60)/10),12);return[n,M(n+1,12)]}function Cr(e){let t=Kn(e),n=t===`SPRING`||t===`AUTUMN`?`戊`:`甲`,r=t===`SPRING`?`寅`:t===`SUMMER`?`午`:t===`AUTUMN`?`申`:`子`,i=q(n),a=J(r);if(i==null||a==null)throw Error(`Invariant: invalid hanja for cheonSa target pillar`);return{season:t,target:G(i,a),targetHanja:`${n}${r}`}}function wr(e){let t=e.strategies?.lifeStages??e.strategies?.lifeStage??{},n=t.earthRule??`FOLLOW_FIRE`;return{earthRule:n===`FOLLOW_WATER`||n===`INDEPENDENT`||n===`FOLLOW_FIRE`?n:`FOLLOW_FIRE`,yinReversalEnabled:t.yinReversalEnabled??!0}}function Tr(e){let t=e.extensions??{},n=t.catalogs?.shinsal??t.catalog?.shinsal??t.shinsalCatalog;return Pn(n?On(Fn,n):Fn)}function Er(e){return Array.from(new Set(e.map(e=>M(e,12))))}function Dr(e){return Array.from(new Set(e.map(e=>M(e,10))))}function Or(e,t){if(!e||e.length===0)return{present:[],count:0};let n=new Set(e.map(e=>M(e,12))),r=t.filter(e=>n.has(M(e,12)));return{present:Er(r),count:r.length}}function kr(e,t){if(!e||e.length===0)return{present:[],count:0};let n=new Set(e.map(e=>M(e,10))),r=t.filter(e=>n.has(M(e,10)));return{present:Dr(r),count:r.length}}function Ar(e,t){if(!e||e.length===0)return[];let n=new Set(e.map(e=>M(e,12))),r=[];return n.has(M(t.year.branch,12))&&r.push(`year`),n.has(M(t.month.branch,12))&&r.push(`month`),n.has(M(t.day.branch,12))&&r.push(`day`),n.has(M(t.hour.branch,12))&&r.push(`hour`),r}function jr(e,t){if(!e||e.length===0)return[];let n=new Set(e.map(e=>M(e,10))),r=[];return n.has(M(t.year.stem,10))&&r.push(`year`),n.has(M(t.month.stem,10))&&r.push(`month`),n.has(M(t.day.stem,10))&&r.push(`day`),n.has(M(t.hour.stem,10))&&r.push(`hour`),r}function Mr(e){return M(e+6,12)}function Nr(e,t){let n=M(M(e,12)-M(t,12),12);return n===2||n===10}function Pr(e){let{config:t,catalog:n,dayStem:r,pillars:i,chartBranches:a,chartStems:o}=e,s={};for(let[e,t]of Object.entries(n.dayStem)){let n=t.byStem[M(r,10)]??[],{present:o,count:c}=Or(n,a);s[e]={targets:n,present:o,count:c,matchedPillars:Ar(n,i)}}let c=M(i.year.stem,10),l={};for(let[e,t]of Object.entries(n.dayStem)){let n=t.byStem[c]??[],{present:r,count:o}=Or(n,a);l[e]={targets:n,present:r,count:o,matchedPillars:Ar(n,i)}}if(!s.HAK_DANG_GUI_IN){let e=[Wt(r,0,wr(t)).startBranch],{present:n,count:o}=Or(e,a);s.HAK_DANG_GUI_IN={targets:e,present:n,count:o,matchedPillars:Ar(e,i)}}if(!s.YANG_IN){let e=t.strategies?.shinsal?.yanginMode===`diWang`?`diWang`:`luNext`,n=s.LOK_SHIN?.targets?.[0]??[2,3,5,6,5,6,8,9,11,0][M(r,10)],o=M(r,2)===1,c=[M(n+(e===`diWang`&&o?-1:1),12)],{present:l,count:u}=Or(c,a);s.YANG_IN={targets:c,present:l,count:u,matchedPillars:Ar(c,i)}}if(!l.YANG_IN){let e=t.strategies?.shinsal?.yanginMode===`diWang`?`diWang`:`luNext`,n=l.LOK_SHIN?.targets?.[0]??[2,3,5,6,5,6,8,9,11,0][c],r=M(c,2)===1,o=[M(n+(e===`diWang`&&r?-1:1),12)],{present:s,count:u}=Or(o,a);l.YANG_IN={targets:o,present:s,count:u,matchedPillars:Ar(o,i)}}if(!s.BI_IN_SAL){let e=Er((s.YANG_IN?.targets??[]).map(e=>Mr(M(e,12)))),{present:t,count:n}=Or(e,a);s.BI_IN_SAL={targets:e,present:t,count:n,matchedPillars:Ar(e,i)}}if(!l.BI_IN_SAL){let e=Er((l.YANG_IN?.targets??[]).map(e=>Mr(M(e,12)))),{present:t,count:n}=Or(e,a);l.BI_IN_SAL={targets:e,present:t,count:n,matchedPillars:Ar(e,i)}}let u=M(i.month.branch,12),d=t.strategies?.shinsal??{},f=d.catalogScopes??d.scopes??{};f.monthBranchStem??f.monthStem,f.monthBranchBranch??f.monthBranch,d.monthDeokScope??d.deokScope;let p={};for(let[e,t]of Object.entries(n.monthBranchStem)){let n=t.byBranch[u]??[],{present:r,count:a}=kr(n,o),s=jr(n,i);p[e]={targets:n,target:n[0]??null,present:r,count:a,matchedPillars:s}}if(!p.DEOK_SU_GUI_IN){let e=u%4,t=Dr(({0:[`壬`,`癸`,`丙`,`辛`,`戊`,`己`,`甲`],1:[`庚`,`辛`,`乙`],2:[`丙`,`丁`,`戊`,`癸`],3:[`甲`,`乙`,`丁`,`壬`]}[e]??[]).map(e=>q(e)).filter(e=>e!=null)),{present:n,count:r}=kr(t,o),a=jr(t,i);p.DEOK_SU_GUI_IN={targets:t,target:t[0]??null,present:n,count:r,matchedPillars:a}}let m={};for(let[e,t]of Object.entries(n.monthBranchBranch)){let n=t.byBranch[u]??[],{present:r,count:o}=Or(n,a),s=Ar(n,i);m[e]={targets:n,target:n[0]??null,present:r,count:o,matchedPillars:s}}if(!m.CHEON_UI){let e=M(u-1,12),t=[e],{present:n,count:r}=Or(t,a);m.CHEON_UI={targets:t,target:e,present:n,count:r,matchedPillars:Ar(t,i)}}let h=t.strategies?.shinsal?.includeExtendedPillarSets??t.strategies?.shinsal?.includeExtended??[],g=new Set(h.map(String)),_=[`year`,`month`,`day`,`hour`],v={year:K(i.year),month:K(i.month),day:K(i.day),hour:K(i.hour)},y={};for(let[e,t]of Object.entries(n.dayPillar)){let n=new Set(t.primary);if(g.has(e))for(let e of t.extended)n.add(e);let r=_.filter(e=>{let t=v[e];return t!=null&&n.has(M(t,60))}),i=r.includes(`day`),a=t.requiresDayPillar?i:r.length>0;y[e]={requiresDayPillar:t.requiresDayPillar,isDayPillar:i,active:a,matchedPillars:r}}return{dayStem:s,yearStem:l,monthBranchStem:p,monthBranchBranch:m,dayPillar:y}}function Fr(e){let{config:t,pillars:n,elementDistribution:r,scoring:i}=e,a=[n.year.stem,n.month.stem,n.day.stem,n.hour.stem],o=[n.year.branch,n.month.branch,n.day.branch,n.hour.branch],s=Tt(o),c={};for(let e of s)(c[e.type]??=[]).push(e.members);let l=e=>Er((c[e]??[]).flatMap(e=>e)??[]),u=l(`CHUNG`),d=l(`HAE`),f=l(`YUKHAP`),p=l(`PA`),m=l(`WONJIN`),h=Er([`HYEONG`,`JA_HYEONG`,`SAMHYEONG`].flatMap(e=>(c[e]??[]).flatMap(e=>e))),g=t.strategies?.shinsal?.damageRelations??t.strategies?.shinsal?.damageTypes,_=new Set([`YUKHAP`,`CHUNG`,`HYEONG`,`JA_HYEONG`,`SAMHYEONG`,`HAE`,`PA`,`WONJIN`,`SAMHAP`,`BANGHAP`]),v=Array.isArray(g)?g.filter(e=>typeof e==`string`&&_.has(e)):In,y=Er(v.flatMap(e=>(c[e]??[]).flatMap(e=>e))),b=(e,t,r)=>({name:e,basedOn:`OTHER`,targetKind:`NONE`,targetBranches:r,matchedPillars:Ar(r,n),details:{relationType:t,members:r}}),x=t.strategies?.shinsal?.geokgakMode===`anyPair`?`anyPair`:`dayHour`,S=[];if(x===`anyPair`)for(let e=0;e<o.length;e++)for(let t=e+1;t<o.length;t++){let n=M(o[e],12),r=M(o[t],12);if(Nr(n,r)){let e=[n,r].sort((e,t)=>e-t);S.push(e)}}else{let e=M(n.day.branch,12),t=M(n.hour.branch,12);Nr(e,t)&&S.push([e,t].sort((e,t)=>e-t))}let C=new Set,w=S.filter(e=>{let t=`${e[0]}-${e[1]}`;return C.has(t)?!1:(C.add(t),!0)}),T={CHUNG_SAL:(c.CHUNG??[]).map(e=>b(`CHUNG_SAL`,`CHUNG`,e)),HAE_SAL:(c.HAE??[]).map(e=>b(`HAE_SAL`,`HAE`,e)),PA_SAL:(c.PA??[]).map(e=>b(`PA_SAL`,`PA`,e)),WONJIN_SAL:(c.WONJIN??[]).map(e=>b(`WONJIN_SAL`,`WONJIN`,e)),GEOKGAK_SAL:w.map(e=>b(`GEOKGAK_SAL`,x===`anyPair`?`GEOKGAK_ANY_PAIR`:`GEOKGAK_DAY_HOUR`,e)),HYEONG_SAL:[].concat((c.HYEONG??[]).map(e=>b(`HYEONG_SAL`,`HYEONG`,e)),(c.JA_HYEONG??[]).map(e=>b(`HYEONG_SAL`,`JA_HYEONG`,e)),(c.SAMHYEONG??[]).map(e=>b(`HYEONG_SAL`,`SAMHYEONG`,e)))},E=Sr(n.day);T.GONGMANG_SAL=E.filter(e=>o.includes(e)).length>0?[b(`GONGMANG_SAL`,`GONGMANG`,E)]:[];let D=n.day.stem,O=V(D),k=t.weights?.hiddenStems??{},A=gr(n.month.branch,k),j=rn(D,A),N=Lt(n.month.branch,k).map(e=>({stem:e.stem,element:V(e.stem),role:e.role,weight:e.weight,tenGod:rn(D,e.stem),visibleInChart:a.includes(e.stem)})),P=e=>{let t=[...e].sort((e,t)=>e-t).join(`,`);return t===`0,4,8`?`WATER`:t===`1,5,9`?`METAL`:t===`2,6,10`?`FIRE`:t===`3,7,11`?`WOOD`:null},F=e=>{let t=[...e].sort((e,t)=>e-t).join(`,`);return t===`2,3,4`?`WOOD`:t===`5,6,7`?`FIRE`:t===`8,9,10`?`METAL`:t===`0,1,11`?`WATER`:null},I=(()=>{let e=(c.SAMHAP??[]).find(e=>e.includes(n.month.branch));if(e){let t=P(e);if(t)return{type:`SAMHAP`,element:t,members:e}}let t=(c.BANGHAP??[]).find(e=>e.includes(n.month.branch));if(t){let e=F(t);if(e)return{type:`BANGHAP`,element:e,members:t}}return null})(),L=y.includes(n.month.branch),R=I?.element??null,z=N.map(e=>{let t=[],n=e.weight;return t.push(`weight:${e.weight.toFixed(2)}`),e.role===`MAIN`&&(n+=.15,t.push(`MAIN`)),e.visibleInChart&&(n+=.55,t.push(`VISIBLE`)),R&&e.element===R&&(n+=.35,t.push(`${I?.type}_ELEMENT`)),L&&(n-=.1,t.push(`MONTH_BRANCH_DAMAGED`)),{...e,score:n,reasons:t}}).sort((e,t)=>t.score-e.score),B=a.includes(A),U=z.find(e=>e.visibleInChart),W=R?z.find(e=>e.element===R):null,G=B?A:U?.stem??W?.stem??A,ee=rn(D,G),K=B?`MAIN_EXPOSED`:U?`VISIBLE_HIDDEN`:W?`GROUP_SUPPORTED`:`MAIN_FALLBACK`,{normalized:q,sum:J}=tr(r.total),te=rr(i.tenGods),Y=te[0]??{tenGod:`BI_GYEON`,score:0},ne=fr({config:t,monthBranch:n.month.branch,gyeokStem:G,gyeokTenGod:ee,gyeokMethod:K,monthGyeokCandidates:z,branches:o,hiddenStemPolicy:k,tenGodScoresRanking:te,detectedRelations:s,byType:c}),re=ir(t,n.month.branch),ie=Qn(t,{dayStem:D,monthBranch:n.month.branch,climateScores:re.scores}),ae=ie?{...re,template:ie}:re,oe=or(q),se=ur(t,{pillars:n,stems:a,normalized:q,hiddenStemPolicy:k,damagedBranches:y,byType:c,monthGyeokQuality:ne}),ce=yr(n.year.branch),le=yr(n.day.branch),ue=Cr(n.month.branch),de=n.day.stem===ue.target.stem&&n.day.branch===ue.target.branch,fe={chart:{pillars:{year:{stem:n.year.stem,branch:n.year.branch},month:{stem:n.month.stem,branch:n.month.branch},day:{stem:n.day.stem,branch:n.day.branch},hour:{stem:n.hour.stem,branch:n.hour.branch}},stems:a,branches:o,relations:{detected:s,byType:c,chungBranches:u,haeBranches:d,yukhapBranches:f,paBranches:p,wonjinBranches:m,hyeongBranches:h,damagedBranches:y,damageTypes:v}},dayMaster:{stem:D,element:O},dayMasterRoleByElement:{WOOD:nr(`WOOD`,O),FIRE:nr(`FIRE`,O),EARTH:nr(`EARTH`,O),METAL:nr(`METAL`,O),WATER:nr(`WATER`,O)},month:{branch:n.month.branch,element:H(n.month.branch),seasonGroup:Kn(n.month.branch),mainHiddenStem:A,mainTenGod:j,hiddenStems:N,mainHiddenStemVisible:B,gyeok:{stem:G,tenGod:ee,method:K,support:I,candidates:z,quality:ne}},elements:{total:r.total,totalSum:J,normalized:q,normalizedArr:X.map(e=>q[e])},patterns:{...sr(t,q),transformations:se},tenGodScores:i.tenGods,tenGodScoresRanking:te,tenGodScoresBest:Y,climate:ae,tongguan:oe,strength:hr({config:t,tenGods:i.tenGods,dayMasterStem:n.day.stem,monthBranch:n.month.branch,stems:a,branches:o,hiddenStemPolicy:k,seasonGroup:Kn(n.month.branch)}),shinsal:{twelveSal:{year:ce,day:le},peach:{year:ce.DOHWA,day:le.DOHWA},horse:{year:ce.YEOKMA,day:le.YEOKMA},huagai:{year:ce.HUAGAI,day:le.HUAGAI},jangseong:{year:ce.JANGSEONG,day:le.JANGSEONG},jaesal:{year:ce.JAESAL,day:le.JAESAL},hongluan:{year:br(n.year.branch)},cheonhui:{year:xr(n.year.branch)},gongmang:{day:Sr(n.day)},specialDays:{CHEON_SA:{season:ue.season,targetDayPillar:{stem:ue.target.stem,branch:ue.target.branch},targetDayPillarHanja:ue.targetHanja,active:de,matchedPillars:de?[`month`,`day`]:[`month`]}},relationSal:T,catalog:Pr({config:t,catalog:Tr(t),dayStem:D,pillars:n,chartBranches:o,chartStems:a})},config:{schemaVersion:t.schemaVersion,strategies:t.strategies??{},weights:t.weights??{},extensions:t.extensions??{}}};return cr(t,fe),lr(t,fe),fe}function Ir(e){return e&&typeof e==`object`&&!Array.isArray(e)&&(typeof e.var==`string`||typeof e.op==`string`)}function Lr(e,t){let n=t.split(`.`),r=e;for(let e of n){if(r==null)return;r=r[e]}return r}function Rr(e){return typeof e==`number`?e:typeof e==`boolean`?e?1:0:typeof e==`string`&&e.trim()!==``&&Number.isFinite(Number(e))?Number(e):NaN}function zr(e){return typeof e==`boolean`?e:e==null?!1:typeof e==`number`?e!==0&&!Number.isNaN(e):typeof e==`string`||Array.isArray(e)?e.length>0:!0}function Br(e,t){if(e==null||typeof e==`boolean`||typeof e==`number`||typeof e==`string`)return e;if(Array.isArray(e))return e.map(e=>Br(e,t));if(Ir(e))return Vr(e,t);let n={};for(let[r,i]of Object.entries(e))n[r]=Br(i,t);return n}function Vr(e,t){if(e==null)return null;if(typeof e==`boolean`||typeof e==`number`||typeof e==`string`)return e;if(Array.isArray(e))return e.map(e=>Vr(e,t));if(!Ir(e))return e;if(`var`in e&&typeof e.var==`string`)return Lr(t,e.var);let n=e.op,r=e.args??[],i=e=>Vr(r[e],t);switch(n){case`and`:return r.every((e,t)=>zr(i(t)));case`or`:return r.some((e,t)=>zr(i(t)));case`not`:return!zr(i(0));case`eq`:return i(0)===i(1);case`ne`:return i(0)!==i(1);case`lt`:return Rr(i(0))<Rr(i(1));case`lte`:return Rr(i(0))<=Rr(i(1));case`gt`:return Rr(i(0))>Rr(i(1));case`gte`:return Rr(i(0))>=Rr(i(1));case`in`:{let e=i(0),t=i(1);return Array.isArray(t)?t.includes(e):typeof t==`string`?typeof e==`string`?t.includes(e):!1:t&&typeof t==`object`?Object.prototype.hasOwnProperty.call(t,String(e)):!1}case`overlap`:{let e=i(0),t=i(1);if(!Array.isArray(e)||!Array.isArray(t)||e.length===0||t.length===0)return!1;let n=new Set(t);for(let t of e)if(n.has(t))return!0;return!1}case`intersect`:{let e=i(0),t=i(1);if(!Array.isArray(e)||!Array.isArray(t))return[];let n=new Set(t),r=[],a=new Set;for(let t of e)n.has(t)&&!a.has(t)&&(a.add(t),r.push(t));return r}case`len`:{let e=i(0);return typeof e==`string`||Array.isArray(e)?e.length:e&&typeof e==`object`?Object.keys(e).length:0}case`add`:{let e=0;for(let t=0;t<r.length;t++)e+=Rr(i(t));return e}case`sub`:return Rr(i(0))-Rr(i(1));case`mul`:{let e=1;for(let t=0;t<r.length;t++)e*=Rr(i(t));return e}case`div`:return Rr(i(0))/Rr(i(1));case`neg`:return-Rr(i(0));case`abs`:return Math.abs(Rr(i(0)));case`min`:return Math.min(...r.map((e,t)=>Rr(i(t))));case`max`:return Math.max(...r.map((e,t)=>Rr(i(t))));case`sum`:{let e=i(0);return Array.isArray(e)?e.reduce((e,t)=>e+Rr(t),0):0}case`clamp`:{let e=Rr(i(0)),t=Rr(i(1)),n=Rr(i(2));return Math.min(n,Math.max(t,e))}case`if`:return zr(i(0))?i(1):i(2);default:throw Error(`Unknown DSL op: ${n}`)}}function Hr(e,t,n={}){let r={...n},i=[],a=[],o=[];for(let n of e.rules){if(!(!n.when||zr(Vr(n.when,t))))continue;let e=null;if(n.assert&&(zr(Vr(n.assert,t))||a.push({ruleId:n.id,explain:n.explain})),n.score){e??={ruleId:n.id,explain:n.explain,tags:n.tags};let i={};for(let[e,a]of Object.entries(n.score)){let n=Rr(Vr(a,t));Number.isFinite(n)&&(r[e]=(r[e]??0)+n,i[e]=n)}e.scores=i}if(n.emit!=null){e??={ruleId:n.id,explain:n.explain,tags:n.tags};let r=Br(n.emit,t);i.push(r),e.emit=r}e&&o.push(e)}return{scores:r,emits:i,assertionsFailed:a,matches:o}}function Ur(e){return{var:e}}function Wr(e){return{op:`len`,args:[Ur(e)]}}function Gr(e,t,n=`present`){return t===`count`?Ur(`${e}.count`):t===`lenPresent`?Wr(`${e}.${n}`):1}function Kr(e){return e.map(e=>{let t=`shinsal.relationSal.${e.name}`,n=e.id??`REL_${e.name}`,r=e.scoreKey??`shinsal.${e.name}`;return{id:n,when:{op:`gt`,args:[{op:`len`,args:[Ur(t)]},0]},score:{[r]:{op:`len`,args:[Ur(t)]}},emit:Ur(t),explain:e.explain,tags:e.tags}})}function qr(e){return e.map(e=>({id:e.id,when:{op:`in`,args:[Ur(e.targetVar),Ur(`chart.branches`)]},score:{[`shinsal.${e.name}`]:typeof e.score==`number`?e.score:1},emit:{name:e.name,category:e.category??null,basedOn:e.basedOn,targetBranch:Ur(e.targetVar)},explain:e.explain,tags:e.tags}))}function Jr(e){return e.pillars.map(t=>{let n=`chart.pillars.${t.pillar}.branch`;return{id:t.id,when:{op:`in`,args:[Ur(n),Ur(e.listVar)]},score:{[`shinsal.${e.name}`]:typeof t.score==`number`?t.score:1},emit:{name:e.name,category:t.category??e.category??null,basedOn:t.basedOn??`OTHER`,targetBranch:Ur(n),matchedPillars:[t.pillar],details:{pillar:t.pillar}},explain:t.explain,tags:t.tags}})}function Yr(e,t=`dayStem`){return e.map(e=>{let n=`shinsal.catalog.${t}.${e.key}`,r=e.id??`${t.toUpperCase()}_${e.key}`,i=e.name??e.key,a=typeof e.score==`number`?e.score:Gr(n,e.scoreMode??`const1`,`present`);return{id:r,when:{op:`gt`,args:[Ur(`${n}.count`),0]},score:{[`shinsal.${i}`]:a},emit:{name:i,category:e.category??null,basedOn:`OTHER`,targetBranches:Ur(`${n}.present`),matchedPillars:Ur(`${n}.matchedPillars`)},explain:e.explain,tags:e.tags}})}function Xr(e){return e.map(e=>{let t=`shinsal.catalog.monthBranchStem.${e.key}`,n=e.id??`MONTH_STEM_${e.key}`,r=e.name??e.key,i=typeof e.score==`number`?e.score:Gr(t,e.scoreMode??`count`,`present`),a=e.emitPresentList?{targetStems:Ur(`${t}.present`)}:{targetStem:Ur(`${t}.target`)};return{id:n,when:{op:`gt`,args:[Ur(`${t}.count`),0]},score:{[`shinsal.${r}`]:i},emit:{name:r,category:e.category,basedOn:`MONTH_BRANCH`,matchedPillars:Ur(`${t}.matchedPillars`),...a},explain:e.explain,tags:e.tags}})}function Zr(e){return e.map(e=>{let t=`shinsal.catalog.monthBranchBranch.${e.key}`,n=e.id??`MONTH_BRANCH_${e.key}`,r=e.name??e.key,i=typeof e.score==`number`?e.score:Gr(t,e.scoreMode??`count`,`present`),a=e.emitPresentList?{targetBranches:Ur(`${t}.present`)}:{targetBranch:Ur(`${t}.target`)};return{id:n,when:{op:`gt`,args:[Ur(`${t}.count`),0]},score:{[`shinsal.${r}`]:i},emit:{name:r,category:e.category,basedOn:`MONTH_BRANCH`,matchedPillars:Ur(`${t}.matchedPillars`),...a},explain:e.explain,tags:e.tags}})}function Qr(e){return e.map(e=>{let t=`shinsal.catalog.dayPillar.${e.key}`,n=e.id??`DAY_PILLAR_${e.key}`,r=e.name??e.key;return{id:n,when:{op:`eq`,args:[Ur(`${t}.active`),!0]},score:{[`shinsal.${r}`]:typeof e.score==`number`?e.score:1},emit:{name:r,category:e.category,basedOn:`OTHER`,targetKind:`NONE`,matchedPillars:Ur(`${t}.matchedPillars`)},explain:e.explain,tags:e.tags}})}const $r={id:`yongshin.base`,version:`0.1`,description:`Optional school-specific adjustments for yongshin scoring (base model is math-first).`,rules:[]},ei={id:`gyeokguk.monthGyeokTenGod.quality`,version:`0.4`,description:`Month “gyeok”(透干/会支) ten-god → gyeokguk baseline with quality multiplier (清濁/破格). Includes optional high-level pattern keys (化气/专旺) as continuous signals.`,rules:[{id:`GYEOK_JEONG_GWAN`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`JEONG_GWAN`]},score:{"gyeokguk.JEONG_GWAN":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=정관 → 정관격(기초×품질)`},{id:`GYEOK_PYEON_GWAN`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`PYEON_GWAN`]},score:{"gyeokguk.PYEON_GWAN":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=편관 → 편관격(기초×품질)`},{id:`GYEOK_JEONG_JAE`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`JEONG_JAE`]},score:{"gyeokguk.JEONG_JAE":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=정재 → 정재격(기초×품질)`},{id:`GYEOK_PYEON_JAE`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`PYEON_JAE`]},score:{"gyeokguk.PYEON_JAE":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=편재 → 편재격(기초×품질)`},{id:`GYEOK_SIK_SHIN`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`SIK_SHIN`]},score:{"gyeokguk.SIK_SHIN":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=식신 → 식신격(기초×품질)`},{id:`GYEOK_SANG_GWAN`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`SANG_GWAN`]},score:{"gyeokguk.SANG_GWAN":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=상관 → 상관격(기초×품질)`},{id:`GYEOK_JEONG_IN`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`JEONG_IN`]},score:{"gyeokguk.JEONG_IN":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=정인 → 정인격(기초×품질)`},{id:`GYEOK_PYEON_IN`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`PYEON_IN`]},score:{"gyeokguk.PYEON_IN":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=편인 → 편인격(기초×품질)`},{id:`GYEOK_BI_GYEON`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`BI_GYEON`]},score:{"gyeokguk.BI_GYEON":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=비견 → 비견격(기초×품질)`},{id:`GYEOK_GEOB_JAE`,when:{op:`eq`,args:[{var:`month.gyeok.tenGod`},`GEOB_JAE`]},score:{"gyeokguk.GEOB_JAE":{op:`mul`,args:[1,{var:`month.gyeok.quality.multiplier`}]}},explain:`월지 격=겁재 → 겁재격(기초×품질)`},{id:`GYEOK_HUA_QI`,when:{op:`gte`,args:[{op:`if`,args:[{op:`gt`,args:[{var:`patterns.transformations.best.huaqiFactor`},0]},{var:`patterns.transformations.best.huaqiFactor`},{var:`patterns.transformations.best.effectiveFactor`}]},.6]},score:{"gyeokguk.HUA_QI":{op:`mul`,args:[{op:`if`,args:[{op:`gt`,args:[{var:`patterns.transformations.best.huaqiFactor`},0]},{var:`patterns.transformations.best.huaqiFactor`},{var:`patterns.transformations.best.effectiveFactor`}]},.85]}},explain:`합화(化气) 신호가 강하면 “화기격” 후보를 가산(연속값 factor×0.85)`,tags:[`PATTERN`,`HUA_QI`]},{id:`GYEOK_ZHUAN_WANG`,when:{op:`and`,args:[{op:`gte`,args:[{var:`patterns.elements.oneElement.factor`},.62]},{op:`gte`,args:[{var:`strength.index`},0]}]},score:{"gyeokguk.ZHUAN_WANG":{op:`mul`,args:[{op:`if`,args:[{op:`gt`,args:[{var:`patterns.elements.oneElement.zhuanwangFactor`},0]},{var:`patterns.elements.oneElement.zhuanwangFactor`},{var:`patterns.elements.oneElement.factor`}]},.85]}},explain:`일행득기/专旺(편중) 신호 + 신강(>=0)일 때 “专旺格” 후보를 가산(가능하면 zhuanwangFactor×0.85, 없으면 factor×0.85)`,tags:[`PATTERN`,`ZHUAN_WANG`]},{id:`GYEOK_CONG_GE`,when:{op:`gte`,args:[{var:`patterns.follow.jonggyeokFactor`},.6]},score:{"gyeokguk.CONG_GE":{op:`mul`,args:[{var:`patterns.follow.jonggyeokFactor`},.85]}},explain:`종격/从格(jonggyeok) 신호가 강하면 “从格” 후보를 가산(연속값 factor×0.85)`,tags:[`PATTERN`,`CONG_GE`]},{id:`GYEOK_CONG_CAI`,when:{op:`and`,args:[{op:`gte`,args:[{var:`patterns.follow.jonggyeokFactor`},.6]},{op:`eq`,args:[{var:`patterns.follow.followType`},`CONG_CAI`]}]},score:{"gyeokguk.CONG_CAI":{op:`mul`,args:[{var:`patterns.follow.jonggyeokFactor`},.85]}},explain:`종격 세분(从财): jonggyeokFactor가 강하면 “从财格” 후보를 가산(연속값 factor×0.85)`,tags:[`PATTERN`,`CONG_GE`,`CONG_CAI`]},{id:`GYEOK_CONG_GUAN`,when:{op:`and`,args:[{op:`gte`,args:[{var:`patterns.follow.jonggyeokFactor`},.6]},{op:`eq`,args:[{var:`patterns.follow.followType`},`CONG_GUAN`]}]},score:{"gyeokguk.CONG_GUAN":{op:`mul`,args:[{var:`patterns.follow.jonggyeokFactor`},.85]}},explain:`종격 세분(从官): jonggyeokFactor가 강하면 “从官格” 후보를 가산(연속값 factor×0.85)`,tags:[`PATTERN`,`CONG_GE`,`CONG_GUAN`]},{id:`GYEOK_CONG_SHA`,when:{op:`and`,args:[{op:`gte`,args:[{var:`patterns.follow.jonggyeokFactor`},.6]},{op:`eq`,args:[{var:`patterns.follow.followType`},`CONG_SHA`]}]},score:{"gyeokguk.CONG_SHA":{op:`mul`,args:[{var:`patterns.follow.jonggyeokFactor`},.85]}},explain:`종격 세분(从杀): jonggyeokFactor가 강하면 “从杀格” 후보를 가산(연속값 factor×0.85)`,tags:[`PATTERN`,`CONG_GE`,`CONG_SHA`]},{id:`GYEOK_CONG_ER`,when:{op:`and`,args:[{op:`gte`,args:[{var:`patterns.follow.jonggyeokFactor`},.6]},{op:`eq`,args:[{var:`patterns.follow.followType`},`CONG_ER`]}]},score:{"gyeokguk.CONG_ER":{op:`mul`,args:[{var:`patterns.follow.jonggyeokFactor`},.85]}},explain:`종격 세분(从儿): jonggyeokFactor가 강하면 “从儿格” 후보를 가산(연속값 factor×0.85)`,tags:[`PATTERN`,`CONG_GE`,`CONG_ER`]},{id:`GYEOK_CONG_YIN`,when:{op:`and`,args:[{op:`gte`,args:[{var:`patterns.follow.jonggyeokFactor`},.6]},{op:`eq`,args:[{var:`patterns.follow.followType`},`CONG_YIN`]}]},score:{"gyeokguk.CONG_YIN":{op:`mul`,args:[{var:`patterns.follow.jonggyeokFactor`},.85]}},explain:`종격 세분(从印): jonggyeokFactor가 강하면 “从印格” 후보를 가산(연속값 factor×0.85)`,tags:[`PATTERN`,`CONG_GE`,`CONG_YIN`]},{id:`GYEOK_CONG_BI`,when:{op:`and`,args:[{op:`gte`,args:[{var:`patterns.follow.jonggyeokFactor`},.6]},{op:`eq`,args:[{var:`patterns.follow.followType`},`CONG_BI`]}]},score:{"gyeokguk.CONG_BI":{op:`mul`,args:[{var:`patterns.follow.jonggyeokFactor`},.85]}},explain:`종격 세분(从比): jonggyeokFactor가 강하면 “从比格” 후보를 가산(연속값 factor×0.85)`,tags:[`PATTERN`,`CONG_GE`,`CONG_BI`]}]};var ti={id:`CHEON_JU_GUI_IN_HOUR_BONUS`,when:{op:`and`,args:[{op:`gt`,args:[{var:`shinsal.catalog.dayStem.CHEON_JU_GUI_IN.count`},0]},{op:`in`,args:[`hour`,{var:`shinsal.catalog.dayStem.CHEON_JU_GUI_IN.matchedPillars`}]}]},score:{"shinsal.CHEON_JU_GUI_IN":.5},explain:`천주귀인(天廚)이 시지/시주에서 확인되면 +0.5 보너스(전통적 강조를 반영)`,tags:[`BONUS`]},ni={id:`CHEON_WOL_DEOK`,when:{op:`and`,args:[{op:`or`,args:[{op:`gt`,args:[{var:`shinsal.catalog.monthBranchStem.CHEON_DEOK_GUI_IN_STEM.count`},0]},{op:`gt`,args:[{var:`shinsal.catalog.monthBranchBranch.CHEON_DEOK_GUI_IN_BRANCH.count`},0]}]},{op:`gt`,args:[{var:`shinsal.catalog.monthBranchStem.WOL_DEOK_GUI_IN.count`},0]}]},score:{"shinsal.CHEON_WOL_DEOK":1},emit:{name:`CHEON_WOL_DEOK`,basedOn:`MONTH_BRANCH`,targetKind:`NONE`},explain:`천월덕(天月二德): 천덕 + 월덕이 모두 성립`,tags:[`COMPOSITE`]},ri={id:`CHEON_SA_DAY`,when:{op:`eq`,args:[{var:`shinsal.specialDays.CHEON_SA.active`},!0]},score:{"shinsal.CHEON_SA":1},emit:{name:`CHEON_SA`,basedOn:`MONTH_BRANCH`,targetKind:`NONE`,matchedPillars:{var:`shinsal.specialDays.CHEON_SA.matchedPillars`},details:{season:{var:`shinsal.specialDays.CHEON_SA.season`},targetDayPillarHanja:{var:`shinsal.specialDays.CHEON_SA.targetDayPillarHanja`}}},explain:`천사일(天赦日): 월지 계절에 따라 특정 일주(春戊寅/夏甲午/秋戊申/冬甲子)가 일주와 일치`,tags:[`SPECIAL`]};const ii={id:`shinsal.base.compiled`,version:`0.7`,description:`Default shinsal ruleset compiled from meta-spec (formula-based + catalog-driven + relation-based). Extend via config.extensions.rulesets.shinsal.`,rules:[...Kr([{name:`CHUNG_SAL`,explain:`충살(沖殺): 명식 내 지지 관계에서 정충(沖) 발생(관계 기반).`},{name:`HYEONG_SAL`,explain:`형살(刑殺): 명식 내 지지 관계에서 형(刑/自刑/三刑) 발생(관계 기반).`},{name:`HAE_SAL`,explain:`해살(害殺): 명식 내 지지 관계에서 지해(害) 발생(관계 기반).`},{name:`PA_SAL`,explain:`파살(破殺): 명식 내 지지 관계에서 파(破) 발생(관계 기반).`},{name:`WONJIN_SAL`,explain:`원진살(怨嗔殺): 명식 내 지지 관계에서 원진(怨嗔) 발생(관계 기반).`},{name:`GEOKGAK_SAL`,explain:`격각살(隔角殺): 지지 12순환에서 한 칸 건너 관계(distance=2) 성립(관계 기반).`}]),ri,...qr([`JI_SAL`,`DOHWA`,`WOL_SAL`,`MANG_SHIN_SAL`,`JANGSEONG`,`BAN_AN_SAL`,`YEOKMA`,`YUK_HAE_SAL`,`HUAGAI`,`GEOB_SAL`,`JAESAL`,`CHEON_SAL`].flatMap(e=>[`YEAR_BRANCH`,`DAY_BRANCH`].map(t=>({id:`${e}_FROM_${t===`YEAR_BRANCH`?`YEAR`:`DAY`}`,name:e,basedOn:t,targetVar:`shinsal.twelveSal.${t===`YEAR_BRANCH`?`year`:`day`}.${e}`,explain:`${t===`YEAR_BRANCH`?`년지`:`일지`} 기준 12신살(${e}) 지지가 명식에 존재`}))).concat([{id:`HONG_LUAN_FROM_YEAR`,name:`HONG_LUAN`,basedOn:`YEAR_BRANCH`,targetVar:`shinsal.hongluan.year`,explain:`년지 기준 홍란(紅鸞) 지지가 명식에 존재`},{id:`CHEON_HUI_FROM_YEAR`,name:`CHEON_HUI`,basedOn:`YEAR_BRANCH`,targetVar:`shinsal.cheonhui.year`,explain:`년지 기준 천희(天喜) 지지가 명식에 존재`}])),...Jr({name:`GONGMANG`,listVar:`shinsal.gongmang.day`,pillars:[{pillar:`year`,id:`GONGMANG_YEAR`,explain:`연지가 일주旬空(공망)에 해당`},{pillar:`month`,id:`GONGMANG_MONTH`,explain:`월지가 일주旬空(공망)에 해당`},{pillar:`day`,id:`GONGMANG_DAY`,explain:`일지가 일주旬空(공망)에 해당`},{pillar:`hour`,id:`GONGMANG_HOUR`,explain:`시지가 일주旬空(공망)에 해당`}]}),...Yr([{key:`CHEON_EUL_GUI_IN`,scoreMode:`lenPresent`,explain:`일간(천간) 기준 천을귀인(天乙) 지지가 명식에 존재`},{key:`TAE_GEUK_GUI_IN`,scoreMode:`lenPresent`,explain:`일간(천간) 기준 태극귀인(太極) 지지가 명식에 존재`},{key:`MUN_CHANG_GUI_IN`,scoreMode:`lenPresent`,explain:`일간(천간) 기준 문창귀인(文昌) 지지가 명식에 존재`},{key:`MUN_GOK_GUI_IN`,scoreMode:`lenPresent`,explain:`일간(천간) 기준 문곡귀인(文曲) 지지가 명식에 존재`},{key:`HAK_DANG_GUI_IN`,scoreMode:`lenPresent`,explain:`학당귀인(學堂): 일간의 장생지(십이운성) 지지가 명식에 존재`},{key:`BI_IN_SAL`,scoreMode:`lenPresent`,explain:`비인살(飛刃): 통용 정의=冲羊刃, 일간 기준 대응 지지가 명식에 존재(양인 테이블에서 도출)`},{key:`YANG_IN`,scoreMode:`lenPresent`,explain:`양인(羊刃): 일간 기준 대응 지지가 명식에 존재`},{key:`LOK_SHIN`,scoreMode:`lenPresent`,explain:`록신(祿神): 일간 기준 대응 지지가 명식에 존재`},{key:`GUK_IN_GUI_IN`,scoreMode:`lenPresent`,explain:`국인귀인(國印貴人): 일간 기준 대응 지지가 명식에 존재`},{key:`CHEON_JU_GUI_IN`,scoreMode:`lenPresent`,explain:`천주귀인(天廚): 일간 기준 대응 지지가 명식에 존재`},{key:`CHEON_GWAN_GUI_IN`,scoreMode:`lenPresent`,explain:`천관귀인(天官): 일간 기준 대응 지지가 명식에 존재`},{key:`CHEON_BOK_GUI_IN`,scoreMode:`lenPresent`,explain:`천복귀인(天福): 일간 기준 대응 지지가 명식에 존재`},{key:`BOK_SEONG_GUI_IN`,scoreMode:`lenPresent`,explain:`복성귀인(福星): 일간 기준 대응 지지가 명식에 존재`},{key:`GEUM_YEO_GUI_IN`,scoreMode:`lenPresent`,explain:`금여귀인(金輿): 일간 기준 대응 지지가 명식에 존재`},{key:`HONG_YEOM_SAL`,scoreMode:`lenPresent`,explain:`홍염살(紅艶): 일간 기준 대응 지지가 명식에 존재`}],`dayStem`),ti,...Xr([{key:`WOL_DEOK_GUI_IN`,scoreMode:`count`,explain:`월덕귀인(月德): 월지 삼합국 기준 대상 천간이 명식(년월일시 천간)에 존재`},{key:`WOL_DEOK_HAP`,scoreMode:`count`,explain:`월덕합(月德合): 월덕 귀인의 五合 파트너 천간이 명식에 존재`},{key:`DEOK_SU_GUI_IN`,emitPresentList:!0,scoreMode:`count`,explain:`덕수귀인(德秀): 월지 삼합국 기준 대상 천간(복수)이 명식에 존재`},{key:`CHEON_DEOK_GUI_IN_STEM`,name:`CHEON_DEOK_GUI_IN`,scoreMode:`count`,explain:`천덕귀인(天德): 월지 기준 대상 천간이 명식에 존재(천간판)`},{key:`CHEON_DEOK_HAP`,scoreMode:`count`,explain:`천덕합(天德合): 천덕(천간판)의 五合 파트너 천간이 명식에 존재`}]),...Zr([{key:`CHEON_UI`,scoreMode:`count`,explain:`천의(天醫): 월지 기준 대상 지지가 명식에 존재`},{key:`CHEON_DEOK_GUI_IN_BRANCH`,name:`CHEON_DEOK_GUI_IN`,scoreMode:`count`,explain:`천덕귀인(天德): 월지 기준 대상 지지가 명식에 존재(지지판)`}]),ni,...Qr([{key:`KUI_GANG`,explain:`괴강(魁罡): 일주가 괴강 간지 집합에 해당`},{key:`BAEK_HO`,explain:`백호(白虎大殺): 일주가 백호 간지 집합에 해당`}])]};function ai(e,t){return e.replace(/\{([a-zA-Z0-9_]+)\}/g,(e,n)=>n in t?String(t[n]):`{${n}}`)}function oi(e){let t=e.filter(e=>e!=null);return t.length===0?!0:t.length===1?t[0]:{op:`and`,args:t}}function si(e){if(!e||typeof e!=`object`)return[];let t=[],n=e=>typeof e==`number`&&Number.isFinite(e)?e:null,r=n(e.minMultiplier),i=n(e.minClarity),a=n(e.minIntegrity);return r!=null&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.multiplier`},r]}),i!=null&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.clarity`},i]}),a!=null&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.integrity`},a]}),e.requireQing===!0&&t.push({op:`eq`,args:[{var:`month.gyeok.quality.qingZhuo`},`QING`]}),e.excludeZhuo===!0&&t.push({op:`ne`,args:[{var:`month.gyeok.quality.qingZhuo`},`ZHUO`]}),e.excludeBroken===!0&&t.push({op:`ne`,args:[{var:`month.gyeok.quality.broken`},!0]}),e.excludeMixed===!0&&t.push({op:`ne`,args:[{var:`month.gyeok.quality.mixed`},!0]}),t}var ci={waterFire:`WOOD`,fireMetal:`EARTH`,metalWood:`WATER`,woodEarth:`FIRE`,earthWater:`METAL`};function li(e){let t=[];for(let n of e??[])switch(n.kind){case`roleBoost`:{let e=n.idPrefix??`YONGSHIN_ROLEBOOST`,r=n.explainTemplate??`Role boost: {role} 요소({element}) 보정`,i=n.tags;for(let a of X){let o={op:`eq`,args:[{var:`dayMasterRoleByElement.${a}`},n.role]},s=oi([n.when??null,o].filter(Boolean));t.push({id:`${e}_${n.role}_${a}`,when:s,score:{[`yongshin.${a}`]:n.bonus},explain:ai(r,{role:n.role,element:a}),tags:i})}break}case`monthTenGodRoleBias`:{let e=n.idPrefix??`YONGSHIN_MONTH_ROLEBIAS`,r=n.explainTemplate??`Month({basis}) tenGod bias: {role} 요소({element}) 보정`,i=n.tags,a=n.basis===`gyeok`?`gyeok`:`main`,o=a===`gyeok`?`month.gyeok.tenGod`:`month.mainTenGod`,s={OFFICER:[`JEONG_GWAN`,`PYEON_GWAN`],WEALTH:[`JEONG_JAE`,`PYEON_JAE`],OUTPUT:[`SIK_SHIN`,`SANG_GWAN`],RESOURCE:[`JEONG_IN`,`PYEON_IN`],COMPANION:[`BI_GYEON`,`GEOB_JAE`]},c=n.bonuses??{};for(let[l,u]of Object.entries(s)){let s=c?.[l];if(!(typeof s!=`number`||!Number.isFinite(s)||s===0))for(let c of X){let d={op:`eq`,args:[{var:`dayMasterRoleByElement.${c}`},l]},f={op:`in`,args:[{var:o},u]},p=oi([n.when??null,d,f].filter(Boolean));t.push({id:`${e}_${a}_${l}_${c}`,when:p,score:{[`yongshin.${c}`]:s},explain:ai(r,{basis:a,role:l,element:c}),tags:i})}}break}case`oneElementDominance`:{let e=n.idPrefix??`YONGSHIN_ONEELEMENT`,r=n.explainTemplate??`일행득기/专旺({element}) 신호 → dominant element 보정`,i=n.tags,a=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:.45,o=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:1,s=n.factor===`zhuanwang`||n.factor===`raw`?n.factor:`raw`,c=`patterns.elements.oneElement.factor`,l=`patterns.elements.oneElement.zhuanwangFactor`,u=s===`zhuanwang`?{op:`if`,args:[{op:`gt`,args:[{var:l},0]},{var:l},{var:c}]}:{var:c},d=e=>n.requireDayMasterMatch?{op:`eq`,args:[{var:`dayMaster.element`},e]}:null,f=n.requireIsOneElement?{op:`eq`,args:[{var:`patterns.elements.oneElement.isOneElement`},!0]}:null,p=si(n.monthQuality);for(let s of X){let c=oi([n.when??null,{op:`gte`,args:[u,a]},{op:`eq`,args:[{var:`patterns.elements.oneElement.element`},s]},d(s),f,...p].filter(Boolean));t.push({id:`${e}_${s}`,when:c,score:{[`yongshin.${s}`]:{op:`mul`,args:[u,o]}},explain:ai(r,{element:s}),tags:i})}break}case`transformationsBest`:{let e=n.idPrefix??`YONGSHIN_TRANSFORM`,r=n.explainTemplate??`합화(化气) best(→{element}) 신호 → 변환 오행 보정`,i=n.tags,a=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:.4,o=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:1.2,s=n.factor===`effective`||n.factor===`huaqi`||n.factor===`raw`?n.factor:`raw`,c=s===`huaqi`?`patterns.transformations.best.huaqiFactor`:s===`effective`?`patterns.transformations.best.effectiveFactor`:`patterns.transformations.best.factor`,l=n.requireDayMasterInvolved?{op:`eq`,args:[{var:`patterns.transformations.best.huaqiDetails.flags.dayInvolved`},!0]}:null,u=si(n.monthQuality);for(let s of X){let d=oi([n.when??null,{op:`gte`,args:[{var:c},a]},{op:`eq`,args:[{var:`patterns.transformations.best.resultElement`},s]},l,...u].filter(Boolean));t.push({id:`${e}_${s}`,when:d,score:{[`yongshin.${s}`]:{op:`mul`,args:[{var:c},o]}},explain:ai(r,{element:s,pair:`best`}),tags:i})}break}case`elementByVar`:{let e=n.idPrefix??`YONGSHIN_ELEMBYVAR`,r=n.explainTemplate??`var element({elementVar}) + factor({factorVar}) → {element} 보정`,i=n.tags,a=String(n.elementVar??``).trim(),o=String(n.factorVar??``).trim();if(!a||!o)break;let s=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:0,c=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:1,l=e=>e.replace(/[^a-zA-Z0-9_]/g,`_`).slice(0,60),u=`${e}_${l(a)}_${l(o)}`;for(let e of X){let l=oi([n.when??null,{op:`gte`,args:[{var:o},s]},{op:`eq`,args:[{var:a},e]}].filter(Boolean));t.push({id:`${u}_${e}`,when:l,score:{[`yongshin.${e}`]:{op:`mul`,args:[{var:o},c]}},explain:ai(r,{element:e,elementVar:a,factorVar:o}),tags:i})}break}case`elementBoost`:{let e=n.idPrefix??`YONGSHIN_ELEMENTBOOST`,r=n.explainTemplate??`Element boost: {element} 보정`,i=n.tags;for(let a of n.elements??[])X.includes(a)&&t.push({id:`${e}_${a}`,when:n.when??!0,score:{[`yongshin.${a}`]:n.bonus},explain:ai(r,{element:a}),tags:i});break}case`tongguanBridge`:{let e=n.idPrefix??`YONGSHIN_TONGGUAN`,r=n.explainTemplate??`통관({pair}) 구조 → 브리지 오행({bridge}) 보정`,i=n.tags,a=n.intensityField===`weightedIntensity`?`weightedIntensity`:`intensity`,o=typeof n.minIntensity==`number`&&Number.isFinite(n.minIntensity)?n.minIntensity:.35,s=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:.8,c=typeof n.minIntensityVar==`string`&&n.minIntensityVar.trim()?{var:n.minIntensityVar.trim()}:o,l=typeof n.bonusVar==`string`&&n.bonusVar.trim()?{var:n.bonusVar.trim()}:s,u=n.pairs&&n.pairs.length?n.pairs:[`waterFire`,`fireMetal`,`metalWood`,`woodEarth`,`earthWater`];for(let o of u){let s=ci[o],u=`tongguan.pairs.${o}.${a}`,d=oi([n.when??null,{op:`gte`,args:[{var:u},c]}].filter(Boolean));t.push({id:`${e}_${o}_${s}`,when:d,score:{[`yongshin.${s}`]:{op:`mul`,args:[{var:u},l]}},explain:ai(r,{pair:o,bridge:s}),tags:i})}break}case`followWeakPressure`:{let e=n.idPrefix??`YONGSHIN_FOLLOW_WEAK`,r=n.explainTemplate??`종격/순세(약) 후보 → pressure-role 오행({element}) 추종 보정`,i=n.tags,a=typeof n.weakThreshold==`number`&&Number.isFinite(n.weakThreshold)?n.weakThreshold:-.78,o=typeof n.minDominanceRatio==`number`&&Number.isFinite(n.minDominanceRatio)?n.minDominanceRatio:2.2,s=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:2,c=(n.roles&&n.roles.length?n.roles:[`OUTPUT`,`WEALTH`,`OFFICER`]).slice(),l=oi([{op:`lt`,args:[{var:`strength.index`},a]},{op:`gt`,args:[{op:`div`,args:[{var:`strength.pressure`},{op:`max`,args:[{var:`strength.support`},1e-6]}]},o]},n.when??null].filter(Boolean));for(let n of X){let a=oi([l,{op:`in`,args:[{var:`dayMasterRoleByElement.${n}`},c]}]),o={op:`mul`,args:[{var:`elements.normalized.${n}`},s]};t.push({id:`${e}_${n}`,when:a,score:{[`yongshin.${n}`]:o},explain:ai(r,{element:n}),tags:i})}break}case`followJonggyeok`:{let e=n.idPrefix??`YONGSHIN_FOLLOW_JONGGYEOK`,r=n.explainTemplate??`종격(从格) 패턴({mode}) → {role} 역할 오행({element}) 추종 보정`,i=n.tags,a=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:.55,o=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:1.8,s=n.factor===`raw`||n.factor===`potential`||n.factor===`jonggyeok`?n.factor:`jonggyeok`,c=n.mode===`PRESSURE`||n.mode===`SUPPORT`||n.mode===`ANY`?n.mode:`ANY`,l=n.target===`element`||n.target===`role`?n.target:`role`,u=n.scaleBy===`none`||n.scaleBy===`share`?n.scaleBy:`share`,d={op:`eq`,args:[{var:`patterns.follow.enabled`},!0]},f=`patterns.follow.mode`,p=`patterns.follow.dominantRole`,m=`patterns.follow.potential`,h=`patterns.follow.jonggyeokFactor`,g=s===`raw`?{var:`patterns.follow.potentialRaw`}:s===`potential`?{var:m}:{op:`if`,args:[{op:`gt`,args:[{var:h},0]},{var:h},{var:m}]},_=c===`PRESSURE`?{op:`eq`,args:[{var:f},`PRESSURE`]}:c===`SUPPORT`?{op:`eq`,args:[{var:f},`SUPPORT`]}:{op:`ne`,args:[{var:f},`NONE`]},v=`patterns.follow.followType`,y=Array.isArray(n.types)?n.types:[],b=Array.isArray(n.excludeTypes)?n.excludeTypes:[],x=y.length?{op:`in`,args:[{var:v},y]}:null,S=b.length?{op:`not`,args:[{op:`in`,args:[{var:v},b]}]}:null,C=typeof n.minSubtypeConfidence==`number`&&Number.isFinite(n.minSubtypeConfidence)?n.minSubtypeConfidence:null,w=C==null?null:{op:`gte`,args:[{var:`patterns.follow.followTenGodSplit.confidence`},C]},T=si(n.monthQuality),E=oi([n.when??null,d,_,{op:`gte`,args:[g,a]},x,S,w,...T].filter(Boolean)),D=e=>u===`share`?{var:`elements.normalized.${e}`}:1;if(l===`element`){for(let n of X){let a=oi([E,{op:`eq`,args:[{var:`patterns.follow.dominantElement`},n]}]),s={op:`mul`,args:[g,o,D(n)]};t.push({id:`${e}_ELEMENT_${n}`,when:a,score:{[`yongshin.${n}`]:s},explain:ai(r,{mode:c,role:`dominantElement`,element:n}),tags:i})}break}for(let n of[`COMPANION`,`RESOURCE`,`OUTPUT`,`WEALTH`,`OFFICER`])for(let a of X){let s=oi([E,{op:`eq`,args:[{var:p},n]},{op:`eq`,args:[{var:`dayMasterRoleByElement.${a}`},n]}]),l={op:`mul`,args:[g,o,D(a)]};t.push({id:`${e}_${n}_${a}`,when:s,score:{[`yongshin.${a}`]:l},explain:ai(r,{mode:c,role:n,element:a}),tags:i})}let O=n.includeOtherSupportRole!==!1,k=typeof n.otherSupportScale==`number`&&Number.isFinite(n.otherSupportScale)?n.otherSupportScale:.5,A={op:`eq`,args:[{var:f},`SUPPORT`]};if(O&&(c===`SUPPORT`||c===`ANY`))for(let n of[{dominant:`COMPANION`,other:`RESOURCE`},{dominant:`RESOURCE`,other:`COMPANION`}])for(let a of X){let s=oi([E,A,{op:`eq`,args:[{var:p},n.dominant]},{op:`eq`,args:[{var:`dayMasterRoleByElement.${a}`},n.other]}]),l={op:`mul`,args:[g,o,D(a),k]};t.push({id:`${e}_OTHER_${n.dominant}_TO_${n.other}_${a}`,when:s,score:{[`yongshin.${a}`]:l},explain:ai(r,{mode:c,role:`${n.other}(via ${n.dominant})`,element:a}),tags:i})}break}case`customRules`:t.push(...n.rules??[]);break;default:throw Error(`Unknown yongshin macro kind: ${n.kind}`)}return t}function ui(e,t,n){switch(n){case`prepend`:return[...t,...e];case`replace`:return[...t];default:return[...e,...t]}}function di(e){let t=Array.isArray(e)?e:[e];if(t.length===0)return $r;let n=[],r={id:t[0]?.id??`yongshin.spec`,version:t[0]?.version??`0.1`,description:t[0]?.description},i=!0;for(let e of t){let t=li(e.macros??[]);if(i)n=ui((e.base??`default`)===`default`?$r.rules:[],t,e.mode??`append`),r={id:e.id??r.id,version:e.version??r.version,description:e.description??r.description},i=!1;else{let i=e.mode??`append`;n=ui(n,t,i),e.description&&(r.description=(r.description?`${r.description}\n`:``)+e.description)}}return{id:r.id,version:r.version,description:r.description,rules:n}}function fi(e){return Math.min(1,Math.max(0,e))}function pi(e,t,n){let r=Math.max(.01,typeof n.power==`number`&&Number.isFinite(n.power)?n.power:2),i=fi(typeof n.minKeep==`number`&&Number.isFinite(n.minKeep)?n.minKeep:.2),a=e.length,o={},s={},c={};if(a<=0)return{methods:[...e],power:r,minKeep:i,signals:o,shares:s,multipliers:c};let l=e.map(e=>{let n=fi(t[e]??0);return o[e]=n,n**+r}),u=l.reduce((e,t)=>e+t,0);if(u>1e-9)for(let t=0;t<a;t++){let n=e[t],r=l[t]/u;s[n]=r,c[n]=i+(1-i)*r}else{let t=1/a,n=i+(1-i)*t;for(let r of e)s[r]=t,c[r]=n}return{methods:[...e],power:r,minKeep:i,signals:o,shares:s,multipliers:c}}function mi(e,t){return!(typeof e==`number`&&Number.isFinite(e)&&e>0)||!(typeof t==`number`&&Number.isFinite(t)&&t>1e-12)?1:e/t}var hi={weights:{balance:1,role:1,climate:0,medicine:0,tongguan:0,follow:0,johooTemplate:0,transformations:0,oneElement:0},target:`uniform`,tieBreakOrder:[...X],ruleSet:$r,climate:{enabled:!1,model:Ln},climateUrgency:{enabled:!1,threshold:.6,maxBoost:1,reduceOthers:.25}},gi=new WeakMap;function _i(e){let t=e,n=gi.get(t);if(n)return n;let r=Ti(e);return gi.set(t,r),r}function Q(e,t){return typeof e==`number`&&Number.isFinite(e)?e:t}function vi(e,t){return e===t?`COMPANION`:en(e,t)?`RESOURCE`:en(t,e)?`OUTPUT`:tn(t,e)?`WEALTH`:tn(e,t)?`OFFICER`:`COMPANION`}function yi(e,t,n){return e+(t-e)*n}function bi(e){return Math.min(1,Math.max(0,e))}function xi(e){let t=-1/0;for(let n of Object.values(e))typeof n==`number`&&Number.isFinite(n)&&(t=Math.max(t,n));return Number.isFinite(t)?t:0}function Si(e){let t=e.outputs,n=e.wealth,r=e.officers;return t>=n&&t>=r?`OUTPUT`:n>=t&&n>=r?`WEALTH`:`OFFICER`}function Ci(e){return e.companions>=e.resources?`COMPANION`:`RESOURCE`}function wi(e){let{strengthIndex:t,support:n,pressure:r,weakThreshold:i,strongThreshold:a,minDominanceRatio:o}=e,s=Math.max(1e-9,i+1),c=t<i?bi((i-t)/s):0,l=r/Math.max(1e-9,n),u=bi(c*bi((l-o)/Math.max(1e-9,o))),d=Math.max(1e-9,1-a),f=t>a?bi((t-a)/d):0,p=n/Math.max(1e-9,r),m=bi(f*bi((p-o)/Math.max(1e-9,o)));return m>u?{potential:m,dominanceRatio:p,mode:m>0?`SUPPORT`:`NONE`,weakPotential:u,strongPotential:m,weakDominanceRatio:l,strongDominanceRatio:p}:{potential:u,dominanceRatio:l,mode:u>0?`PRESSURE`:`NONE`,weakPotential:u,strongPotential:m,weakDominanceRatio:l,strongDominanceRatio:p}}function Ti(e){let t=e.strategies?.yongshin??{},n=t.weights??{},r=(()=>{let t=e.extensions?.ruleSpecs?.yongshin;return t?di(t):null})(),i=e.extensions?.rulesets?.yongshin??e.extensions?.rules?.yongshin??r??hi.ruleSet,a=Array.isArray(t.tieBreakOrder)?t.tieBreakOrder.filter(e=>X.includes(e)).concat(X).filter((e,t,n)=>n.indexOf(e)===t):hi.tieBreakOrder,o=t.climate??{},s=typeof o.enabled==`boolean`?o.enabled:hi.climate.enabled,c=Gn(Ln,o.model??o),l=t.climateUrgency??{},u=typeof l.enabled==`boolean`?l.enabled:hi.climateUrgency.enabled,d=Q(l.threshold,hi.climateUrgency.threshold),f=Q(l.maxBoost,hi.climateUrgency.maxBoost),p=Q(l.reduceOthers,hi.climateUrgency.reduceOthers),m=t.follow??{},h=Q(m.weakThreshold,-.78),g=Q(m.strongThreshold,Math.abs(h)),_=Q(m.minDominanceRatio,2.2),v=t.methodSelector??t.selector??{},y={enabled:v?.enabled===!0,climate:{enabled:v?.climate?.enabled!==!1,threshold:Q(v?.climate?.threshold,d),maxBoost:Q(v?.climate?.maxBoost,f),reduceOthers:Q(v?.climate?.reduceOthers,p)},medicine:{enabled:v?.medicine?.enabled!==!1,threshold:Q(v?.medicine?.threshold,.18),maxBoost:Q(v?.medicine?.maxBoost,.9),reduceOthers:Q(v?.medicine?.reduceOthers,.15)},tongguan:{enabled:v?.tongguan?.enabled!==!1,threshold:Q(v?.tongguan?.threshold,.25)},follow:{enabled:v?.follow?.enabled!==!1,threshold:Q(v?.follow?.threshold,.55),weakThreshold:Q(v?.follow?.weakThreshold,h),strongThreshold:Q(v?.follow?.strongThreshold,g),minDominanceRatio:Q(v?.follow?.minDominanceRatio,_)},johooTemplate:{enabled:v?.johooTemplate?.enabled!==!1,scaleBy:v?.johooTemplate?.scaleBy===`always`?`always`:`climate`},transformations:{enabled:v?.transformations?.enabled!==!1,threshold:Q(v?.transformations?.threshold,.55)},oneElement:{enabled:v?.oneElement?.enabled!==!1,threshold:Q(v?.oneElement?.threshold,.62),factor:v?.oneElement?.factor===`raw`?`raw`:`zhuanwang`},competition:{enabled:v?.competition?.enabled===!0,methods:Array.isArray(v?.competition?.methods)?v.competition.methods:[`follow`,`transformations`,`oneElement`],power:Q(v?.competition?.power,2),minKeep:Q(v?.competition?.minKeep,.2),renormalize:v?.competition?.renormalize===!0}};return{...hi,weights:{balance:Q(n.balance,hi.weights.balance),role:Q(n.role,hi.weights.role),climate:Q(n.climate,hi.weights.climate),medicine:Q(n.medicine,hi.weights.medicine),tongguan:Q(n.tongguan,hi.weights.tongguan),follow:Q(n.follow,hi.weights.follow),johooTemplate:Q(n.johooTemplate,hi.weights.johooTemplate),transformations:Q(n.transformations,hi.weights.transformations),oneElement:Q(n.oneElement,hi.weights.oneElement)},ruleSet:i,tieBreakOrder:a,climate:{enabled:s,model:c},climateUrgency:{enabled:u,threshold:d,maxBoost:f,reduceOthers:p},methodSelector:y}}function Ei(){return{WOOD:.2,FIRE:.2,EARTH:.2,METAL:.2,WATER:.2}}function Di(e,t){let n=_i(e),r=(n.target,Ei()),i={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};for(let e of X){let n=r[e]-t.elements.normalized[e];i[e]=Math.max(0,n)}let a=t.strength.index,o=bi((a+1)/2),s={RESOURCE:1,COMPANION:.6,OUTPUT:-.2,WEALTH:-.4,OFFICER:-.4},c={RESOURCE:-.2,COMPANION:-.1,OUTPUT:.8,WEALTH:.6,OFFICER:.6},l={WOOD:{role:`COMPANION`,preference:0},FIRE:{role:`COMPANION`,preference:0},EARTH:{role:`COMPANION`,preference:0},METAL:{role:`COMPANION`,preference:0},WATER:{role:`COMPANION`,preference:0}},u={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0},d=t.climate??{env:{temp:0,moist:0},need:{temp:0,moist:0},scores:{}},f=!!n.climate.enabled,p=f?d.need??{temp:0,moist:0}:{temp:0,moist:0},m=Math.sqrt((p.temp??0)*(p.temp??0)+(p.moist??0)*(p.moist??0)),h={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};for(let e of X){let n=t.elements.normalized[e],i=r[e];h[e]=Math.max(0,n-i)}let g=xi(h),_=bi(g/.8),v={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};for(let e of X){let t=0;for(let n of X)tn(e,n)&&(t+=h[n]);v[e]=t}let y=t.tongguan??{},b=y.pairs??{},x={WOOD:b?.waterFire?.weightedIntensity??b?.waterFire?.intensity??0,EARTH:b?.fireMetal?.weightedIntensity??b?.fireMetal?.intensity??0,WATER:b?.metalWood?.weightedIntensity??b?.metalWood?.intensity??0,FIRE:b?.woodEarth?.weightedIntensity??b?.woodEarth?.intensity??0,METAL:b?.earthWater?.weightedIntensity??b?.earthWater?.intensity??0},S=typeof y.maxIntensity==`number`?y.maxIntensity:xi(x),C=typeof y.effectiveMaxIntensity==`number`?y.effectiveMaxIntensity:S,w=C,T=n.methodSelector??{enabled:!1},E=T?.follow??{enabled:!1,weakThreshold:-.78,strongThreshold:.78,minDominanceRatio:2.2,threshold:.55},D=t.patterns?.follow,O=!!(D&&typeof D==`object`&&D.enabled===!0),k=O?{mode:D.mode??`NONE`,dominanceRatio:typeof D.dominanceRatio==`number`&&Number.isFinite(D.dominanceRatio)?D.dominanceRatio:0,potential:typeof D.potentialRaw==`number`&&Number.isFinite(D.potentialRaw)?D.potentialRaw:0}:wi({strengthIndex:a,support:t.strength.support,pressure:t.strength.pressure,weakThreshold:E.weakThreshold,strongThreshold:typeof E.strongThreshold==`number`?E.strongThreshold:Math.abs(E.weakThreshold),minDominanceRatio:E.minDominanceRatio}),A=t.patterns?.elements?.oneElement,j=typeof A?.factor==`number`&&Number.isFinite(A.factor)?A.factor:0,M=typeof A?.zhuanwangFactor==`number`&&Number.isFinite(A.zhuanwangFactor)?A.zhuanwangFactor:0,N=O?typeof D.oneElementFactor==`number`&&Number.isFinite(D.oneElementFactor)?D.oneElementFactor:0:M>0?M:j,P=O?typeof D.oneElementBoost==`number`&&Number.isFinite(D.oneElementBoost)?D.oneElementBoost:0:typeof E.oneElementBoost==`number`&&Number.isFinite(E.oneElementBoost)?E.oneElementBoost:.35,F=O?typeof D.potential==`number`&&Number.isFinite(D.potential)?D.potential:0:bi(k.potential*(1+N*P)),I=O&&typeof D.jonggyeokConditionFactor==`number`&&Number.isFinite(D.jonggyeokConditionFactor)?D.jonggyeokConditionFactor:void 0,L=O&&typeof D.jonggyeokFactor==`number`&&Number.isFinite(D.jonggyeokFactor)?D.jonggyeokFactor:F,R=O?D.mode??`NONE`:k.mode,z=O&&typeof D.dominantRole==`string`?D.dominantRole:R===`SUPPORT`?Ci(t.strength.components):R===`PRESSURE`?Si(t.strength.components):`COMPANION`,B={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};for(let e of X){let n=vi(e,t.dayMaster.element);R===`SUPPORT`?B[e]=n===z?t.elements.normalized[e]:n===(z===`COMPANION`?`RESOURCE`:`COMPANION`)?.5*t.elements.normalized[e]:0:R===`PRESSURE`?B[e]=n===z?t.elements.normalized[e]:0:B[e]=0}let V=d?.template,H=V?.bonus??{WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0},U=t.patterns?.transformations,W=U&&typeof U==`object`?U.best:null,G=W&&typeof W.huaqiFactor==`number`&&Number.isFinite(W.huaqiFactor)?W.huaqiFactor:W&&typeof W.effectiveFactor==`number`&&Number.isFinite(W.effectiveFactor)?W.effectiveFactor:W&&typeof W.factor==`number`&&Number.isFinite(W.factor)?W.factor:0,ee=W&&typeof W.resultElement==`string`&&X.includes(W.resultElement)?W.resultElement:null,K={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};ee&&(K[ee]=G);let q=A&&typeof A.element==`string`&&X.includes(A.element)?A.element:null,J=T?.oneElement?.factor===`raw`?j:M>0?M:j,te={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};q&&(te[q]=bi(J));let Y={...n.weights},ne,re,ie,ae,oe,se,ce;if(T?.enabled){let e={enabled:!0};if(T?.climate?.enabled&&f&&Y.climate!==0){let t=typeof T.climate.threshold==`number`?T.climate.threshold:.6,n=bi((m-t)/Math.max(1e-9,1-t));if(n>0){let e=typeof T.climate.maxBoost==`number`?T.climate.maxBoost:1,t=typeof T.climate.reduceOthers==`number`?T.climate.reduceOthers:.25;Y.climate*=1+e*n;let r=1-t*n;Y.balance*=r,Y.role*=r,Y.medicine*=r,Y.tongguan*=r,Y.follow*=r,Y.johooTemplate*=r}e.climate={magnitude:m,threshold:t,factor:n}}if(T?.medicine?.enabled&&Y.medicine!==0){let t=typeof T.medicine.threshold==`number`?T.medicine.threshold:.18,n=bi((_-t)/Math.max(1e-9,1-t));if(n>0){let e=typeof T.medicine.maxBoost==`number`?T.medicine.maxBoost:.9,t=typeof T.medicine.reduceOthers==`number`?T.medicine.reduceOthers:.15;Y.medicine*=1+e*n;let r=1-t*n;Y.balance*=r,Y.role*=r,Y.climate*=r,Y.tongguan*=r,Y.follow*=r,Y.johooTemplate*=r}e.medicine={maxExcess:g,maxExcessNormalized:_,threshold:t,factor:n}}if(T?.tongguan?.enabled&&Y.tongguan!==0){let t=typeof T.tongguan.threshold==`number`?T.tongguan.threshold:.25,n=bi((w-t)/Math.max(1e-9,1-t));Y.tongguan*=n,ie={threshold:t,factor:n,maxIntensity:S,effectiveMaxIntensity:C,sumIntensity:typeof y.sumIntensity==`number`?y.sumIntensity:void 0,dominance:typeof y.dominance==`number`?y.dominance:void 0,dispersion:typeof y.dispersion==`number`?y.dispersion:void 0,scores:x},e.tongguan={maxIntensity:S,effectiveMaxIntensity:C,dominance:typeof y.dominance==`number`?y.dominance:void 0,threshold:t,factor:n}}if(T?.follow?.enabled&&Y.follow!==0){let t=typeof T.follow.threshold==`number`?T.follow.threshold:.55,n=bi((L-t)/Math.max(1e-9,1-t)),r=O&&typeof D?.followType==`string`?String(D.followType):void 0,i=O&&typeof D?.followTenGod==`string`?String(D.followTenGod):void 0,a=O&&D?.followTenGodSplit&&typeof D.followTenGodSplit.confidence==`number`?D.followTenGodSplit.confidence:void 0;Y.follow*=n,ae={threshold:t,factor:n,potential:L,potentialRaw:k.potential,potentialBoosted:F,oneElementFactor:N,oneElementBoost:P,jonggyeokConditionFactor:I,dominanceRatio:k.dominanceRatio,mode:k.mode,dominantRole:z,followType:r,followTenGod:i,followSubtypeConfidence:a,scores:B},e.follow={potential:L,potentialRaw:k.potential,potentialBoosted:F,oneElementFactor:N,oneElementBoost:P,jonggyeokConditionFactor:I,dominanceRatio:k.dominanceRatio,mode:k.mode,followType:r,followTenGod:i,followSubtypeConfidence:a,threshold:t,factor:n}}if(T?.johooTemplate?.enabled&&Y.johooTemplate!==0&&V?.enabled){let t=T.johooTemplate.scaleBy===`always`?`always`:`climate`,n=t===`always`?1:e.climate?.factor??0;Y.johooTemplate*=n,oe={factor:n,bonus:H,primary:V.primary,secondary:V.secondary,reasons:V.reasons??[]},e.johooTemplate={factor:n,scaleBy:t}}if(T?.transformations?.enabled&&Y.transformations!==0){let t=typeof T.transformations.threshold==`number`?T.transformations.threshold:.55,n=bi((G-t)/Math.max(1e-9,1-t));Y.transformations*=n,se={threshold:t,factor:n,bestFactor:G,best:ee&&W&&typeof W.pair==`string`?{pair:W.pair,resultElement:ee}:void 0,scores:K},e.transformations={bestFactor:G,threshold:t,factor:n,pair:W&&typeof W.pair==`string`?W.pair:void 0,resultElement:ee??void 0}}if(T?.oneElement?.enabled&&Y.oneElement!==0){let t=typeof T.oneElement.threshold==`number`?T.oneElement.threshold:.62,n=bi(J),r=bi((n-t)/Math.max(1e-9,1-t));Y.oneElement*=r,ce={threshold:t,factor:r,signal:n,element:q??void 0,scores:te},e.oneElement={signal:n,threshold:t,factor:r,element:q??void 0}}let t=T?.competition??{};if(t?.enabled===!0){let n=Q(t.power,2),r=bi(Q(t.minKeep,.2)),i=t.renormalize===!0,a=Array.isArray(t.methods)?t.methods:[`follow`,`transformations`,`oneElement`],o=[];if(a.includes(`follow`)&&Y.follow!==0&&o.push({name:`follow`,signal:bi(L),get:()=>Y.follow,set:e=>{Y.follow=e}}),a.includes(`transformations`)&&Y.transformations!==0&&o.push({name:`transformations`,signal:bi(G),get:()=>Y.transformations,set:e=>{Y.transformations=e}}),a.includes(`oneElement`)&&Y.oneElement!==0&&o.push({name:`oneElement`,signal:bi(J),get:()=>Y.oneElement,set:e=>{Y.oneElement=e}}),o.length>=2){let t={};for(let e of o)t[e.name]=e.signal;let a=pi(o.map(e=>e.name),t,{power:n,minKeep:r}),s=o.reduce((e,t)=>e+Math.abs(t.get()),0),c={};for(let e of o){c[e.name]={before:Math.abs(e.get()),after:0};let t=a.multipliers[e.name]??r;e.set(e.get()*t)}let l=1;if(i&&(l=mi(s,o.reduce((e,t)=>e+Math.abs(t.get()),0)),l!==1))for(let e of o)e.set(e.get()*l);let u=o.reduce((e,t)=>e+Math.abs(t.get()),0);for(let e of o)c[e.name]={before:c[e.name].before,after:Math.abs(e.get())};let d=null,f=-1;for(let e of o){let t=a.shares[e.name]??0;t>f&&(f=t,d=e.name)}let p=d==null?void 0:{method:d,share:a.shares[d]??0,signal:t[d]??0,multiplier:a.multipliers[d]??r};e.competition={enabled:!0,methods:o.map(e=>e.name),activeMethods:o.map(e=>e.name),power:n,minKeep:r,renormalize:i,scale:l,signals:{...t},shares:{...a.shares},multipliers:{...a.multipliers},winner:p,totalBefore:s,totalAfter:u,methodTotals:c}}}re=e}else{let e=n.climateUrgency??{enabled:!1,threshold:.6,maxBoost:1,reduceOthers:.25},t=typeof e.threshold==`number`?e.threshold:.6,r=e.enabled?bi((m-t)/Math.max(1e-9,1-t)):0;if(e.enabled&&r>0){let t=typeof e.maxBoost==`number`?e.maxBoost:1,n=typeof e.reduceOthers==`number`?e.reduceOthers:.25;Y.climate*=1+t*r;let i=1-n*r;Y.balance*=i,Y.role*=i,Y.medicine*=i,Y.tongguan*=i,Y.follow*=i,Y.johooTemplate*=i}ne=e.enabled?{magnitude:m,threshold:t,factor:r}:void 0}for(let e of X){let n=vi(e,t.dayMaster.element),r=yi(s[n],c[n],o);l[e]={role:n,preference:r};let a=Y.balance*i[e],p=Y.role*r,m=f?Y.climate*(d.scores?.[e]??0):0,h=Y.medicine*(v[e]??0),g=Y.tongguan*(x[e]??0),_=Y.follow*(B[e]??0),y=Y.johooTemplate*(H[e]??0),b=Y.transformations*(K[e]??0),S=Y.oneElement*(te[e]??0);u[e]=a+p+m+h+g+_+y+b+S}let le={};for(let e of X)le[`yongshin.${e}`]=u[e];let ue=Hr(n.ruleSet,t,le),de={WOOD:0,FIRE:0,EARTH:0,METAL:0,WATER:0};for(let e of X)de[e]=ue.scores[`yongshin.${e}`]??u[e];let fe=[...X].sort((e,t)=>{let r=de[e],i=de[t];return i===r?n.tieBreakOrder.indexOf(e)-n.tieBreakOrder.indexOf(t):i-r}).map(e=>({element:e,score:de[e]}));return{best:fe[0]?.element??`WOOD`,ranking:fe,scores:de,base:{deficiency:i,role:l,climate:f?{env:{...d.env??{temp:0,moist:0}},need:{...d.need??{temp:0,moist:0}},scores:{...d.scores??{}}}:void 0,medicine:Y.medicine===0?void 0:{excess:h,scores:v},tongguan:ie??(Y.tongguan===0?void 0:{threshold:0,factor:1,maxIntensity:S,effectiveMaxIntensity:C,sumIntensity:typeof y.sumIntensity==`number`?y.sumIntensity:void 0,dominance:typeof y.dominance==`number`?y.dominance:void 0,dispersion:typeof y.dispersion==`number`?y.dispersion:void 0,scores:x}),follow:ae??(Y.follow===0?void 0:{threshold:0,factor:1,potential:L,potentialRaw:k.potential,potentialBoosted:F,oneElementFactor:N,oneElementBoost:P,jonggyeokConditionFactor:I,dominanceRatio:k.dominanceRatio,mode:k.mode,dominantRole:z,scores:B}),johooTemplate:oe??(Y.johooTemplate!==0&&V?.enabled?{factor:1,bonus:H,primary:V.primary,secondary:V.secondary,reasons:V.reasons??[]}:void 0),transformations:se??(Y.transformations===0?void 0:{threshold:0,factor:1,bestFactor:G,best:ee&&W&&typeof W.pair==`string`?{pair:W.pair,resultElement:ee}:void 0,scores:K}),oneElement:ce??(Y.oneElement===0?void 0:{threshold:0,factor:1,signal:bi(J),element:q??void 0,scores:te}),methodSelector:re,effectiveWeights:Y,climateUrgency:ne,strengthIndex:a},rules:{matches:ue.matches,assertionsFailed:ue.assertionsFailed}}}function Oi(e,t){return e.replace(/\{([a-zA-Z0-9_]+)\}/g,(e,n)=>n in t?String(t[n]):`{${n}}`)}function ki(e){let t=e.filter(e=>e!=null);return t.length===0?!0:t.length===1?t[0]:{op:`and`,args:t}}function Ai(e){if(!e||typeof e!=`object`)return null;let t=[];return e.requireNotBroken===!0&&t.push({op:`eq`,args:[{var:`month.gyeok.quality.broken`},!1]}),e.requireNotMixed===!0&&t.push({op:`eq`,args:[{var:`month.gyeok.quality.mixed`},!1]}),typeof e.minMultiplier==`number`&&Number.isFinite(e.minMultiplier)&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.multiplier`},e.minMultiplier]}),typeof e.minIntegrity==`number`&&Number.isFinite(e.minIntegrity)&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.integrity`},e.minIntegrity]}),typeof e.minClarity==`number`&&Number.isFinite(e.minClarity)&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.clarity`},e.minClarity]}),(e.requireQingZhuo===`QING`||e.requireQingZhuo===`ZHUO`)&&t.push({op:`eq`,args:[{var:`month.gyeok.quality.qingZhuo`},e.requireQingZhuo]}),t.length?ki(t):null}function ji(e){if(!e||typeof e!=`object`)return[];let t=[],n=e=>typeof e==`number`&&Number.isFinite(e)?e:null,r=n(e.minMultiplier),i=n(e.minClarity),a=n(e.minIntegrity);return r!=null&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.multiplier`},r]}),i!=null&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.clarity`},i]}),a!=null&&t.push({op:`gte`,args:[{var:`month.gyeok.quality.integrity`},a]}),e.requireQing===!0&&t.push({op:`eq`,args:[{var:`month.gyeok.quality.qingZhuo`},`QING`]}),e.excludeZhuo===!0&&t.push({op:`ne`,args:[{var:`month.gyeok.quality.qingZhuo`},`ZHUO`]}),e.excludeBroken===!0&&t.push({op:`ne`,args:[{var:`month.gyeok.quality.broken`},!0]}),e.excludeMixed===!0&&t.push({op:`ne`,args:[{var:`month.gyeok.quality.mixed`},!0]}),t}var Mi=[`BI_GYEON`,`GEOB_JAE`,`SIK_SHIN`,`SANG_GWAN`,`PYEON_JAE`,`JEONG_JAE`,`PYEON_GWAN`,`JEONG_GWAN`,`PYEON_IN`,`JEONG_IN`];function Ni(e){let t=[];for(let n of e??[])switch(n.kind){case`monthMainTenGod`:{let e=n.idPrefix??`GYEOKGUK_MONTH_MAIN_TENGOD`,r=n.explainTemplate??`월지 본기 십성({tenGod}) → {tenGod}격(보정)`,i=n.tags,a=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:1,o=(n.tenGods&&n.tenGods.length?n.tenGods:Mi).filter(Boolean);for(let s of o){let o={op:`eq`,args:[{var:`month.mainTenGod`},s]};t.push({id:`${e}_${s}`,when:ki([n.when,o]),score:{[`gyeokguk.${s}`]:a},explain:Oi(r,{tenGod:s}),tags:i})}break}case`monthGyeokTenGod`:{let e=n.idPrefix??`GYEOKGUK_MONTH_GYEOK_TENGOD`,r=n.explainTemplate??`월지 투간/회지 십성({tenGod}) → {tenGod}격(보정)`,i=n.tags,a=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:1,o=n.useQualityMultiplier===!0,s=typeof n.qualityMultiplierVar==`string`?n.qualityMultiplierVar:`month.gyeok.quality.multiplier`,c=o?{op:`mul`,args:[a,{var:s}]}:a,l=(n.tenGods&&n.tenGods.length?n.tenGods:Mi).filter(Boolean);for(let a of l){let o={op:`eq`,args:[{var:`month.gyeok.tenGod`},a]};t.push({id:`${e}_${a}`,when:ki([n.when,o]),score:{[`gyeokguk.${a}`]:c},explain:Oi(r,{tenGod:a}),tags:i})}break}case`customRules`:t.push(...n.rules??[]);break;case`oneElementDominance`:{let e=n.idPrefix??`GYEOKGUK_ONEELEMENT`,r=n.explainTemplate??`일행득기/专旺({element}) 신호 → 专旺格 후보({key}) 보정`,i=n.tags,a=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:.62,o=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:.85,s=typeof n.key==`string`&&n.key.trim()?n.key:`gyeokguk.ZHUAN_WANG`,c=n.factor===`zhuanwang`||n.factor===`raw`?n.factor:`raw`,l=`patterns.elements.oneElement.factor`,u=`patterns.elements.oneElement.zhuanwangFactor`,d=c===`zhuanwang`?{op:`if`,args:[{op:`gt`,args:[{var:u},0]},{var:u},{var:l}]}:{var:l},f=[];n.requireIsOneElement===!0&&f.push({op:`eq`,args:[{var:`patterns.elements.oneElement.isOneElement`},!0]}),f.push(...ji(n.monthQuality));{let e=Ai(n.qualityGate);e&&f.push(e)}for(let c of X){let l=ki([n.when,{op:`gte`,args:[d,a]},{op:`eq`,args:[{var:`patterns.elements.oneElement.element`},c]},...n.requireDayMasterMatch===!0?[{op:`eq`,args:[{var:`dayMaster.element`},c]}]:[],...f]);t.push({id:`${e}_${c}`,when:l,score:{[s]:{op:`mul`,args:[d,o]}},explain:Oi(r,{element:c,key:s}),tags:i})}break}case`transformationsBest`:{let e=n.idPrefix??`GYEOKGUK_TRANSFORM`,r=n.explainTemplate??`합화(化气) best 신호 → 化气格 후보({key}) 보정`,i=n.tags,a=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:.6,o=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:.85,s=typeof n.key==`string`&&n.key.trim()?n.key:`gyeokguk.HUA_QI`,c=n.factor===`huaqi`||n.factor===`raw`||n.factor===`effective`?n.factor:`effective`,l=c===`huaqi`?`patterns.transformations.best.huaqiFactor`:c===`raw`?`patterns.transformations.best.factor`:`patterns.transformations.best.effectiveFactor`,u=[];n.requireDayMasterInvolved===!0&&u.push({op:`eq`,args:[{var:`patterns.transformations.best.huaqiDetails.flags.dayInvolved`},!0]}),u.push(...ji(n.monthQuality));{let e=Ai(n.qualityGate);e&&u.push(e)}t.push({id:`${e}_BEST`,when:ki([n.when,{op:`gte`,args:[{var:l},a]},...u]),score:{[s]:{op:`mul`,args:[{var:l},o]}},explain:Oi(r,{key:s}),tags:i});break}case`followJonggyeok`:{let e=n.idPrefix??`GYEOKGUK_FOLLOW`,r=n.explainTemplate??`종격/从格(jonggyeok) 신호 → 从格 후보({key}) 보정`,i=n.tags,a=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:.6,o=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:.85,s=typeof n.key==`string`&&n.key.trim()?n.key:`gyeokguk.CONG_GE`,c=n.factor===`potential`||n.factor===`jonggyeok`?n.factor:`jonggyeok`,l=c===`potential`?`patterns.follow.potential`:`patterns.follow.jonggyeokFactor`,u=n.mode===`PRESSURE`||n.mode===`SUPPORT`||n.mode===`ANY`?n.mode:`ANY`,d=u===`PRESSURE`||u===`SUPPORT`?{op:`eq`,args:[{var:`patterns.follow.mode`},u]}:null,f=[];Array.isArray(n.types)&&n.types.length&&f.push({op:`in`,args:[{var:`patterns.follow.followType`},n.types]}),Array.isArray(n.excludeTypes)&&n.excludeTypes.length&&f.push({op:`not`,args:[{op:`in`,args:[{var:`patterns.follow.followType`},n.excludeTypes]}]}),typeof n.minSubtypeConfidence==`number`&&Number.isFinite(n.minSubtypeConfidence)&&f.push({op:`gte`,args:[{var:`patterns.follow.followTenGodSplit.confidence`},n.minSubtypeConfidence]}),f.push(...ji(n.monthQuality));{let e=Ai(n.qualityGate);e&&f.push(e)}t.push({id:`${e}_${u}_${c}`,when:ki([n.when,d,{op:`gte`,args:[{var:l},a]},...f]),score:{[s]:{op:`mul`,args:[{var:l},o]}},explain:Oi(r,{key:s}),tags:i});break}case`followJonggyeokTyped`:{let e=n.idPrefix??`GYEOKGUK_FOLLOW_TYPED`,r=n.explainTemplate??`종격/从格 type={type} 신호 → 从格 후보({key}) 보정`,i=n.tags,a=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:.6,o=typeof n.bonus==`number`&&Number.isFinite(n.bonus)?n.bonus:.85,s=typeof n.keyPrefix==`string`&&n.keyPrefix.trim()?n.keyPrefix:`gyeokguk.`,c=n.factor===`potential`||n.factor===`jonggyeok`?n.factor:`jonggyeok`,l=c===`potential`?`patterns.follow.potential`:`patterns.follow.jonggyeokFactor`,u=n.mode===`PRESSURE`||n.mode===`SUPPORT`||n.mode===`ANY`?n.mode:`ANY`,d=u===`PRESSURE`||u===`SUPPORT`?{op:`eq`,args:[{var:`patterns.follow.mode`},u]}:null,f=Array.isArray(n.types)?n.types:[],p=f.length?f.filter(e=>e===`CONG_CAI`||e===`CONG_GUAN`||e===`CONG_SHA`||e===`CONG_ER`||e===`CONG_YIN`||e===`CONG_BI`):[`CONG_CAI`,`CONG_GUAN`,`CONG_SHA`,`CONG_ER`,`CONG_YIN`,`CONG_BI`],m=[];typeof n.minSubtypeConfidence==`number`&&Number.isFinite(n.minSubtypeConfidence)&&m.push({op:`gte`,args:[{var:`patterns.follow.followTenGodSplit.confidence`},n.minSubtypeConfidence]}),m.push(...ji(n.monthQuality));{let e=Ai(n.qualityGate);e&&m.push(e)}for(let f of p){let p=`${s}${f}`;t.push({id:`${e}_${f}_${u}_${c}`,when:ki([n.when,d,{op:`eq`,args:[{var:`patterns.follow.followType`},f]},{op:`gte`,args:[{var:l},a]},...m]),score:{[p]:{op:`mul`,args:[{var:l},o]}},explain:Oi(r,{key:p,type:f}),tags:i})}break}case`suppressOtherFrames`:{let e=n.idPrefix??`GYEOKGUK_SUPPRESS`,r=n.explainTemplate??`special-frame suppression: {winner} strong → suppress {key}`,i=n.tags,a=n.winner,o=typeof n.minFactor==`number`&&Number.isFinite(n.minFactor)?n.minFactor:.65,s=typeof n.penalty==`number`&&Number.isFinite(n.penalty)?n.penalty:.6,c=0;if(a===`follow`){let e=n.factor&&n.factor.frame===`follow`?n.factor.sel:null;c={var:(e===`potential`||e===`jonggyeok`?e:`jonggyeok`)===`potential`?`patterns.follow.potential`:`patterns.follow.jonggyeokFactor`}}else if(a===`transformations`){let e=n.factor&&n.factor.frame===`transformations`?n.factor.sel:null,t=e===`huaqi`||e===`raw`||e===`effective`?e:`effective`;c={var:t===`huaqi`?`patterns.transformations.best.huaqiFactor`:t===`raw`?`patterns.transformations.best.factor`:`patterns.transformations.best.effectiveFactor`}}else if(a===`oneElement`){let e=n.factor&&n.factor.frame===`oneElement`?n.factor.sel:null,t=e===`zhuanwang`||e===`raw`?e:`raw`,r=`patterns.elements.oneElement.factor`,i=`patterns.elements.oneElement.zhuanwangFactor`;c=t===`zhuanwang`?{op:`if`,args:[{op:`gt`,args:[{var:i},0]},{var:i},{var:r}]}:{var:r}}let l=ki([n.when,{op:`gte`,args:[c,o]}]),u=n.keyMap??{},d=e=>e===`transformations`?[`gyeokguk.HUA_QI`]:e===`oneElement`?[`gyeokguk.ZHUAN_WANG`]:[`gyeokguk.CONG_CAI`,`gyeokguk.CONG_GUAN`,`gyeokguk.CONG_SHA`,`gyeokguk.CONG_ER`,`gyeokguk.CONG_YIN`,`gyeokguk.CONG_BI`,`gyeokguk.CONG_GE`],f=(Array.isArray(n.targets)?n.targets:[`transformations`,`oneElement`,`follow`]).filter(e=>e===`transformations`||e===`oneElement`||e===`follow`);for(let n of f){if(n===a)continue;let o=Array.isArray(u?.[n])&&u[n].length?u[n]:d(n);for(let u of o)t.push({id:`${e}_${a}_${n}_${String(u).replace(/[^a-zA-Z0-9_]/g,`_`)}`,when:l,score:{[u]:{op:`mul`,args:[c,-s]}},explain:Oi(r,{winner:a,target:n,key:u}),tags:i})}break}case`penalizeKeyWhen`:{let e=n.idPrefix??`GYEOKGUK_PENALIZE`,r=n.explainTemplate??`penalize {key} when condition holds`,i=n.tags,a=typeof n.key==`string`&&n.key.trim()?n.key.trim():``,o=typeof n.penalty==`number`&&Number.isFinite(n.penalty)?n.penalty:0,s=Math.abs(o);if(!a||s<=0)break;let c=typeof n.scaleVar==`string`&&n.scaleVar.trim()?n.scaleVar:null,l=c?{op:`mul`,args:[{var:c},-s]}:-s;t.push({id:`${e}_${String(a).replace(/[^a-zA-Z0-9_]/g,`_`)}`,when:n.when??!0,score:{[a]:l},explain:Oi(r,{key:a}),tags:i});break}default:throw Error(`Unknown gyeokguk macro kind: ${n.kind}`)}return t}function Pi(e,t,n){switch(n){case`prepend`:return[...t,...e];case`replace`:return[...t];default:return[...e,...t]}}function Fi(e){let t=Array.isArray(e)?e:[e];if(t.length===0)return ei;let n=[],r={id:t[0]?.id??`gyeokguk.spec`,version:t[0]?.version??`0.1`,description:t[0]?.description},i=!0;for(let e of t){let t=Ni(e.macros??[]);if(i)n=Pi((e.base??`default`)===`default`?ei.rules:[],t,e.mode??`append`),r={id:e.id??r.id,version:e.version??r.version,description:e.description??r.description},i=!1;else{let i=e.mode??`append`;n=Pi(n,t,i),e.description&&(r.description=(r.description?`${r.description}\n`:``)+e.description)}}return{id:r.id,version:r.version,description:r.description,rules:n}}var Ii={follow:{prefixes:[`gyeokguk.CONG_`]},transformations:{keys:[`gyeokguk.HUA_QI`]},oneElement:{keys:[`gyeokguk.ZHUAN_WANG`]},tenGod:{keys:[`gyeokguk.JEONG_GWAN`,`gyeokguk.PYEON_GWAN`,`gyeokguk.JEONG_JAE`,`gyeokguk.PYEON_JAE`,`gyeokguk.SIK_SHIN`,`gyeokguk.SANG_GWAN`,`gyeokguk.JEONG_IN`,`gyeokguk.PYEON_IN`,`gyeokguk.BI_GYEON`,`gyeokguk.GEOB_JAE`]}},Li={follow:`auto`,transformations:`auto`,oneElement:`auto`,tenGod:`monthQuality`},Ri={ruleSet:ei,tieBreakOrder:[`gyeokguk.JEONG_GWAN`,`gyeokguk.PYEON_GWAN`,`gyeokguk.JEONG_JAE`,`gyeokguk.PYEON_JAE`,`gyeokguk.SIK_SHIN`,`gyeokguk.SANG_GWAN`,`gyeokguk.JEONG_IN`,`gyeokguk.PYEON_IN`,`gyeokguk.BI_GYEON`,`gyeokguk.GEOB_JAE`,`gyeokguk.HUA_QI`,`gyeokguk.ZHUAN_WANG`,`gyeokguk.CONG_CAI`,`gyeokguk.CONG_GUAN`,`gyeokguk.CONG_SHA`,`gyeokguk.CONG_ER`,`gyeokguk.CONG_YIN`,`gyeokguk.CONG_BI`,`gyeokguk.CONG_GE`],competition:{enabled:!1,methods:[`follow`,`transformations`,`oneElement`],power:2,minKeep:.2,renormalize:!0,groups:Ii,signals:{...Li}}},zi=new WeakMap;function Bi(e){let t=e,n=zi.get(t);if(n)return n;let r=ra(e);return zi.set(t,r),r}function Vi(e,t){return typeof e==`number`&&Number.isFinite(e)?e:t}function Hi(e){return Math.min(1,Math.max(0,e))}function Ui(e,t){let n=0;for(let r of t){let t=e[r];typeof t!=`number`||!Number.isFinite(t)||t===0||(n+=Math.abs(t))}return n}function Wi(e,t){let n=e.indexOf(t);return n>=0?n:1e6}function Gi(e,t=`auto`){let n=e.patterns?.transformations?.best,r=n?.huaqiFactor,i=n?.effectiveFactor,a=n?.factor;return t===`raw`?typeof a==`number`&&Number.isFinite(a)&&a>0?Hi(a):0:t===`effective`?typeof i==`number`&&Number.isFinite(i)&&i>0?Hi(i):typeof a==`number`&&Number.isFinite(a)&&a>0?Hi(a):0:typeof r==`number`&&Number.isFinite(r)&&r>0?Hi(r):typeof i==`number`&&Number.isFinite(i)&&i>0?Hi(i):typeof a==`number`&&Number.isFinite(a)&&a>0?Hi(a):0}function Ki(e,t=`auto`){let n=e.patterns?.elements?.oneElement,r=n?.zhuanwangFactor,i=n?.factor;return t===`raw`?typeof i==`number`&&Number.isFinite(i)&&i>0?Hi(i):0:typeof r==`number`&&Number.isFinite(r)&&r>0?Hi(r):typeof i==`number`&&Number.isFinite(i)&&i>0?Hi(i):0}function qi(e,t=`auto`){let n=e.patterns?.follow,r=n?.jonggyeokFactor,i=n?.potential,a=n?.potentialRaw;return t===`raw`?typeof a==`number`&&Number.isFinite(a)&&a>0?Hi(a):0:t===`potential`?typeof i==`number`&&Number.isFinite(i)&&i>0?Hi(i):typeof a==`number`&&Number.isFinite(a)&&a>0?Hi(a):0:typeof r==`number`&&Number.isFinite(r)&&r>0?Hi(r):typeof i==`number`&&Number.isFinite(i)&&i>0?Hi(i):typeof a==`number`&&Number.isFinite(a)&&a>0?Hi(a):0}function Ji(e,t=`monthQuality`){if(typeof t==`number`)return Number.isFinite(t)?Hi(t):.5;if((t===`auto`?`monthQuality`:t)===`monthQuality`){let t=e.month?.gyeok?.quality?.multiplier;return typeof t==`number`&&Number.isFinite(t)?Hi(t):.5}return .5}function Yi(e,t){let n=Array.isArray(e)?e.map(String):t,r=new Set([`follow`,`transformations`,`oneElement`,`tenGod`]);return n.filter(e=>r.has(e))}function Xi(e,t){let n=(e,t)=>Array.isArray(e)?e.map(String).filter(e=>e&&e.trim()):t;return{prefixes:n(e?.prefixes,t.prefixes),keys:n(e?.keys,t.keys),excludePrefixes:n(e?.excludePrefixes,t.excludePrefixes),excludeKeys:n(e?.excludeKeys,t.excludeKeys)}}function Zi(e,t){let n={follow:{...e.follow},transformations:{...e.transformations},oneElement:{...e.oneElement},tenGod:{...e.tenGod}};if(!t||typeof t!=`object`)return n;for(let r of[`follow`,`transformations`,`oneElement`,`tenGod`])r in t&&(n[r]=Xi(t[r],e[r]));return n}function Qi(e,t,n){let r=typeof e==`string`?e:n;return t.has(r)?r:n}function $i(e,t){let n={...e};if(!t||typeof t!=`object`)return n;n.follow=Qi(t.follow,new Set([`auto`,`jonggyeok`,`potential`,`raw`]),typeof n.follow==`string`?n.follow:`auto`),n.transformations=Qi(t.transformations,new Set([`auto`,`huaqi`,`effective`,`raw`]),typeof n.transformations==`string`?n.transformations:`auto`),n.oneElement=Qi(t.oneElement,new Set([`auto`,`zhuanwang`,`raw`]),typeof n.oneElement==`string`?n.oneElement:`auto`);let r=t.tenGod;if(typeof r==`number`)Number.isFinite(r)&&(n.tenGod=Hi(r));else if(typeof r==`string`){let e=typeof n.tenGod==`string`?n.tenGod:`monthQuality`;n.tenGod=Qi(r,new Set([`auto`,`monthQuality`]),e)}return n}function ea(e,t){if(!t||typeof t!=`object`)return e;let n=Zi(Zi(Ii,e.groups??{}),t.groups),r=$i($i(Li,e.signals??{}),t.signals);return{enabled:typeof t.enabled==`boolean`?t.enabled:e.enabled,methods:Yi(t.methods,e.methods),power:Vi(t.power,e.power),minKeep:Vi(t.minKeep,e.minKeep),renormalize:typeof t.renormalize==`boolean`?t.renormalize:e.renormalize,groups:n,signals:r}}function ta(e,t){let n=new Set;for(let r of t.keys??[])r in e&&n.add(r);let r=t.prefixes??[];if(r.length){for(let t of Object.keys(e))for(let e of r)if(t.startsWith(e)){n.add(t);break}}for(let e of t.excludeKeys??[])n.delete(e);let i=t.excludePrefixes??[];if(i.length){for(let e of Array.from(n))for(let t of i)if(e.startsWith(t)){n.delete(e);break}}return Array.from(n).filter(t=>{let n=e[t];return typeof n==`number`&&Number.isFinite(n)&&n!==0})}function na(e,t,n){let r=n.competition;if(!r||r.enabled!==!0)return null;let i=Math.max(.01,Vi(r.power,2)),a=Hi(Vi(r.minKeep,.2)),o=r.renormalize!==!1,s=Yi(r.methods,[`follow`,`transformations`,`oneElement`]);if(s.length<2)return null;let c=Zi(Ii,r.groups??{}),l=$i(Li,r.signals??{}),u={follow:ta(e,c.follow),transformations:ta(e,c.transformations),oneElement:ta(e,c.oneElement),tenGod:ta(e,c.tenGod)},d={follow:Ui(e,u.follow),transformations:Ui(e,u.transformations),oneElement:Ui(e,u.oneElement),tenGod:Ui(e,u.tenGod)},f=s.map(e=>{let n=u[e]??[],r=d[e]??0,i=l[e];return{name:e,keys:n,before:r,signal:e===`follow`?qi(t,i):e===`transformations`?Gi(t,i):e===`oneElement`?Ki(t,i):Ji(t,i)}}).filter(e=>e.before>0&&e.keys.length>0);if(f.length<2)return null;let p=f.reduce((e,t)=>e+t.before,0);if(!(p>0))return null;let m={};for(let e of f)m[e.name]=e.signal;let h=pi(f.map(e=>e.name),m,{power:i,minKeep:a}),g={},_={},v={},y={},b=new Set,x={},S=null,C=-1;for(let e of f){let t=h.shares[e.name]??0;t>C&&(C=t,S=e.name)}for(let t=0;t<f.length;t++){let n=f[t],r=h.shares[n.name]??0,i=h.multipliers[n.name]??a;g[n.name]=n.signal,_[n.name]=r,v[n.name]=i,y[n.name]={before:n.before,after:0};for(let t of n.keys){let n=e[t];typeof n!=`number`||!Number.isFinite(n)||n===0||(b.add(t),t in x||(x[t]=n),e[t]=n*i)}}let w=1;if(o){let t=Ui(e,Array.from(b));if(t>1e-12){w=mi(p,t);for(let t of b){let n=e[t];typeof n!=`number`||!Number.isFinite(n)||n===0||(e[t]=n*w)}}}let T={};for(let t of b)T[t]={before:x[t],after:e[t]};for(let t of f)y[t.name]={before:y[t.name]?.before??t.before,after:Ui(e,t.keys)};let E=Ui(e,Array.from(b)),D={};for(let e of f)D[e.name]=[...e.keys];let O=S?f.find(e=>e.name===S):void 0,k=O?{method:O.name,share:h.shares[O.name]??0,signal:O.signal,multiplier:h.multipliers[O.name]??a,keys:[...O.keys]}:void 0;return{enabled:!0,methods:s,activeMethods:f.map(e=>e.name),power:i,minKeep:a,renormalize:o,scale:w,groups:c,signalSelectors:l,methodKeys:D,signals:g,shares:_,multipliers:v,winner:k,totalBefore:p,totalAfter:E,methodTotals:y,affected:T}}function ra(e){let t=e.strategies?.gyeokguk??{},n=e.extensions?.ruleSpecs?.gyeokguk,r=Array.isArray(n)?n:n?[n]:[],i=n?Fi(n):null,a=e.extensions?.rulesets?.gyeokguk??e.extensions?.rules?.gyeokguk??i??Ri.ruleSet,o=Array.isArray(t.tieBreakOrder)?t.tieBreakOrder:Ri.tieBreakOrder,s={...Ri.competition};for(let e of r){let t=e?.policy?.competition;t&&typeof t==`object`&&(s=ea(s,t))}return s=ea(s,t.competition??{}),{...Ri,ruleSet:a,tieBreakOrder:o,competition:s}}function ia(e,t){let n=Bi(e),r={};for(let e of n.tieBreakOrder)r[e]=0;let i=Hr(n.ruleSet,t,r),a=i.scores,o=na(a,t,n),s=[...Object.entries(a)].filter(([e])=>e.startsWith(`gyeokguk.`)).sort((e,t)=>t[1]===e[1]?Wi(n.tieBreakOrder,e[0])-Wi(n.tieBreakOrder,t[0]):t[1]-e[1]).map(([e,t])=>({key:e,score:t}));return{best:s.length&&s[0].score>0?s[0].key:null,ranking:s,scores:a,competition:o??void 0,basis:{monthMainTenGod:t.month.mainTenGod,monthGyeokTenGod:t.month.gyeok.tenGod,monthGyeokMethod:t.month.gyeok.method,monthGyeokQuality:t.month.gyeok.quality,competition:o??void 0},rules:{matches:i.matches,assertionsFailed:i.assertionsFailed}}}function aa(e,t){return e.replace(/\{([a-zA-Z0-9_]+)\}/g,(e,n)=>n in t?String(t[n]):`{${n}}`)}function oa(e){switch(e){case`year`:return`연`;case`month`:return`월`;case`day`:return`일`;case`hour`:return`시`;default:return e}}function sa(e){let t=e.keys.map(t=>{let n=(e.names&&typeof e.names==`object`?e.names[t]:void 0)??t,r=e.idPrefix?`${e.idPrefix}_${t}`:void 0,i=e.explainTemplate?aa(e.explainTemplate,{key:t,name:n}):void 0;return{key:t,name:n,id:r,scoreMode:e.scoreMode,score:e.score,emitPresentList:e.emitPresentList,explain:i,category:e.category,tags:e.tags}}),n=e.catalog;return n===`dayStem`?Yr(t,`dayStem`):n===`yearStem`?Yr(t,`yearStem`):n===`monthBranchStem`?Xr(t):n===`monthBranchBranch`?Zr(t):n===`dayPillar`?Qr(t.map(e=>({key:e.key,name:e.name,id:e.id,score:e.score,explain:e.explain,category:e.category,tags:e.tags}))):[]}function ca(e){let t=[];for(let n of e)switch(n.kind){case`relationSal`:t.push(...Kr(n.defs));break;case`relationSalKeys`:{let e=n.scoreKeyPrefix??`shinsal.`,r=(n.names??[]).map(t=>({name:t,scoreKey:e.includes(`{name}`)?aa(e,{name:t}):(e.endsWith(`.`),`${e}${t}`),explain:typeof n.explainTemplate==`string`?aa(n.explainTemplate,{name:t}):void 0,tags:n.tags}));t.push(...Kr(r));break}case`branchPresence`:t.push(...qr(n.defs));break;case`twelveSal`:{let e=n.anchors&&n.anchors.length?n.anchors:[`YEAR_BRANCH`,`DAY_BRANCH`],r=n.keys&&n.keys.length?n.keys:[`JI_SAL`,`DOHWA`,`WOL_SAL`,`MANG_SHIN_SAL`,`JANGSEONG`,`BAN_AN_SAL`,`YEOKMA`,`YUK_HAE_SAL`,`HUAGAI`,`GEOB_SAL`,`JAESAL`,`CHEON_SAL`],i=n.nameMode??`key`,a=e.flatMap(e=>{let t=e===`YEAR_BRANCH`?`YEAR`:`DAY`,a=t.toLowerCase();return r.map(r=>({id:`TWELVE_SAL_${t}_${r}`,name:i===`anchored`?`TWELVE_SAL_${t}_${r}`:r,basedOn:e,targetVar:`shinsal.twelveSal.${a}.${r}`,explain:`${t===`YEAR`?`년지`:`일지`} 기준 12신살(${r}) 타깃 지지가 명식에 존재`,score:n.score,category:n.category??`TWELVE_SAL`,tags:n.tags}))});t.push(...qr(a));break}case`gongmangPillars`:{let e=n.name??`GONGMANG`,r=n.listVar??`shinsal.gongmang.day`,i=n.pillars&&n.pillars.length?n.pillars:[`year`,`month`,`day`,`hour`],a=typeof n.score==`number`?n.score:void 0,o=e=>`${oa(e)}지가 일주旬空(공망)에 해당`,s={name:e,listVar:r,pillars:i.map(t=>({pillar:t,id:`${e.toUpperCase()}_${String(t).toUpperCase()}`,explain:n.explainTemplate?aa(n.explainTemplate,{pillar:String(t),label:oa(String(t))}):o(String(t)),score:a,category:n.category,tags:n.tags})),category:n.category};t.push(...Jr(s));break}case`pillarBranchInList`:t.push(...Jr(n.args));break;case`catalogDayStem`:t.push(...Yr(n.defs,n.which??`dayStem`));break;case`catalogMonthBranchStem`:t.push(...Xr(n.defs));break;case`catalogMonthBranchBranch`:t.push(...Zr(n.defs));break;case`catalogDayPillar`:t.push(...Qr(n.defs));break;case`catalogKeys`:t.push(...sa(n));break;case`customRules`:t.push(...n.rules??[]);break;default:throw Error(`Unknown shinsal macro kind: ${n.kind}`)}return t}function la(e,t,n){switch(n){case`prepend`:return[...t,...e];case`replace`:return[...t];default:return[...e,...t]}}function ua(e){let t=Array.isArray(e)?e:[e];if(t.length===0)return ii;let n=[],r={id:t[0]?.id??`shinsal.spec`,version:t[0]?.version??`0.1`,description:t[0]?.description},i=!0;for(let e of t){let t=ca(e.macros??[]);if(i)n=la((e.base??`default`)===`default`?ii.rules:[],t,e.mode??`append`),r={id:e.id??r.id,version:e.version??r.version,description:e.description??r.description},i=!1;else{let i=e.mode??`append`;n=la(n,t,i),e.description&&(r.description=(r.description?`${r.description}\n`:``)+e.description)}}return{id:r.id,version:r.version,description:r.description,rules:n}}const da={id:`shinsal.conditions.base`,version:`0.1`,description:`Generic shinsal attenuation rules (충/해/파/원진/형/공망). Override via config.extensions.rulesets.shinsalConditions.`,rules:[{id:`COND_CHUNG`,when:{op:`overlap`,args:[{var:`det.targetBranches`},{var:`chart.relations.chungBranches`}]},score:{"cond.penalty.CHUNG":{var:`policy.shinsal.conditions.weights.CHUNG`}},explain:`타깃 지지가 정충(沖)에 걸리면 신살 효력이 약화될 수 있음(가중치로 반영).`,tags:[`COND`,`CHUNG`]},{id:`COND_HAE`,when:{op:`overlap`,args:[{var:`det.targetBranches`},{var:`chart.relations.haeBranches`}]},score:{"cond.penalty.HAE":{var:`policy.shinsal.conditions.weights.HAE`}},explain:`타깃 지지가 지해(害)에 걸리면 약화(가중치).`,tags:[`COND`,`HAE`]},{id:`COND_PA`,when:{op:`overlap`,args:[{var:`det.targetBranches`},{var:`chart.relations.paBranches`}]},score:{"cond.penalty.PA":{var:`policy.shinsal.conditions.weights.PA`}},explain:`타깃 지지가 파(破)에 걸리면 약화(가중치).`,tags:[`COND`,`PA`]},{id:`COND_WONJIN`,when:{op:`overlap`,args:[{var:`det.targetBranches`},{var:`chart.relations.wonjinBranches`}]},score:{"cond.penalty.WONJIN":{var:`policy.shinsal.conditions.weights.WONJIN`}},explain:`타깃 지지가 원진(怨嗔)에 걸리면 약화(가중치).`,tags:[`COND`,`WONJIN`]},{id:`COND_HYEONG`,when:{op:`overlap`,args:[{var:`det.targetBranches`},{var:`chart.relations.hyeongBranches`}]},score:{"cond.penalty.HYEONG":{var:`policy.shinsal.conditions.weights.HYEONG`}},explain:`타깃 지지가 형(刑/自刑/三刑)에 걸리면 약화(가중치).`,tags:[`COND`,`HYEONG`]},{id:`COND_GONGMANG`,when:{op:`overlap`,args:[{var:`det.targetBranches`},{var:`shinsal.gongmang.day`}]},score:{"cond.penalty.GONGMANG":{var:`policy.shinsal.conditions.weights.GONGMANG`}},explain:`타깃 지지가 일주旬空(공망)에 해당하면 약화(가중치).`,tags:[`COND`,`GONGMANG`]}]};function fa(e){if(!e)return;let t=[],n=new Set;for(let r of e){let e=String(r).trim();e&&(n.has(e)||(n.add(e),t.push(e)))}return t.length?t:void 0}function pa(e,t){return e.replace(/\{([a-zA-Z0-9_]+)\}/g,(e,n)=>n in t?String(t[n]):`{${n}}`)}function ma(e){switch(e){case`CHUNG`:return`타깃 지지가 정충(沖)에 걸리면 신살 효력이 약화될 수 있음(가중치로 반영).`;case`HAE`:return`타깃 지지가 지해(害)에 걸리면 약화(가중치).`;case`PA`:return`타깃 지지가 파(破)에 걸리면 약화(가중치).`;case`WONJIN`:return`타깃 지지가 원진(怨嗔)에 걸리면 약화(가중치).`;case`HYEONG`:return`타깃 지지가 형(刑/自刑/三刑)에 걸리면 약화(가중치).`;case`GONGMANG`:return`타깃 지지가 일주旬空(공망)에 해당하면 약화(가중치).`;default:return`신살 조건(약화) 가중치.`}}function ha(e){switch(e){case`CHUNG`:return`chart.relations.chungBranches`;case`HAE`:return`chart.relations.haeBranches`;case`PA`:return`chart.relations.paBranches`;case`WONJIN`:return`chart.relations.wonjinBranches`;case`HYEONG`:return`chart.relations.hyeongBranches`;case`GONGMANG`:return`shinsal.gongmang.day`;default:return`chart.relations.damagedBranches`}}function ga(e,t){let n=t.idPrefix?String(t.idPrefix).trim():``,r=n?`${n}_${e}`:`COND_${e}`,i=t.explainTemplate?pa(t.explainTemplate,{key:e}):ma(e),a=fa([`COND`,e,...t.tags??[]]);return{id:r,when:{op:`overlap`,args:[{var:`det.targetBranches`},{var:ha(e)}]},score:{[`cond.penalty.${e}`]:{var:`policy.shinsal.conditions.weights.${e}`}},explain:i,tags:a}}function _a(e){let t=[];for(let n of e??[])switch(n.kind){case`standardDamagePenalties`:{let e=n.keys&&n.keys.length?n.keys:[`CHUNG`,`HAE`,`PA`,`WONJIN`,`HYEONG`,`GONGMANG`];for(let r of e)t.push(ga(r,{idPrefix:n.idPrefix,tags:n.tags}));break}case`customRules`:t.push(...n.rules??[]);break;default:throw Error(`Unknown shinsalConditions macro kind: ${n.kind}`)}return t}function va(e,t,n){switch(n){case`prepend`:return[...t,...e];case`replace`:return[...t];default:return[...e,...t]}}function ya(e){let t=Array.isArray(e)?e:[e];if(t.length===0)return da;let n=[],r={id:t[0]?.id??`shinsalConditions.spec`,version:t[0]?.version??`0.1`,description:t[0]?.description},i=!0;for(let e of t){let t=_a(e.macros??[]);if(i)n=va((e.base??`default`)===`default`?da.rules:[],t,e.mode??`append`),r={id:e.id??r.id,version:e.version??r.version,description:e.description??r.description},i=!1;else{let i=e.mode??`append`;n=va(n,t,i),e.description&&(r.description=(r.description?`${r.description}\n`:``)+e.description)}}return{id:r.id,version:r.version,description:r.description,rules:n}}const ba={enabled:!0,applyToNames:[],categories:{RELATION_SAL:{enabled:!1},VOID:{enabled:!1}},weights:{CHUNG:.5,HAE:.5,PA:.5,WONJIN:.5,HYEONG:.5,GONGMANG:.5},combine:`max`,weakThreshold:1,invalidateThreshold:0,excludeNames:[`CHUNG_SAL`,`HYEONG_SAL`,`HAE_SAL`,`PA_SAL`,`WONJIN_SAL`,`GONGMANG_SAL`,`GONGMANG`]};var xa={ruleSet:ii,conditionsRuleSet:da,qualityModel:ba},Sa=new WeakMap;function Ca(e){let t=e,n=Sa.get(t);if(n)return n;let r=wa(e);return Sa.set(t,r),r}function wa(e){let t=(()=>{let t=e.extensions?.ruleSpecs?.shinsal;return t?ua(t):null})();return{ruleSet:e.extensions?.rulesets?.shinsal??e.extensions?.rules?.shinsal??t??xa.ruleSet,conditionsRuleSet:e.extensions?.rulesets?.shinsalConditions??e.extensions?.rules?.shinsalConditions??(()=>{let t=e.extensions?.ruleSpecs?.shinsalConditions;return t?ya(t):null})()??xa.conditionsRuleSet,qualityModel:Aa(e)}}function Ta(e){return e===`YEAR_BRANCH`||e===`DAY_BRANCH`||e===`MONTH_BRANCH`?e:`OTHER`}function Ea(e){if(!Array.isArray(e))return;let t=new Set([`year`,`month`,`day`,`hour`]),n=e.filter(e=>typeof e==`string`&&t.has(e));return n.length?n:void 0}function Da(e){return e===`FULL`||e===`WEAK`?e:void 0}function Oa(e){if(!e||typeof e!=`object`)return[];if(Array.isArray(e))return e.flatMap(e=>Oa(e));let t=e;if(typeof t.name!=`string`)return[];let n=Ta(t.basedOn),r=Ea(t.matchedPillars),i=Da(t.quality),a=typeof t.qualityWeight==`number`&&Number.isFinite(t.qualityWeight)?t.qualityWeight:void 0,o=typeof t.category==`string`&&t.category.length>0?t.category:void 0,s={name:t.name,category:o,basedOn:n,targetKind:`NONE`,matchedPillars:r,quality:i,qualityWeight:a};if(t.targetKind===`NONE`||t.noTarget===!0){let e={...s,targetKind:`NONE`};return Array.isArray(t.targetBranches)&&(e.targetBranches=t.targetBranches.filter(e=>typeof e==`number`)),Array.isArray(t.targetStems)&&(e.targetStems=t.targetStems.filter(e=>typeof e==`number`)),t.details!=null&&(e.details=t.details),[e]}if(typeof t.targetStem==`number`){let e={...s,targetKind:`STEM`,targetStem:t.targetStem};return t.details!=null&&(e.details=t.details),[e]}if(Array.isArray(t.targetStems)){let e=t.targetStems.filter(e=>typeof e==`number`);return e.map(n=>{let r={...s,targetKind:`STEM`,targetStem:n,targetStems:e};return t.details!=null&&(r.details=t.details),r})}if(typeof t.targetBranch==`number`){let e={...s,targetKind:`BRANCH`,targetBranch:t.targetBranch};return t.details!=null&&(e.details=t.details),[e]}if(Array.isArray(t.targetBranches)){let e=t.targetBranches.filter(e=>typeof e==`number`);return e.map(n=>{let r={...s,targetKind:`BRANCH`,targetBranch:n,targetBranches:e};return t.details!=null&&(r.details=t.details),r})}return[]}function ka(e){let t=e.strategies?.shinsal?.weakQualityWeight??e.strategies?.shinsal?.weakWeight,n=typeof t==`number`?t:.5;return Number.isFinite(n)?Math.min(1,Math.max(0,n)):.5}function Aa(e){let t={...ba,weights:{...ba.weights},applyToNames:[...ba.applyToNames],excludeNames:[...ba.excludeNames]},n=e.strategies?.shinsal?.conditions;if(n&&typeof n==`object`){let e=n.enabled;typeof e==`boolean`&&(t.enabled=e);let r=n.combine;(r===`max`||r===`sum`||r===`prob`)&&(t.combine=r);let i=n.weights;if(i&&typeof i==`object`)for(let e of Object.keys(t.weights)){let n=i[e];typeof n==`number`&&Number.isFinite(n)&&(t.weights[e]=Math.min(1,Math.max(0,n)))}let a=n.weakThreshold;typeof a==`number`&&Number.isFinite(a)&&(t.weakThreshold=Math.min(1,Math.max(0,a)));let o=n.invalidateThreshold;typeof o==`number`&&Number.isFinite(o)&&(t.invalidateThreshold=Math.min(1,Math.max(0,o)));let s=n.applyToNames??n.applyTo??n.onlyNames;Array.isArray(s)&&(t.applyToNames=s.map(String));let c=n.excludeNames??n.exclude??n.excludeShinsal;return Array.isArray(c)&&(t.excludeNames=c.map(String)),t}let r=ka(e),i=Math.min(1,Math.max(0,1-r));for(let e of Object.keys(t.weights))t.weights[e]=i;return t.combine=`max`,t.weakThreshold=1,t.invalidateThreshold=0,t}function ja(e){return Number.isFinite(e)?Math.min(1,Math.max(0,e)):0}function Ma(e,t){if(!e||e.length===0)return 0;if(t===`max`)return ja(Math.max(...e.map(ja)));if(t===`sum`)return ja(e.reduce((e,t)=>e+ja(t),0));let n=1;for(let t of e)n*=1-ja(t);return ja(1-n)}function Na(e){return e.targetKind===`NONE`?1:e.matchedPillars&&e.matchedPillars.length>0?e.matchedPillars.length:1}function Pa(e,t){if(Array.isArray(t.targetBranches)&&t.targetBranches.length){let e=t.targetBranches.filter(e=>typeof e==`number`);return Array.from(new Set(e))}if(t.targetKind===`BRANCH`&&typeof t.targetBranch==`number`)return[t.targetBranch];if(Array.isArray(t.matchedPillars)&&t.matchedPillars.length){let n=[];for(let r of t.matchedPillars){let t=e.chart.pillars?.[r]?.branch;typeof t==`number`&&n.push(t)}return Array.from(new Set(n))}return[]}function Fa(e,t){let n=[],r=e.chart.pillars;return r.year.branch===t&&n.push(`year`),r.month.branch===t&&n.push(`month`),r.day.branch===t&&n.push(`day`),r.hour.branch===t&&n.push(`hour`),n}function Ia(e,t){let n=[],r=e.chart.pillars;return r.year.stem===t&&n.push(`year`),r.month.stem===t&&n.push(`month`),r.day.stem===t&&n.push(`day`),r.hour.stem===t&&n.push(`hour`),n}function La(e,t){return t.map(t=>t.targetKind===`BRANCH`&&typeof t.targetBranch==`number`?{...t,matchedPillars:Fa(e,t.targetBranch)}:t.targetKind===`STEM`&&typeof t.targetStem==`number`?{...t,matchedPillars:Ia(e,t.targetStem)}:t)}function Ra(e){let{facts:t,policy:n,detections:r}=e,i=n.qualityModel,a=new Set(i.excludeNames??[]),o={},s=[];for(let e=0;e<r.length;e++){let c=r[e],l=[],u=0,d=[],f=typeof c.qualityWeight==`number`?ja(c.qualityWeight):1,p=!1,m=[],h=[],g={};if(typeof c.qualityWeight!=`number`&&!a.has(c.name)){let e=Pa(t,c),r={name:c.name,basedOn:c.basedOn,targetKind:c.targetKind,targetBranch:c.targetBranch,targetStem:c.targetStem,targetBranches:e,matchedPillars:c.matchedPillars},a={...t,det:r,policy:{shinsal:{conditions:{weights:i.weights,combine:i.combine,weakThreshold:i.weakThreshold,invalidateThreshold:i.invalidateThreshold}}}},o=Hr(n.conditionsRuleSet,a,{});m=o.matches,h=o.assertionsFailed,g=o.scores;for(let[e,t]of Object.entries(o.scores)){if(!e.startsWith(`cond.penalty.`))continue;let n=e.slice(13);if(n===`CHUNG`||n===`HAE`||n===`PA`||n===`WONJIN`||n===`HYEONG`||n===`GONGMANG`){let e=typeof t==`number`?t:Number(t);Number.isFinite(e)&&e!==0&&l.push({key:n,value:e})}}d=l.map(e=>e.key),u=Ma(l.map(e=>e.value),i.combine),f=ja(1-u),p=f<=(i.invalidateThreshold??0)}let _=i.weakThreshold??1,v=f<_?`WEAK`:`FULL`,y=i.invalidateThreshold??0;p||=f<=y,c={...c,targetBranches:Pa(t,c),quality:v,qualityWeight:f,invalidated:p,active:!p,qualityReasons:d.length?d:void 0,conditionPenalty:u||void 0};let b=Na(c),x=`shinsal.${c.name}`,S=b*f;o[x]=(o[x]??0)+S,a.has(c.name)||s.push({detectionIndex:e,detection:{name:c.name,targetKind:c.targetKind,targetBranch:c.targetBranch,targetStem:c.targetStem,targetBranches:c.targetBranches,matchedPillars:c.matchedPillars},scores:g,penaltyParts:l,combinedPenalty:u,qualityWeight:f,qualityReasons:d,invalidated:p,matches:m,assertionsFailed:h}),r[e]=c}return{detections:r,scoresAdjusted:o,conditionsTrace:s}}function za(e,t){let n=Ca(e),r=Hr(n.ruleSet,t,{}),{detections:i,scoresAdjusted:a,conditionsTrace:o}=Ra({facts:t,policy:n,detections:La(t,r.emits.flatMap(Oa))});return{detections:i,scores:r.scores,scoresAdjusted:a,rules:{matches:r.matches,assertionsFailed:r.assertionsFailed,conditions:o}}}function $(e){return e}function Ba(e,t,n,r){return{year:e,month:t,day:n,hour:r}}function Va(e){let t=e?.lifeStages??e?.lifeStage??{},n=t.earthRule??`FOLLOW_FIRE`;return{earthRule:n===`FOLLOW_WATER`||n===`INDEPENDENT`||n===`FOLLOW_FIRE`?n:`FOLLOW_FIRE`,yinReversalEnabled:t.yinReversalEnabled??!0}}function Ha(){let e=[];e.push($({id:`time.localDateTime`,deps:[],explain:`ISO instant에서 추출한 로컬 날짜/시각(오프셋 포함).`,compute:e=>e.parsed.localDateTime})),e.push($({id:`time.utcMs`,deps:[],explain:`ISO instant를 UTC 기준 epoch milliseconds로 변환한 값.`,compute:e=>e.parsed.utcMs})),e.push($({id:`policy.calendar`,deps:[],explain:`config.calendar 정책`,compute:e=>e.config.calendar})),e.push($({id:`time.trueSolarCorrection`,deps:[`time.utcMs`,`time.localDateTime`,`policy.calendar`],formula:`Δ(min) = 4*(lon-stdMeridian) + EoT`,explain:`진태양시 보정(경도 보정 + 균시차). location.lon이 없으면 적용하지 않는다.`,compute:(e,t)=>{let n=t(`time.utcMs`),r=t(`time.localDateTime`),i=t(`policy.calendar`);return lt({utcMs:n,offsetMinutes:r.offsetMinutes,location:e.request.location,policy:i.trueSolarTime})}})),e.push($({id:`time.solarLocalDateTime`,deps:[`time.localDateTime`,`time.trueSolarCorrection`],explain:`진태양시 보정이 적용된 “태양시” 로컬 dateTime(표시/경계 판정용).`,compute:(e,t)=>{let n=t(`time.localDateTime`),r=t(`time.trueSolarCorrection`),i=r.totalCorrectionMinutes??0;return!r.applied||!Number.isFinite(i)||i===0?n:ut(n,i)}})),e.push($({id:`time.localDateTimeForDay`,deps:[`time.localDateTime`,`time.solarLocalDateTime`,`policy.calendar`],explain:`일주/일경계 계산에 사용할 로컬 dateTime(trueSolarTime.applyTo 정책 반영).`,compute:(e,t)=>{let n=t(`time.localDateTime`),r=t(`time.solarLocalDateTime`),i=t(`policy.calendar`).trueSolarTime,a=i?.applyTo??`hourOnly`;return i?.enabled&&a===`dayAndHour`?r:n}})),e.push($({id:`time.localDateTimeForHour`,deps:[`time.localDateTime`,`time.solarLocalDateTime`,`policy.calendar`],explain:`시주/시지 경계 판정에 사용할 로컬 dateTime(trueSolarTime.enabled 반영).`,compute:(e,t)=>{let n=t(`time.localDateTime`),r=t(`time.solarLocalDateTime`),i=t(`policy.calendar`).trueSolarTime,a=i?.applyTo??`hourOnly`;return i?.enabled&&(a===`hourOnly`||a===`dayAndHour`)?r:n}})),e.push($({id:`calendar.jieBoundariesAround`,deps:[`calendar.solarTermsAround`],explain:`월/연 경계 계산용 12절(節) 시각(UTC). 24절기 결과에서 “절(節)”만 필터링한 목록(baseYear±1 포함).`,compute:(e,t)=>{let n=t(`calendar.solarTermsAround`);return n?{baseYear:n.baseYear,method:n.method,terms:n.terms.filter(e=>Ae(e.id))}:null}})),e.push($({id:`calendar.solarTermsAround`,deps:[`time.localDateTime`,`policy.calendar`],explain:`24절기(정기) 시각(UTC) — baseYear±1을 포함한 정렬된 목록. (절입/진단/확장 기능에서 재사용)`,compute:(e,t)=>{let n=t(`time.localDateTime`),r=t(`policy.calendar`);if(!(r.monthBoundary===`jieqi`||r.yearBoundary===`liChun`||r?.solarTerms?.alwaysCompute))return null;let i=r.solarTerms?.method===`approx`?`approx`:`meeus`;return Be(n.date.y,i)}})),e.push($({id:`policy.weights`,deps:[],explain:`config.weights(가중치/스코어링 정책).`,compute:e=>e.config.weights??{}})),e.push($({id:`policy.lifeStages`,deps:[],explain:`config.strategies.lifeStages(십이운성 규칙) — earthRule + yinReversalEnabled.`,compute:e=>Va(e.config.strategies)})),e.push($({id:`policy.fortune`,deps:[],explain:`config.strategies.fortune(대운/세운 정책).`,compute:e=>mn(e.config)})),e.push($({id:`policy.rules`,deps:[],explain:`config.strategies/extensions (DSL rule engine inputs).`,compute:e=>({strategies:e.config.strategies??{},extensions:e.config.extensions??{}})})),e.push($({id:`pillars.day`,deps:[`time.localDateTimeForDay`,`policy.calendar`],formula:`ganzhiIdx = (JDN + 49) mod 60`,explain:`정책(dayBoundary)을 적용한 기준 일자로 JDN을 계산하고 60갑자를 얻는다.`,compute:(e,t)=>Qe(Ze(t(`time.localDateTimeForDay`),t(`policy.calendar`).dayBoundary))})),e.push($({id:`pillars.hour`,deps:[`time.localDateTimeForHour`,`policy.calendar`,`pillars.day`],formula:`hourStemIdx = ((dayStemIdx mod 5)*2 + hourBranchIdx) mod 10`,explain:`시지(2시간 단위)와 일간으로 시간(時干)을 결정한다.`,compute:(e,t)=>{let n=t(`time.localDateTimeForHour`),r=t(`policy.calendar`);return $e(t(`pillars.day`).stem,n.time,r.hourBoundary)}})),e.push($({id:`pillars.year`,deps:[`time.localDateTime`,`time.utcMs`,`policy.calendar`,`calendar.jieBoundariesAround`],formula:`stem = (year-4) mod 10, branch = (year-4) mod 12`,explain:`연 경계(yearBoundary)를 적용해 연주를 결정한다(입춘 경계는 실제 절기 시각을 사용).`,compute:(e,t)=>{let n=t(`time.localDateTime`),r=t(`time.utcMs`),i=t(`policy.calendar`),a=t(`calendar.jieBoundariesAround`),o=i.yearBoundary===`liChun`&&a?it(a):null,s=i.solarTerms?.method===`approx`?`approx`:`meeus`;return tt(n.date.y,r,o,i.yearBoundary,n.offsetMinutes,s)}})),e.push($({id:`pillars.month`,deps:[`time.localDateTime`,`time.utcMs`,`policy.calendar`,`calendar.jieBoundariesAround`,`pillars.year`],formula:`base = ((yearStem mod 5)*2 + 2) mod 10, monthStem = (base + m) mod 10`,explain:`월 경계(monthBoundary)를 적용해 월주를 결정한다(절기 경계는 실제 절기 시각을 사용).`,compute:(e,t)=>{let n=t(`time.localDateTime`),r=t(`time.utcMs`),i=t(`policy.calendar`),a=t(`calendar.jieBoundariesAround`),o=t(`pillars.year`),s=at(r,n,i.monthBoundary,a);return nt(o.stem,s)}})),e.push($({id:`tenGods.stems`,deps:[`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`],explain:`일간 기준 연/월/시의 천간 십성을 계산한다.`,compute:(e,t)=>{let n=t(`pillars.year`),r=t(`pillars.month`),i=t(`pillars.day`),a=t(`pillars.hour`);return{yearStem:rn(i.stem,n.stem),monthStem:rn(i.stem,r.stem),hourStem:rn(i.stem,a.stem)}}})),e.push($({id:`hiddenStems.branches`,deps:[`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`,`policy.weights`],explain:`네 지지의 지장간 목록(천간 인덱스 + 역할 + 가중치)을 생성한다.`,compute:(e,t)=>{let n=t(`pillars.year`),r=t(`pillars.month`),i=t(`pillars.day`),a=t(`pillars.hour`),o=t(`policy.weights`).hiddenStems??{scheme:`standard`};return Ba(Lt(n.branch,o),Lt(r.branch,o),Lt(i.branch,o),Lt(a.branch,o))}})),e.push($({id:`tenGods.hiddenStems`,deps:[`hiddenStems.branches`,`pillars.day`],explain:`일간 기준 각 지장간의 십성을 계산한다.`,compute:(e,t)=>{let n=t(`hiddenStems.branches`),r=t(`pillars.day`),i=e=>e.map(e=>({...e,tenGod:rn(r.stem,e.stem)}));return Ba(i(n.year),i(n.month),i(n.day),i(n.hour))}})),e.push($({id:`elements.distribution`,deps:[`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`,`policy.weights`],explain:`천간(표면) + 지장간(지지 내부) 기반 오행 가중치 분포를 계산한다.`,compute:(e,t)=>{let n=t(`pillars.year`),r=t(`pillars.month`),i=t(`pillars.day`),a=t(`pillars.hour`),o=t(`policy.weights`),s=o.elementDistribution??{};return zt([n,r,i,a],{heavenStemWeight:s.heavenStemWeight,branchTotalWeight:s.branchTotalWeight,hiddenStemWeights:o.hiddenStems})}})),e.push($({id:`relations.branches`,deps:[`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`],explain:`네 지지 간의 합/충/해/파/원진/삼합/방합을 탐지한다.`,compute:(e,t)=>{let n=t(`pillars.year`),r=t(`pillars.month`),i=t(`pillars.day`),a=t(`pillars.hour`);return Tt([n.branch,r.branch,i.branch,a.branch])}})),e.push($({id:`relations.stems`,deps:[`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`],explain:`네 천간 간의 합(合)과 충(冲)을 탐지한다.`,compute:(e,t)=>{let n=t(`pillars.year`),r=t(`pillars.month`),i=t(`pillars.day`),a=t(`pillars.hour`);return Zt([n.stem,r.stem,i.stem,a.stem])}})),e.push($({id:`fortune.timeline`,deps:[`time.utcMs`,`time.localDateTime`,`policy.calendar`,`calendar.jieBoundariesAround`,`pillars.year`,`pillars.month`,`policy.fortune`],explain:`대운/세운 타임라인(순/역, 기산, 대운 10년주, 세운 연주)을 생성한다.`,compute:(e,t)=>{let n=t(`time.utcMs`),r=t(`time.localDateTime`),i=t(`policy.calendar`),a=t(`calendar.jieBoundariesAround`),o=t(`pillars.year`),s=t(`pillars.month`),c=t(`policy.fortune`),l=a?.method===`approx`?`approx`:`meeus`;return Dn({request:e.request,parsedUtcMs:n,birthLocalDateTime:r,localYear:r.date.y,calendar:i,solarTermMethod:l,jieBoundariesAround:a,natalYearPillar:o,natalMonthPillar:s,policy:c})}})),e.push($({id:`scores.pillars`,deps:[`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`,`policy.weights`],explain:`일간 기준 십성/오행/음양 스코어(수학적 베이스)를 계산한다.`,compute:(e,t)=>{let n=t(`pillars.year`),r=t(`pillars.month`),i=t(`pillars.day`),a=t(`pillars.hour`),o=t(`policy.weights`);return un({year:n,month:r,day:i,hour:a},{stemWeight:1,branchWeight:1,hiddenStemWeights:o.hiddenStems??{scheme:`standard`},includeBranchYinYang:!1})}})),e.push($({id:`rules.facts`,deps:[`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`,`elements.distribution`,`scores.pillars`,`policy.rules`],explain:`DSL 룰 엔진에 투입할 fact-base(정규화된 수치/특징)를 구성한다.`,compute:(e,t)=>{let n=t(`pillars.year`),r=t(`pillars.month`),i=t(`pillars.day`),a=t(`pillars.hour`),o=t(`elements.distribution`),s=t(`scores.pillars`);return Fr({config:e.config,pillars:{year:n,month:r,day:i,hour:a},elementDistribution:o,scoring:s})}})),e.push($({id:`strength.index`,deps:[`rules.facts`],explain:`신강/신약(연속 스코어) — support vs pressure 기반 [-1, +1].`,compute:(e,t)=>t(`rules.facts`).strength})),e.push($({id:`rules.yongshin`,deps:[`rules.facts`],explain:`용신/희신 후보를 수학적 스코어 + DSL 보정으로 랭킹한다.`,compute:(e,t)=>Di(e.config,t(`rules.facts`))})),e.push($({id:`rules.gyeokguk`,deps:[`rules.facts`],explain:`격국을 DSL 스코어링으로 판정한다(기초: 월지 본기 십성 기반).`,compute:(e,t)=>ia(e.config,t(`rules.facts`))})),e.push($({id:`rules.shinsal`,deps:[`rules.facts`],explain:`신살을 DSL/패턴 매칭으로 판정한다(데모: 도화/역마).`,compute:(e,t)=>za(e.config,t(`rules.facts`))})),e.push($({id:`lifeStages.detail`,deps:[`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`,`policy.lifeStages`],explain:`일간 기준 각 지지의 십이운성(장생~양)을 계산한다(상세: index/startBranch 포함).`,compute:(e,t)=>{let n=t(`pillars.year`),r=t(`pillars.month`),i=t(`pillars.day`),a=t(`pillars.hour`),o=t(`policy.lifeStages`);return Ba(Wt(i.stem,n.branch,o),Wt(i.stem,r.branch,o),Wt(i.stem,i.branch,o),Wt(i.stem,a.branch,o))}})),e.push($({id:`lifeStages.pillars`,deps:[`lifeStages.detail`],explain:`십이운성 상세 결과에서 stage만 추출한다.`,compute:(e,t)=>{let n=t(`lifeStages.detail`);return Ba(n.year.stage,n.month.stage,n.day.stage,n.hour.stage)}}));let t=new Map;for(let n of e)t.set(n.id,n);return t}function Ua(e,t,n){let r=new Map,i=new Set,a=[],o=[],s=(e,t)=>`${e}→${t}`,c=new Set,l=n=>{if(r.has(n))return r.get(n);if(i.has(n))throw Error(`Cycle detected at node: ${n}`);let u=e.get(n);if(!u)throw Error(`Unknown node id: ${n}`);i.add(n);let d={};for(let e of u.deps){d[e]=l(e);let t=s(e,n);c.has(t)||(c.add(t),o.push({from:e,to:n}))}let f=u.compute(t,l);return r.set(n,f),a.push({id:u.id,deps:[...u.deps],formula:u.formula,explain:u.explain,input:d,output:f}),i.delete(n),f};for(let e of n)l(e);return{results:r,trace:{nodes:a,edges:o}}}function Wa(e){let t=e.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{1,3}))?)?(Z|[+-]\d{2}:\d{2})$/);if(!t)throw Error(`Invalid ISO instant (requires offset and minutes): ${e}`);let n=Number(t[1]),r=Number(t[2]),i=Number(t[3]),a=Number(t[4]),o=Number(t[5]),s=t[8],c=s===`Z`?0:Ga(s),l=Date.parse(e);if(!Number.isFinite(l))throw Error(`Unable to parse Date from ISO: ${e}`);return{utcMs:l,offsetMinutes:c,localDateTime:{date:{y:n,m:r,d:i},time:{h:a,min:o},offsetMinutes:c}}}function Ga(e){let t=e.match(/^([+-])(\d{2}):(\d{2})$/);if(!t)throw Error(`Invalid offset: ${e}`);let n=t[1]===`-`?-1:1,r=Number(t[2]),i=Number(t[3]);return n*(r*60+i)}function Ka(e){if(!e?.birth?.instant)throw Error(`SajuRequest.birth.instant is required`);let t=Wa(e.birth.instant);return{request:{birth:{instant:e.birth.instant,calendar:e.birth.calendar??`gregorian`},sex:e.sex,location:e.location,meta:e.meta,overrides:e.overrides},parsed:t}}function qa(e){return{idx:e,text:z(e),element:V(e),yinYang:U(e)}}function Ja(e){return{idx:e,text:B(e),element:H(e),yinYang:W(e)}}function Ya(e){return{stem:qa(e.stem),branch:Ja(e.branch)}}function Xa(e){return{stem:qa(e.stem),role:e.role,weight:e.weight}}function Za(e){return{stem:qa(e.stem),role:e.role,weight:e.weight,tenGod:e.tenGod}}var Qa={WOOD:`목`,FIRE:`화`,EARTH:`토`,METAL:`금`,WATER:`수`},$a={WOOD:`Wood`,FIRE:`Fire`,EARTH:`Earth`,METAL:`Metal`,WATER:`Water`},eo={YANG:`양`,YIN:`음`},to={YANG:`Yang`,YIN:`Yin`};function no(e){if(typeof e!=`number`||!Number.isFinite(e))return null;try{return new Date(e).toISOString()}catch{return null}}function ro(e,t){let n=z(t),r=V(t),i=U(t);return`${n}(${e===`ko`?Qa[r]??r:$a[r]??r}${e===`ko`?eo[i]??i:to[i]??i})`}function io(e,t){let n=B(t),r=H(t),i=W(t);return`${n}(${e===`ko`?Qa[r]??r:$a[r]??r}${e===`ko`?eo[i]??i:to[i]??i})`}function ao(e,t){return`${ro(e,t.stem)}${io(e,t.branch)}`}function oo(e){let t=e?.report?.facts??{},n=t[`pillars.year`],r=t[`pillars.month`],i=t[`pillars.day`],a=t[`pillars.hour`],o=e=>e&&typeof e==`object`&&typeof e.stem==`number`&&typeof e.branch==`number`;return{year:o(n)?n:void 0,month:o(r)?r:void 0,day:o(i)?i:void 0,hour:o(a)?a:void 0}}function so(e){return e.replace(/([\\`*_{}\[\]()#+\-.!|>])/g,`\\$1`)}function co(e,t){return`## ${e}\n\n${t.filter(Boolean).join(`
`)}\n`}function lo(e,t={}){let n=t.language??`ko`,r=typeof t.maxShinsal==`number`&&Number.isFinite(t.maxShinsal)?Math.max(0,t.maxShinsal):40,i=e?.input?.normalizedRequest,a=oo(e),o=e?.summary??{},s=e?.report?.facts??{},c=s[`rules.facts`]??{},l=s[`rules.yongshin`]??{},u=s[`rules.gyeokguk`]??{},d=[],f=n===`ko`?`사주 분석 근거 요약`:`Saju analysis narration`;d.push(`# ${f}`);let p=[];if(i?.birth?.instant&&p.push(`- ${n===`ko`?`출생 시각`:`Birth instant`}: ${so(String(i.birth.instant))}`),i?.sex&&p.push(`- ${n===`ko`?`성별`:`Sex`}: ${so(String(i.sex))}`),i?.location&&typeof i.location==`object`){let e=i.location,t=typeof e.name==`string`?e.name:void 0,r=typeof e.lat==`number`?e.lat.toFixed(6):void 0,a=typeof e.lon==`number`?e.lon.toFixed(6):void 0,o=[t,r!=null&&a!=null?`${r}, ${a}`:void 0].filter(Boolean);o.length&&p.push(`- ${n===`ko`?`출생지`:`Location`}: ${so(o.join(` / `))}`)}d.push(co(n===`ko`?`입력`:`Input`,p));let m=[];a.year&&a.month&&a.day&&a.hour?(m.push(`- ${n===`ko`?`연주`:`Year`}: ${ao(n,a.year)}`),m.push(`- ${n===`ko`?`월주`:`Month`}: ${ao(n,a.month)}`),m.push(`- ${n===`ko`?`일주`:`Day`}: ${ao(n,a.day)}`),m.push(`- ${n===`ko`?`시주`:`Hour`}: ${ao(n,a.hour)}`)):m.push(`- ${n===`ko`?`주요 기둥 정보가 요약에 포함되지 않았습니다.`:`Pillars were not included in the summary.`}`),d.push(co(n===`ko`?`사주 팔자(간지)`:`Four pillars`,m));let h=[];if(o?.strength&&typeof o.strength==`object`){let e=o.strength;if(typeof e.index==`number`&&h.push(`- ${n===`ko`?`신강지수`:`Strength index`}: ${e.index.toFixed(4)}`),typeof e.model==`string`&&h.push(`- ${n===`ko`?`신강 모델`:`Strength model`}: ${so(String(e.model))}`),e.details?.season&&typeof e.details.season==`object`){let t=e.details.season;typeof t.score==`number`&&h.push(`- ${n===`ko`?`월령(득령) 점수`:`Season support score`}: ${t.score.toFixed(3)} (×${typeof t.factor==`number`?t.factor.toFixed(3):`?`})`)}if(e.details?.roots&&typeof e.details.roots==`object`){let t=e.details.roots;typeof t.score==`number`&&h.push(`- ${n===`ko`?`통근(근/인) 점수`:`Root support score`}: ${t.score.toFixed(3)} (×${typeof t.factor==`number`?t.factor.toFixed(3):`?`})`)}if(e.details?.delingdiShi&&typeof e.details.delingdiShi==`object`){let t=e.details.delingdiShi;t.deLing&&typeof t.deLing.score==`number`&&h.push(`- ${n===`ko`?`득령(월령) 점수`:`De-ling (season)`}: ${t.deLing.score.toFixed(3)} (×${typeof t.deLing.factor==`number`?t.deLing.factor.toFixed(3):`?`})`),t.deDi&&typeof t.deDi.score==`number`&&h.push(`- ${n===`ko`?`득지/통근 점수`:`De-di (roots)`}: ${t.deDi.score.toFixed(3)} (norm=${typeof t.deDi.normalized==`number`?t.deDi.normalized.toFixed(3):`?`}, ×${typeof t.deDi.factor==`number`?t.deDi.factor.toFixed(3):`?`})`),t.deShi&&typeof t.deShi.score==`number`&&h.push(`- ${n===`ko`?`득세/투간 점수`:`De-shi (heavenly support)`}: ${t.deShi.score.toFixed(3)} (norm=${typeof t.deShi.normalized==`number`?t.deShi.normalized.toFixed(3):`?`}, ×${typeof t.deShi.factor==`number`?t.deShi.factor.toFixed(3):`?`})`)}}let g=c?.patterns?.elements?.oneElement;if(g&&typeof g==`object`&&g.enabled){let e=g.element?so(String(g.element)):`?`,t=typeof g.factor==`number`?g.factor.toFixed(3):`?`,r=typeof g.zhuanwangFactor==`number`?g.zhuanwangFactor:null,i=typeof g.zhuanwangConditionFactor==`number`?g.zhuanwangConditionFactor:null,a=r!=null&&Number.isFinite(r)&&r>0?`, zw=${r.toFixed(3)}${i!=null&&Number.isFinite(i)?` (cond=${i.toFixed(3)})`:``}`:``;g.isOneElement?h.push(`- ${n===`ko`?`일행득기 신호`:`One-element dominance`}: ${e} (factor=${t}${a})`):typeof g.factor==`number`&&g.factor>.15&&h.push(`- ${n===`ko`?`오행 편중 신호`:`Element concentration`}: ${e} (factor=${t}${a})`)}let _=c?.patterns?.transformations,v=_&&typeof _==`object`?_.best:null;if(_&&typeof _==`object`&&_.enabled&&v&&typeof v.factor==`number`){let e=v.factor.toFixed(3),t=typeof v.rawFactor==`number`?v.rawFactor.toFixed(3):null,r=typeof v.breakFactor==`number`?v.breakFactor.toFixed(3):null,i=typeof v.competitionFactor==`number`?v.competitionFactor.toFixed(3):null,a=typeof v.effectiveFactor==`number`?v.effectiveFactor.toFixed(3):null,o=[t?`raw=${t}`:null,r?`break=${r}`:null,i?`comp=${i}`:null,a&&a!==e?`eff=${a}`:null].filter(Boolean).join(`, `);v.factor>.15&&h.push(`- ${n===`ko`?`합화(화격) 신호`:`Transformation signal`}: ${so(String(v.pair))} → ${so(String(v.resultElement))} (factor=${e}${o?`, ${o}`:``})`)}let y=c?.patterns?.follow;if(y&&typeof y==`object`&&y.enabled===!0){let e=typeof y.mode==`string`?String(y.mode):`?`,t=typeof y.dominantRole==`string`?String(y.dominantRole):`?`,r=typeof y.dominantElement==`string`?String(y.dominantElement):`?`,i=typeof y.followType==`string`?String(y.followType):null,a=typeof y.followTenGod==`string`?String(y.followTenGod):null,o=typeof y.dominanceRatio==`number`?y.dominanceRatio.toFixed(3):`?`,s=typeof y.potentialRaw==`number`?y.potentialRaw.toFixed(3):`?`,c=typeof y.potential==`number`?y.potential.toFixed(3):`?`,l=typeof y.jonggyeokConditionFactor==`number`?y.jonggyeokConditionFactor.toFixed(3):null,u=typeof y.jonggyeokFactor==`number`?y.jonggyeokFactor.toFixed(3):null,d=[i?`type=${i}`:null,a?`tg=${a}`:null,l?`cond=${l}`:null,u?`jong=${u}`:null].filter(Boolean).join(`, `);h.push(`- ${n===`ko`?`종격(从格) 신호`:`Follow pattern`}: mode=${so(e)}, domRole=${so(t)}, domEl=${so(r)}, domRatio=${o}, pRaw=${s}, p=${c}${d?`, ${so(d)}`:``}`)}let b=c?.climate;if(b&&typeof b==`object`&&b.need&&typeof b.need==`object`){let e=typeof b.need.temp==`number`?b.need.temp.toFixed(3):`?`,t=typeof b.need.moist==`number`?b.need.moist.toFixed(3):`?`;h.push(`- ${n===`ko`?`조후 필요(온도/습도)`:`Climate need (temp/moist)`}: temp=${e}, moist=${t}`)}let x=c?.month?.gyeok;if(x&&typeof x==`object`&&typeof x.tenGod==`string`){if(h.push(`- ${n===`ko`?`월지 격(십성)`:`Month pattern (ten-god)`}: ${so(String(x.tenGod))} (${so(String(x.method??``))})`),x.support&&typeof x.support==`object`&&h.push(`  - ${n===`ko`?`회지(삼합/방합)`:`Branch-combo support`}: ${so(String(x.support.type))} / ${so(String(x.support.element))}`),Array.isArray(x.candidates)){let e=x.candidates.slice(0,3).map(e=>`${e.stem,String(e.stem)}:${typeof e.element==`string`?e.element:``}(${typeof e.score==`number`?e.score.toFixed(3):String(e.score)})`);e.length&&h.push(`  - ${n===`ko`?`후보(상위)`:`Candidates (top)`}: ${e.join(`, `)}`)}if(x.quality&&typeof x.quality==`object`){let e=x.quality,t=typeof e.clarity==`number`?e.clarity.toFixed(3):`?`,r=typeof e.integrity==`number`?e.integrity.toFixed(3):`?`,i=typeof e.multiplier==`number`?e.multiplier.toFixed(3):`?`,a=typeof e.qingZhuo==`string`?e.qingZhuo:``,o=e.broken===!0?`broken`:``,s=e.mixed===!0?`mixed`:``;h.push(`  - ${n===`ko`?`격국 품질`:`Pattern quality`}: clarity=${t}, integrity=${r}, multiplier=${i} ${so([a,o,s].filter(Boolean).join(` `))}`),Array.isArray(e.reasons)&&e.reasons.length&&h.push(`  - ${n===`ko`?`품질 근거`:`Quality reasons`}: ${so(e.reasons.slice(0,8).join(`, `))}`)}}if(o?.yongshin&&typeof o.yongshin==`object`){let e=o.yongshin;if(typeof e.best==`string`&&h.push(`- ${n===`ko`?`용신`:`Yongshin`}: ${so(String(e.best))}`),Array.isArray(e.ranking)){let t=e.ranking.slice(0,5).map(e=>`${e.element}:${typeof e.score==`number`?e.score.toFixed(4):e.score}`);t.length&&h.push(`- ${n===`ko`?`용신 랭킹(상위)`:`Yongshin ranking (top)`}: ${t.join(`, `)}`)}}let S=l?.base?.effectiveWeights;if(S&&typeof S==`object`){let e=typeof S.balance==`number`?S.balance.toFixed(3):`?`,t=typeof S.role==`number`?S.role.toFixed(3):`?`,r=typeof S.climate==`number`?S.climate.toFixed(3):`?`,i=typeof S.medicine==`number`?S.medicine.toFixed(3):`?`,a=typeof S.tongguan==`number`?S.tongguan.toFixed(3):null,o=typeof S.follow==`number`?S.follow.toFixed(3):null,s=typeof S.johooTemplate==`number`?S.johooTemplate.toFixed(3):null,c=typeof S.transformations==`number`?S.transformations.toFixed(3):null,l=typeof S.oneElement==`number`?S.oneElement.toFixed(3):null,u=[a==null?null:`tong=${a}`,o==null?null:`fol=${o}`,s==null?null:`tpl=${s}`,c==null?null:`tr=${c}`,l==null?null:`one=${l}`].filter(Boolean).join(`, `);h.push(`- ${n===`ko`?`가중치(실효)`:`Effective weights`}: bal=${e}, role=${t}, clim=${r}, med=${i}${u?`, ${u}`:``}`)}let C=l?.base?.climateUrgency;if(C&&typeof C==`object`&&typeof C.magnitude==`number`){let e=C.magnitude.toFixed(3),t=typeof C.threshold==`number`?C.threshold.toFixed(3):`?`,r=typeof C.factor==`number`?C.factor.toFixed(3):`?`;h.push(`- ${n===`ko`?`조후 긴급도`:`Climate urgency`}: |need|=${e} (thr=${t}, factor=${r})`)}let w=l?.base?.methodSelector;if(w&&typeof w==`object`&&w.enabled===!0){let e=[];if(w.climate&&typeof w.climate==`object`){let t=typeof w.climate.magnitude==`number`?w.climate.magnitude.toFixed(3):`?`,n=typeof w.climate.factor==`number`?w.climate.factor.toFixed(3):`?`;e.push(`climate(|need|=${t}, f=${n})`)}if(w.medicine&&typeof w.medicine==`object`){let t=typeof w.medicine.maxExcess==`number`?w.medicine.maxExcess.toFixed(3):`?`,n=typeof w.medicine.factor==`number`?w.medicine.factor.toFixed(3):`?`;e.push(`medicine(maxEx=${t}, f=${n})`)}if(w.tongguan&&typeof w.tongguan==`object`){let t=typeof w.tongguan.maxIntensity==`number`?w.tongguan.maxIntensity.toFixed(3):`?`,n=typeof w.tongguan.effectiveMaxIntensity==`number`?w.tongguan.effectiveMaxIntensity.toFixed(3):null,r=typeof w.tongguan.dominance==`number`?w.tongguan.dominance.toFixed(3):null,i=typeof w.tongguan.factor==`number`?w.tongguan.factor.toFixed(3):`?`,a=[n==null?null:`eff=${n}`,r==null?null:`dom=${r}`].filter(Boolean).join(`, `);e.push(`tongguan(max=${t}${a?`, ${a}`:``}, f=${i})`)}if(w.follow&&typeof w.follow==`object`){let t=typeof w.follow.potential==`number`?w.follow.potential.toFixed(3):`?`,n=typeof w.follow.factor==`number`?w.follow.factor.toFixed(3):`?`,r=typeof w.follow.mode==`string`?String(w.follow.mode):null;e.push(`follow(${r?`mode=${r}, `:``}p=${t}, f=${n})`)}if(w.johooTemplate&&typeof w.johooTemplate==`object`){let t=typeof w.johooTemplate.factor==`number`?w.johooTemplate.factor.toFixed(3):`?`;e.push(`template(f=${t})`)}if(w.transformations&&typeof w.transformations==`object`){let t=w.transformations,n=typeof t.bestFactor==`number`?t.bestFactor.toFixed(3):`?`,r=typeof t.factor==`number`?t.factor.toFixed(3):`?`,i=typeof t.resultElement==`string`?String(t.resultElement):null,a=typeof t.pair==`string`?String(t.pair):null;e.push(`transform(${a&&i?`${a}→${i}, `:``}best=${n}, f=${r})`)}if(w.oneElement&&typeof w.oneElement==`object`){let t=w.oneElement,n=typeof t.signal==`number`?t.signal.toFixed(3):`?`,r=typeof t.factor==`number`?t.factor.toFixed(3):`?`,i=typeof t.element==`string`?String(t.element):null;e.push(`oneElement(${i?`${i}, `:``}sig=${n}, f=${r})`)}if(w.competition&&typeof w.competition==`object`){let t=w.competition,n=Array.isArray(t.methods)?t.methods.join(`+`):``,r=Array.isArray(t.activeMethods)?t.activeMethods.join(`+`):``,i=t.winner&&typeof t.winner==`object`?t.winner:null,a=i&&typeof i.method==`string`?` winner=${i.method}${typeof i.share==`number`?`(${i.share.toFixed(2)})`:``}`:``,o=t.renormalize===!0?` rn`:``,s=t.renormalize===!0&&typeof t.scale==`number`&&Number.isFinite(t.scale)&&t.scale!==1?` scale=${t.scale.toFixed(3)}`:``,c=t.shares&&typeof t.shares==`object`?Object.entries(t.shares).map(([e,t])=>`${e}=${typeof t==`number`?t.toFixed(2):t}`).join(`,`):``,l=t.multipliers&&typeof t.multipliers==`object`?Object.entries(t.multipliers).map(([e,t])=>`${e}×${typeof t==`number`?t.toFixed(2):t}`).join(`,`):``;e.push(`comp(${n}${r?` active=${r}`:``}${a}${o}${s}${c?` shares=${c}`:``}${l?` mult=${l}`:``})`)}e.length&&h.push(`- ${n===`ko`?`메타-선택기`:`Method selector`}: ${e.join(`, `)}`)}if(o?.gyeokguk&&typeof o.gyeokguk==`object`){let e=o.gyeokguk;if(typeof e.best==`string`&&h.push(`- ${n===`ko`?`격국`:`Gyeokguk`}: ${so(String(e.best))}`),Array.isArray(e.ranking)){let t=e.ranking.slice(0,5).map(e=>`${e.key}:${typeof e.score==`number`?e.score.toFixed(4):e.score}`);t.length&&h.push(`- ${n===`ko`?`격국 랭킹(상위)`:`Gyeokguk ranking (top)`}: ${t.join(`, `)}`)}let t=u?.basis?.competition??u?.competition;if(t&&typeof t==`object`&&t.enabled===!0){let e=Array.isArray(t.methods)?t.methods.join(`+`):``,r=t.shares&&typeof t.shares==`object`?Object.entries(t.shares).map(([e,t])=>`${e}=${typeof t==`number`?t.toFixed(2):t}`).join(`,`):``,i=t.multipliers&&typeof t.multipliers==`object`?Object.entries(t.multipliers).map(([e,t])=>`${e}×${typeof t==`number`?t.toFixed(2):t}`).join(`,`):``,a=t.winner&&typeof t.winner==`object`?t.winner:null,o=a&&typeof a.method==`string`?` winner=${a.method}${typeof a.share==`number`?`(${a.share.toFixed(2)})`:``}`:``;h.push(`- ${n===`ko`?`격국 변격 경쟁`:`Gyeokguk special-frame competition`}: ${e}${o}${r?` shares=${r}`:``}${i?` mult=${i}`:``}`);let s=t.affected;if(s&&typeof s==`object`){let e=Object.entries(s).map(([e,t])=>({key:e,before:typeof t?.before==`number`?t.before:0,after:typeof t?.after==`number`?t.after:0})).filter(e=>Number.isFinite(e.before)&&Number.isFinite(e.after)).sort((e,t)=>Math.abs(t.before)-Math.abs(e.before)).slice(0,6).map(e=>`${e.key}:${e.before.toFixed(3)}→${e.after.toFixed(3)}`);e.length&&h.push(`  - ${n===`ko`?`영향(일부)`:`Affected (partial)`}: ${e.join(`, `)}`)}}}h.length&&d.push(co(n===`ko`?`규칙 엔진(요약)`:`Rule engine (summary)`,h));let T=[];if(o?.fortune&&typeof o.fortune==`object`){let e=o.fortune;if(e.start&&typeof e.start==`object`){if(T.push(`- ${n===`ko`?`대운 방향`:`Fortune direction`}: ${so(String(e.start.direction))}`),e.start.boundary){let t=no(e.start.boundary.utcMs);T.push(`- ${n===`ko`?`경계 절기`:`Boundary term`}: ${so(String(e.start.boundary.id))}${t?` (${t})`:``}`)}if(typeof e.start.deltaMs==`number`){let t=e.start.deltaMs/(1e3*60*60*24);T.push(`- ${n===`ko`?`절입까지`:`Delta to boundary`}: ${t.toFixed(3)} ${n===`ko`?`일`:`days`}`)}typeof e.start.startAgeYears==`number`&&T.push(`- ${n===`ko`?`대운 시작 나이(근사)`:`Luck start age (approx)`}: ${e.start.startAgeYears.toFixed(4)} ${n===`ko`?`세`:`years`}`),typeof e.start.formula==`string`&&T.push(`- ${n===`ko`?`계산식`:`Formula`}: ${so(e.start.formula)}`)}if(Array.isArray(e.decades)&&e.decades.length){let t=e.decades.slice(0,8).map(e=>{let t=e.pillar?.stem?.text&&e.pillar?.branch?.text?`${e.pillar.stem.text}${e.pillar.branch.text}`:``;return`${e.index}:${t}@${typeof e.startAgeYears==`number`?e.startAgeYears.toFixed(1):`?`}-${typeof e.endAgeYears==`number`?e.endAgeYears.toFixed(1):`?`}${n===`ko`?`세`:`y`}`});T.push(`- ${n===`ko`?`대운(일부)`:`Decades (partial)`}: ${t.join(`, `)}`)}}T.length&&d.push(co(n===`ko`?`대운/세운(요약)`:`Fortune timeline (summary)`,T));let E=[],D=Array.isArray(o?.shinsalHits)?o.shinsalHits:[];if(D.length){E.push(`- ${n===`ko`?`감지된 신살 수`:`Detections`}: ${D.length}`);let e=D.slice(0,r);for(let t of e){let e=String(t.name??``),n=String(t.basedOn??``),r=typeof t.qualityWeight==`number`?` qw=${t.qualityWeight.toFixed(3)}`:``,i=t.invalidated?` (invalidated)`:``,a=``;t.targetKind===`BRANCH`&&t.targetBranch?.text?a=t.targetBranch.text:t.targetKind===`STEM`&&t.targetStem?.text?a=t.targetStem.text:t.targetKind===`NONE`&&(a=`-`);let o=a?` @${a}`:``;E.push(`- ${so(e)} [${so(n)}]${o}${r}${i}`)}D.length>e.length&&E.push(`- ... ${D.length-e.length} more`)}E.length&&d.push(co(n===`ko`?`신살(요약)`:`Shinsal (summary)`,E));let O=[];return O.push(n===`ko`?"- 이 문서는 사람이 읽기 쉬운 요약입니다. 모든 계산 근거/수치/트레이스는 `report.json` 및 `facts.json`(또는 동일 역할 파일)에서 확인하세요.":"- This is a human-readable summary. For full numeric evidence and traces, see `report.json` and `facts.json`."),d.push(co(n===`ko`?`참고`:`Notes`,O)),{language:n,markdown:d.join(`
`),meta:{engineName:e?.engine?.name,engineVersion:e?.engine?.version,createdAtUtc:new Date().toISOString()}}}function uo(e){let t=globalThis.Buffer;if(typeof t?.from==`function`)return t.from(e).toString(`base64`);let n=``,r=32768;for(let t=0;t<e.length;t+=r){let i=e.subarray(t,t+r);n+=String.fromCharCode(...i)}return btoa(n)}function fo(e){let t=globalThis.Buffer;if(typeof t?.from==`function`)return new Uint8Array(t.from(e,`base64`));let n=atob(e),r=new Uint8Array(n.length);for(let e=0;e<n.length;e++)r[e]=n.charCodeAt(e)&255;return r}var po=Uint8Array,mo=Uint16Array,ho=Int32Array,go=new po([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),_o=new po([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),vo=new po([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),yo=function(e,t){for(var n=new mo(31),r=0;r<31;++r)n[r]=t+=1<<e[r-1];for(var i=new ho(n[30]),r=1;r<30;++r)for(var a=n[r];a<n[r+1];++a)i[a]=a-n[r]<<5|r;return{b:n,r:i}},bo=yo(go,2),xo=bo.b,So=bo.r;xo[28]=258,So[258]=28;for(var Co=yo(_o,0),wo=Co.b,To=Co.r,Eo=new mo(32768),Do=0;Do<32768;++Do){var Oo=(Do&43690)>>1|(Do&21845)<<1;Oo=(Oo&52428)>>2|(Oo&13107)<<2,Oo=(Oo&61680)>>4|(Oo&3855)<<4,Eo[Do]=((Oo&65280)>>8|(Oo&255)<<8)>>1}for(var ko=(function(e,t,n){for(var r=e.length,i=0,a=new mo(t);i<r;++i)e[i]&&++a[e[i]-1];var o=new mo(t);for(i=1;i<t;++i)o[i]=o[i-1]+a[i-1]<<1;var s;if(n){s=new mo(1<<t);var c=15-t;for(i=0;i<r;++i)if(e[i])for(var l=i<<4|e[i],u=t-e[i],d=o[e[i]-1]++<<u,f=d|(1<<u)-1;d<=f;++d)s[Eo[d]>>c]=l}else for(s=new mo(r),i=0;i<r;++i)e[i]&&(s[i]=Eo[o[e[i]-1]++]>>15-e[i]);return s}),Ao=new po(288),Do=0;Do<144;++Do)Ao[Do]=8;for(var Do=144;Do<256;++Do)Ao[Do]=9;for(var Do=256;Do<280;++Do)Ao[Do]=7;for(var Do=280;Do<288;++Do)Ao[Do]=8;for(var jo=new po(32),Do=0;Do<32;++Do)jo[Do]=5;var Mo=ko(Ao,9,0),No=ko(Ao,9,1),Po=ko(jo,5,0),Fo=ko(jo,5,1),Io=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},Lo=function(e,t,n){var r=t/8|0;return(e[r]|e[r+1]<<8)>>(t&7)&n},Ro=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(t&7)},zo=function(e){return(e+7)/8|0},Bo=function(e,t,n){return(t==null||t<0)&&(t=0),(n==null||n>e.length)&&(n=e.length),new po(e.subarray(t,n))},Vo=[`unexpected EOF`,`invalid block type`,`invalid length/literal`,`invalid distance`,`stream finished`,`no stream handler`,,`no callback`,`invalid UTF-8 data`,`extra field too long`,`date not in range 1980-2099`,`filename too long`,`stream finishing`,`invalid zip data`],Ho=function(e,t,n){var r=Error(t||Vo[e]);if(r.code=e,Error.captureStackTrace&&Error.captureStackTrace(r,Ho),!n)throw r;return r},Uo=function(e,t,n,r){var i=e.length,a=r?r.length:0;if(!i||t.f&&!t.l)return n||new po(0);var o=!n,s=o||t.i!=2,c=t.i;o&&(n=new po(i*3));var l=function(e){var t=n.length;if(e>t){var r=new po(Math.max(t*2,e));r.set(n),n=r}},u=t.f||0,d=t.p||0,f=t.b||0,p=t.l,m=t.d,h=t.m,g=t.n,_=i*8;do{if(!p){u=Lo(e,d,1);var v=Lo(e,d+1,3);if(d+=3,!v){var y=zo(d)+4,b=e[y-4]|e[y-3]<<8,x=y+b;if(x>i){c&&Ho(0);break}s&&l(f+b),n.set(e.subarray(y,x),f),t.b=f+=b,t.p=d=x*8,t.f=u;continue}else if(v==1)p=No,m=Fo,h=9,g=5;else if(v==2){var S=Lo(e,d,31)+257,C=Lo(e,d+10,15)+4,w=S+Lo(e,d+5,31)+1;d+=14;for(var T=new po(w),E=new po(19),D=0;D<C;++D)E[vo[D]]=Lo(e,d+D*3,7);d+=C*3;for(var O=Io(E),k=(1<<O)-1,A=ko(E,O,1),D=0;D<w;){var j=A[Lo(e,d,k)];d+=j&15;var y=j>>4;if(y<16)T[D++]=y;else{var M=0,N=0;for(y==16?(N=3+Lo(e,d,3),d+=2,M=T[D-1]):y==17?(N=3+Lo(e,d,7),d+=3):y==18&&(N=11+Lo(e,d,127),d+=7);N--;)T[D++]=M}}var P=T.subarray(0,S),F=T.subarray(S);h=Io(P),g=Io(F),p=ko(P,h,1),m=ko(F,g,1)}else Ho(1);if(d>_){c&&Ho(0);break}}s&&l(f+131072);for(var I=(1<<h)-1,L=(1<<g)-1,R=d;;R=d){var M=p[Ro(e,d)&I],z=M>>4;if(d+=M&15,d>_){c&&Ho(0);break}if(M||Ho(2),z<256)n[f++]=z;else if(z==256){R=d,p=null;break}else{var B=z-254;if(z>264){var D=z-257,V=go[D];B=Lo(e,d,(1<<V)-1)+xo[D],d+=V}var H=m[Ro(e,d)&L],U=H>>4;H||Ho(3),d+=H&15;var F=wo[U];if(U>3){var V=_o[U];F+=Ro(e,d)&(1<<V)-1,d+=V}if(d>_){c&&Ho(0);break}s&&l(f+131072);var W=f+B;if(f<F){var G=a-F,ee=Math.min(F,W);for(G+f<0&&Ho(3);f<ee;++f)n[f]=r[G+f]}for(;f<W;++f)n[f]=n[f-F]}}t.l=p,t.p=R,t.b=f,t.f=u,p&&(u=1,t.m=h,t.d=m,t.n=g)}while(!u);return f!=n.length&&o?Bo(n,0,f):n.subarray(0,f)},Wo=function(e,t,n){n<<=t&7;var r=t/8|0;e[r]|=n,e[r+1]|=n>>8},Go=function(e,t,n){n<<=t&7;var r=t/8|0;e[r]|=n,e[r+1]|=n>>8,e[r+2]|=n>>16},Ko=function(e,t){for(var n=[],r=0;r<e.length;++r)e[r]&&n.push({s:r,f:e[r]});var i=n.length,a=n.slice();if(!i)return{t:$o,l:0};if(i==1){var o=new po(n[0].s+1);return o[n[0].s]=1,{t:o,l:1}}n.sort(function(e,t){return e.f-t.f}),n.push({s:-1,f:25001});var s=n[0],c=n[1],l=0,u=1,d=2;for(n[0]={s:-1,f:s.f+c.f,l:s,r:c};u!=i-1;)s=n[n[l].f<n[d].f?l++:d++],c=n[l!=u&&n[l].f<n[d].f?l++:d++],n[u++]={s:-1,f:s.f+c.f,l:s,r:c};for(var f=a[0].s,r=1;r<i;++r)a[r].s>f&&(f=a[r].s);var p=new mo(f+1),m=qo(n[u-1],p,0);if(m>t){var r=0,h=0,g=m-t,_=1<<g;for(a.sort(function(e,t){return p[t.s]-p[e.s]||e.f-t.f});r<i;++r){var v=a[r].s;if(p[v]>t)h+=_-(1<<m-p[v]),p[v]=t;else break}for(h>>=g;h>0;){var y=a[r].s;p[y]<t?h-=1<<t-p[y]++-1:++r}for(;r>=0&&h;--r){var b=a[r].s;p[b]==t&&(--p[b],++h)}m=t}return{t:new po(p),l:m}},qo=function(e,t,n){return e.s==-1?Math.max(qo(e.l,t,n+1),qo(e.r,t,n+1)):t[e.s]=n},Jo=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new mo(++t),r=0,i=e[0],a=1,o=function(e){n[r++]=e},s=1;s<=t;++s)if(e[s]==i&&s!=t)++a;else{if(!i&&a>2){for(;a>138;a-=138)o(32754);a>2&&(o(a>10?a-11<<5|28690:a-3<<5|12305),a=0)}else if(a>3){for(o(i),--a;a>6;a-=6)o(8304);a>2&&(o(a-3<<5|8208),a=0)}for(;a--;)o(i);a=1,i=e[s]}return{c:n.subarray(0,r),n:t}},Yo=function(e,t){for(var n=0,r=0;r<t.length;++r)n+=e[r]*t[r];return n},Xo=function(e,t,n){var r=n.length,i=zo(t+2);e[i]=r&255,e[i+1]=r>>8,e[i+2]=e[i]^255,e[i+3]=e[i+1]^255;for(var a=0;a<r;++a)e[i+a+4]=n[a];return(i+4+r)*8},Zo=function(e,t,n,r,i,a,o,s,c,l,u){Wo(t,u++,n),++i[256];for(var d=Ko(i,15),f=d.t,p=d.l,m=Ko(a,15),h=m.t,g=m.l,_=Jo(f),v=_.c,y=_.n,b=Jo(h),x=b.c,S=b.n,C=new mo(19),w=0;w<v.length;++w)++C[v[w]&31];for(var w=0;w<x.length;++w)++C[x[w]&31];for(var T=Ko(C,7),E=T.t,D=T.l,O=19;O>4&&!E[vo[O-1]];--O);var k=l+5<<3,A=Yo(i,Ao)+Yo(a,jo)+o,j=Yo(i,f)+Yo(a,h)+o+14+3*O+Yo(C,E)+2*C[16]+3*C[17]+7*C[18];if(c>=0&&k<=A&&k<=j)return Xo(t,u,e.subarray(c,c+l));var M,N,P,F;if(Wo(t,u,1+(j<A)),u+=2,j<A){M=ko(f,p,0),N=f,P=ko(h,g,0),F=h;var I=ko(E,D,0);Wo(t,u,y-257),Wo(t,u+5,S-1),Wo(t,u+10,O-4),u+=14;for(var w=0;w<O;++w)Wo(t,u+3*w,E[vo[w]]);u+=3*O;for(var L=[v,x],R=0;R<2;++R)for(var z=L[R],w=0;w<z.length;++w){var B=z[w]&31;Wo(t,u,I[B]),u+=E[B],B>15&&(Wo(t,u,z[w]>>5&127),u+=z[w]>>12)}}else M=Mo,N=Ao,P=Po,F=jo;for(var w=0;w<s;++w){var V=r[w];if(V>255){var B=V>>18&31;Go(t,u,M[B+257]),u+=N[B+257],B>7&&(Wo(t,u,V>>23&31),u+=go[B]);var H=V&31;Go(t,u,P[H]),u+=F[H],H>3&&(Go(t,u,V>>5&8191),u+=_o[H])}else Go(t,u,M[V]),u+=N[V]}return Go(t,u,M[256]),u+N[256]},Qo=new ho([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),$o=new po(0),es=function(e,t,n,r,i,a){var o=a.z||e.length,s=new po(r+o+5*(1+Math.ceil(o/7e3))+i),c=s.subarray(r,s.length-i),l=a.l,u=(a.r||0)&7;if(t){u&&(c[0]=a.r>>3);for(var d=Qo[t-1],f=d>>13,p=d&8191,m=(1<<n)-1,h=a.p||new mo(32768),g=a.h||new mo(m+1),_=Math.ceil(n/3),v=2*_,y=function(t){return(e[t]^e[t+1]<<_^e[t+2]<<v)&m},b=new ho(25e3),x=new mo(288),S=new mo(32),C=0,w=0,T=a.i||0,E=0,D=a.w||0,O=0;T+2<o;++T){var k=y(T),A=T&32767,j=g[k];if(h[A]=j,g[k]=A,D<=T){var M=o-T;if((C>7e3||E>24576)&&(M>423||!l)){u=Zo(e,c,0,b,x,S,w,E,O,T-O,u),E=C=w=0,O=T;for(var N=0;N<286;++N)x[N]=0;for(var N=0;N<30;++N)S[N]=0}var P=2,F=0,I=p,L=A-j&32767;if(M>2&&k==y(T-L))for(var R=Math.min(f,M)-1,z=Math.min(32767,T),B=Math.min(258,M);L<=z&&--I&&A!=j;){if(e[T+P]==e[T+P-L]){for(var V=0;V<B&&e[T+V]==e[T+V-L];++V);if(V>P){if(P=V,F=L,V>R)break;for(var H=Math.min(L,V-2),U=0,N=0;N<H;++N){var W=T-L+N&32767,G=W-h[W]&32767;G>U&&(U=G,j=W)}}}A=j,j=h[A],L+=A-j&32767}if(F){b[E++]=268435456|So[P]<<18|To[F];var ee=So[P]&31,K=To[F]&31;w+=go[ee]+_o[K],++x[257+ee],++S[K],D=T+P,++C}else b[E++]=e[T],++x[e[T]]}}for(T=Math.max(T,D);T<o;++T)b[E++]=e[T],++x[e[T]];u=Zo(e,c,l,b,x,S,w,E,O,T-O,u),l||(a.r=u&7|c[u/8|0]<<3,u-=7,a.h=g,a.p=h,a.i=T,a.w=D)}else{for(var T=a.w||0;T<o+l;T+=65535){var q=T+65535;q>=o&&(c[u/8|0]=l,q=o),u=Xo(c,u+1,e.subarray(T,q))}a.i=o}return Bo(s,0,r+zo(u)+i)},ts=(function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var n=t,r=9;--r;)n=(n&1&&-306674912)^n>>>1;e[t]=n}return e})(),ns=function(){var e=-1;return{p:function(t){for(var n=e,r=0;r<t.length;++r)n=ts[n&255^t[r]]^n>>>8;e=n},d:function(){return~e}}},rs=function(e,t,n,r,i){if(!i&&(i={l:1},t.dictionary)){var a=t.dictionary.subarray(-32768),o=new po(a.length+e.length);o.set(a),o.set(e,a.length),e=o,i.w=a.length}return es(e,t.level==null?6:t.level,t.mem==null?i.l?Math.ceil(Math.max(8,Math.min(13,Math.log(e.length)))*1.5):20:12+t.mem,n,r,i)},is=function(e,t){var n={};for(var r in e)n[r]=e[r];for(var r in t)n[r]=t[r];return n},as=function(e,t){return e[t]|e[t+1]<<8},os=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0},ss=function(e,t){return os(e,t)+os(e,t+4)*4294967296},cs=function(e,t,n){for(;n;++t)e[t]=n,n>>>=8};function ls(e,t){return rs(e,t||{},0,0)}function us(e,t){return Uo(e,{i:2},t&&t.out,t&&t.dictionary)}var ds=function(e,t,n,r){for(var i in e){var a=e[i],o=t+i,s=r;Array.isArray(a)&&(s=is(r,a[1]),a=a[0]),a instanceof po?n[o]=[a,s]:(n[o+=`/`]=[new po(0),s],ds(a,o,n,r))}},fs=typeof TextEncoder<`u`&&new TextEncoder,ps=typeof TextDecoder<`u`&&new TextDecoder;try{ps.decode($o,{stream:!0})}catch{}var ms=function(e){for(var t=``,n=0;;){var r=e[n++],i=(r>127)+(r>223)+(r>239);if(n+i>e.length)return{s:t,r:Bo(e,n-1)};i?i==3?(r=((r&15)<<18|(e[n++]&63)<<12|(e[n++]&63)<<6|e[n++]&63)-65536,t+=String.fromCharCode(55296|r>>10,56320|r&1023)):i&1?t+=String.fromCharCode((r&31)<<6|e[n++]&63):t+=String.fromCharCode((r&15)<<12|(e[n++]&63)<<6|e[n++]&63):t+=String.fromCharCode(r)}};function hs(e,t){if(t){for(var n=new po(e.length),r=0;r<e.length;++r)n[r]=e.charCodeAt(r);return n}if(fs)return fs.encode(e);for(var i=e.length,a=new po(e.length+(e.length>>1)),o=0,s=function(e){a[o++]=e},r=0;r<i;++r){if(o+5>a.length){var c=new po(o+8+(i-r<<1));c.set(a),a=c}var l=e.charCodeAt(r);l<128||t?s(l):l<2048?(s(192|l>>6),s(128|l&63)):l>55295&&l<57344?(l=65536+(l&1047552)|e.charCodeAt(++r)&1023,s(240|l>>18),s(128|l>>12&63),s(128|l>>6&63),s(128|l&63)):(s(224|l>>12),s(128|l>>6&63),s(128|l&63))}return Bo(a,0,o)}function gs(e,t){if(t){for(var n=``,r=0;r<e.length;r+=16384)n+=String.fromCharCode.apply(null,e.subarray(r,r+16384));return n}else if(ps)return ps.decode(e);else{var i=ms(e),a=i.s,n=i.r;return n.length&&Ho(8),a}}var _s=function(e,t){return t+30+as(e,t+26)+as(e,t+28)},vs=function(e,t,n){var r=as(e,t+28),i=gs(e.subarray(t+46,t+46+r),!(as(e,t+8)&2048)),a=t+46+r,o=os(e,t+20),s=n&&o==4294967295?ys(e,a):[o,os(e,t+24),os(e,t+42)],c=s[0],l=s[1],u=s[2];return[as(e,t+10),c,l,i,a+as(e,t+30)+as(e,t+32),u]},ys=function(e,t){for(;as(e,t)!=1;t+=4+as(e,t+2));return[ss(e,t+12),ss(e,t+4),ss(e,t+20)]},bs=function(e){var t=0;if(e)for(var n in e){var r=e[n].length;r>65535&&Ho(9),t+=r+4}return t},xs=function(e,t,n,r,i,a,o,s){var c=r.length,l=n.extra,u=s&&s.length,d=bs(l);cs(e,t,o==null?67324752:33639248),t+=4,o!=null&&(e[t++]=20,e[t++]=n.os),e[t]=20,t+=2,e[t++]=n.flag<<1|(a<0&&8),e[t++]=i&&8,e[t++]=n.compression&255,e[t++]=n.compression>>8;var f=new Date(n.mtime==null?Date.now():n.mtime),p=f.getFullYear()-1980;if((p<0||p>119)&&Ho(10),cs(e,t,p<<25|f.getMonth()+1<<21|f.getDate()<<16|f.getHours()<<11|f.getMinutes()<<5|f.getSeconds()>>1),t+=4,a!=-1&&(cs(e,t,n.crc),cs(e,t+4,a<0?-a-2:a),cs(e,t+8,n.size)),cs(e,t+12,c),cs(e,t+14,d),t+=16,o!=null&&(cs(e,t,u),cs(e,t+6,n.attrs),cs(e,t+10,o),t+=14),e.set(r,t),t+=c,d)for(var m in l){var h=l[m],g=h.length;cs(e,t,+m),cs(e,t+2,g),e.set(h,t+4),t+=4+g}return u&&(e.set(s,t),t+=u),t},Ss=function(e,t,n,r,i){cs(e,t,101010256),cs(e,t+8,n),cs(e,t+10,n),cs(e,t+12,r),cs(e,t+16,i)};function Cs(e,t){t||={};var n={},r=[];ds(e,``,n,t);var i=0,a=0;for(var o in n){var s=n[o],c=s[0],l=s[1],u=l.level==0?0:8,d=hs(o),f=d.length,p=l.comment,m=p&&hs(p),h=m&&m.length,g=bs(l.extra);f>65535&&Ho(11);var _=u?ls(c,l):c,v=_.length,y=ns();y.p(c),r.push(is(l,{size:c.length,crc:y.d(),c:_,f:d,m,u:f!=o.length||m&&p.length!=h,o:i,compression:u})),i+=30+f+g+v,a+=76+2*(f+g)+(h||0)+v}for(var b=new po(a+22),x=i,S=a-i,C=0;C<r.length;++C){var d=r[C];xs(b,d.o,d,d.f,d.u,d.c.length);var w=30+d.f.length+bs(d.extra);b.set(d.c,d.o+w),xs(b,i,d,d.f,d.u,d.c.length,d.o,d.m),i+=16+w+(d.m?d.m.length:0)}return Ss(b,i,r.length,S,x),b}function ws(e,t){for(var n={},r=e.length-22;os(e,r)!=101010256;--r)(!r||e.length-r>65558)&&Ho(13);var i=as(e,r+8);if(!i)return{};var a=os(e,r+16),o=a==4294967295||i==65535;if(o){var s=os(e,r-12);o=os(e,s)==101075792,o&&(i=os(e,s+32),a=os(e,s+48))}for(var c=t&&t.filter,l=0;l<i;++l){var u=vs(e,a,o),d=u[0],f=u[1],p=u[2],m=u[3],h=u[4],g=u[5],_=_s(e,g);a=h,(!c||c({name:m,size:f,originalSize:p,compression:d}))&&(d?d==8?n[m]=us(e.subarray(_,_+f),{out:new po(p)}):Ho(14,`unknown compression type `+d):n[m]=Bo(e,_,_+f))}return n}function Ts(e,t,n){return hs(A(t,n))}function Es(e,t={}){let n=new Set(t.include??[`summary`,`report`,`facts`,`trace`,`diagnostics`,`config`,`narration`]),r=t.prettyJson?2:void 0,i=typeof t.level==`number`?Math.max(0,Math.min(9,Math.floor(t.level))):6,a={};if(n.has(`bundle`)&&(a[`bundle.json`]=Ts(`bundle.json`,e,r)),n.has(`summary`)&&(a[`summary.json`]=Ts(`summary.json`,e.summary,r)),n.has(`report`)&&(a[`report.json`]=Ts(`report.json`,e.report,r)),n.has(`facts`)&&(a[`facts.json`]=Ts(`facts.json`,e.report.facts,r)),n.has(`trace`)&&(a[`trace.json`]=Ts(`trace.json`,e.report.trace,r)),n.has(`diagnostics`)&&(a[`diagnostics.json`]=Ts(`diagnostics.json`,e.report.diagnostics,r)),n.has(`config`)&&(a[`config.json`]=Ts(`config.json`,e.report.facts?.config??{},r)),n.has(`narration`)){let n=lo(e,t.narration??{});a[`narration.json`]=Ts(`narration.json`,n,r),a[`narration.md`]=hs(n.markdown)}return a[`manifest.json`]=Ts(`manifest.json`,{kind:`saju.analysis.zip`,createdAt:new Date().toISOString(),schemaVersion:e.config.schemaVersion,configDigest:e.config.digest,files:Object.entries(a).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>({path:e,bytes:t.length,sha256:k(gs(t))}))},2),{mime:`application/zip`,encoding:`base64`,data:uo(Cs(a,{level:i}))}}function Ds(e){if(!e||typeof e!=`object`)throw Error(`Artifact is required`);if(e.encoding!==`base64`)throw Error(`Unsupported artifact.encoding: ${String(e.encoding)}`);let t=ws(fo(String(e.data??``))),n={},r={};for(let[e,i]of Object.entries(t))if(e.endsWith(`.json`)||e.endsWith(`.txt`)||e.endsWith(`.md`)){let t=gs(i);if(n[e]=t,e.endsWith(`.json`))try{r[e]=JSON.parse(t)}catch{}}return{files:t,text:n,json:r,manifest:r[`manifest.json`]??void 0}}function Os(e){let t=e.strategies?.artifacts?.analysisZip??e.strategies?.artifacts?.zip;if(!t||typeof t!=`object`)return{explicit:!1,enabled:!1};let n=t.narration,r=n&&typeof n==`object`?{language:n.language===`en`?`en`:n.language===`ko`?`ko`:void 0,maxShinsal:typeof n.maxShinsal==`number`?n.maxShinsal:void 0}:void 0;return{explicit:!0,enabled:t.enabled===!0,key:typeof t.key==`string`?t.key:void 0,prettyJson:typeof t.prettyJson==`boolean`?t.prettyJson:void 0,include:Array.isArray(t.include)?t.include:void 0,level:typeof t.level==`number`?t.level:void 0,narration:r}}function ks(e={}){let t=O(e),n=`sha256:${k(A(t))}`,r=Ha();return{config:t,analyze(e){let{request:i,parsed:a}=Ka(e),o={request:i,parsed:a,config:t},s=[];t.toggles.pillars&&s.push(`pillars.year`,`pillars.month`,`pillars.day`,`pillars.hour`),t.toggles.tenGods&&s.push(`tenGods.stems`),t.toggles.hiddenStems&&(s.push(`hiddenStems.branches`),t.toggles.tenGods&&s.push(`tenGods.hiddenStems`)),t.toggles.elementDistribution&&s.push(`elements.distribution`),t.toggles.lifeStages&&s.push(`lifeStages.pillars`),t.toggles.stemRelations&&s.push(`relations.stems`),t.toggles.relations&&s.push(`relations.branches`),t.toggles.fortune&&s.push(`fortune.timeline`),t.toggles.rules&&s.push(`strength.index`,`rules.yongshin`,`rules.gyeokguk`,`rules.shinsal`);let{results:c,trace:l}=Ua(r,o,s),u={};if(t.toggles.pillars){let e=c.get(`pillars.year`),t=c.get(`pillars.month`),n=c.get(`pillars.day`),r=c.get(`pillars.hour`);u.pillars={year:Ya(e),month:Ya(t),day:Ya(n),hour:Ya(r)}}if(t.toggles.tenGods&&(u.tenGods=c.get(`tenGods.stems`)),t.toggles.hiddenStems){let e=c.get(`hiddenStems.branches`);if(u.hiddenStems={year:e.year.map(Xa),month:e.month.map(Xa),day:e.day.map(Xa),hour:e.hour.map(Xa)},t.toggles.tenGods){let e=c.get(`tenGods.hiddenStems`);u.tenGodsHiddenStems={year:e.year.map(Za),month:e.month.map(Za),day:e.day.map(Za),hour:e.hour.map(Za)}}}if(t.toggles.elementDistribution&&(u.elementDistribution=c.get(`elements.distribution`)),t.toggles.lifeStages&&(u.lifeStages=c.get(`lifeStages.pillars`)),t.toggles.stemRelations&&(u.stemRelations=c.get(`relations.stems`).map(e=>({type:e.type,members:e.members.map(qa),resultElement:e.resultElement}))),t.toggles.relations&&(u.relations=c.get(`relations.branches`).map(e=>({type:e.type,members:e.members.map(Ja)}))),t.toggles.fortune){let e=c.get(`fortune.timeline`);u.fortune={start:{direction:e.start.direction,boundary:{id:e.start.boundary.id,utcMs:e.start.boundary.utcMs},deltaMs:e.start.deltaMs,startAgeYears:e.start.startAgeYears,startAgeParts:e.start.startAgeParts,startUtcMsApprox:e.start.startUtcMsApprox,formula:e.start.formula},decades:e.decades.map(e=>({index:e.index,startAgeYears:e.startAgeYears,endAgeYears:e.endAgeYears,pillar:Ya(e.pillar),startUtcMs:e.startUtcMs,endUtcMs:e.endUtcMs})),years:e.years.slice(0,30).map(e=>({solarYear:e.solarYear,pillar:Ya(e.pillar),startUtcMs:e.startUtcMs,endUtcMs:e.endUtcMs,approxStartAgeYears:e.approxStartAgeYears,approxEndAgeYears:e.approxEndAgeYears})),months:e.months?.slice(0,24).map(e=>({solarYear:e.solarYear,monthOrder:e.monthOrder,startJie:e.startJie,pillar:Ya(e.pillar),startUtcMs:e.startUtcMs,endUtcMs:e.endUtcMs,approxStartAgeYears:e.approxStartAgeYears,approxEndAgeYears:e.approxEndAgeYears})),days:e.days?.slice(0,60).map(e=>({localDate:e.localDate,pillar:Ya(e.pillar),startUtcMs:e.startUtcMs,endUtcMs:e.endUtcMs,approxStartAgeYears:e.approxStartAgeYears,approxEndAgeYears:e.approxEndAgeYears}))}}if(t.toggles.rules){u.strength=c.get(`strength.index`);let e=c.get(`rules.yongshin`);u.yongshin={best:e.best,ranking:e.ranking,strengthIndex:e.base.strengthIndex};let t=c.get(`rules.gyeokguk`);u.gyeokguk={best:t.best,ranking:t.ranking};let n=c.get(`rules.shinsal`);u.shinsal=n.detections.filter(e=>e.active!==!1&&e.targetKind===`BRANCH`&&typeof e.targetBranch==`number`).map(e=>({name:e.name,basedOn:e.basedOn,targetBranch:Ja(e.targetBranch)})),u.shinsalHits=n.detections.filter(e=>e.active!==!1).map(e=>({name:e.name,basedOn:e.basedOn,targetKind:e.targetKind,targetBranch:e.targetBranch==null?void 0:Ja(e.targetBranch),targetStem:e.targetStem==null?void 0:qa(e.targetStem),targetBranches:e.targetBranches?e.targetBranches.map(Ja):void 0,targetStems:e.targetStems?e.targetStems.map(qa):void 0,details:e.details,matchedPillars:e.matchedPillars,quality:e.quality,qualityWeight:e.qualityWeight,invalidated:e.invalidated,conditionPenalty:e.conditionPenalty,qualityReasons:e.qualityReasons})),u.shinsalScores=Object.entries(n.scores).filter(([e])=>e.startsWith(`shinsal.`)).map(([e,t])=>({key:e,score:t})).sort((e,t)=>t.score-e.score),u.shinsalScoresAdjusted=Object.entries(n.scoresAdjusted).filter(([e])=>e.startsWith(`shinsal.`)).map(([e,t])=>({key:e,score:t})).sort((e,t)=>t.score-e.score)}let d={apiVersion:`1`,engine:{name:`saju-math-engine`,version:`0.34.3`},config:{schemaVersion:t.schemaVersion,digest:n},input:{normalizedRequest:i},summary:u,report:{facts:Object.fromEntries(c.entries()),trace:l,diagnostics:{warnings:[],notes:[]}},artifacts:{}},f=Os(t);if(f.enabled){let e=f.key??`analysis.zip`,t={prettyJson:f.prettyJson,include:f.include,level:f.level,narration:f.narration};d.artifacts[e]=Es(d,t)}return d}}}var As=[`GAP`,`EUL`,`BYEONG`,`JEONG`,`MU`,`GI`,`GYEONG`,`SIN`,`IM`,`GYE`],js=[`JA`,`CHUK`,`IN`,`MYO`,`JIN`,`SA`,`O`,`MI`,`SIN`,`YU`,`SUL`,`HAE`],Ms=[`WOOD`,`FIRE`,`EARTH`,`METAL`,`WATER`],Ns={WOOD:`목`,FIRE:`화`,EARTH:`토`,METAL:`금`,WATER:`수`},Ps={BI_GYEON:`비견격`,GYEOB_JAE:`겁재격`,JEONG_GWAN:`정관격`,PYEON_GWAN:`편관격`,JEONG_JAE:`정재격`,PYEON_JAE:`편재격`,SIK_SIN:`식신격`,SANG_GWAN:`상관격`,JEONG_IN:`정인격`,PYEON_IN:`편인격`,HUA_QI:`화기격`,ZHUAN_WANG:`전왕격`,CONG_GE:`종격`,CONG_CAI:`종재격`,CONG_GUAN:`종관격`,CONG_SHA:`종살격`,CONG_ER:`종아격`,CONG_YIN:`종인격`,CONG_BI:`종비격`},Fs=37.5665,Is=126.978,Ls=`Asia/Seoul`,Rs=1,zs=.5,Bs=1.7,Vs={GEOB_JAE:`GYEOB_JAE`,SIK_SHIN:`SIK_SIN`},Hs=new Set([`JEONG_GWAN`,`PYEON_GWAN`,`JEONG_JAE`,`PYEON_JAE`,`SIK_SIN`,`SANG_GWAN`,`JEONG_IN`,`PYEON_IN`,`BI_GYEON`,`GYEOB_JAE`]),Us={CHUNG:`지지 충(沖) 관계`,HAE:`지지 해(害) 관계`,PA:`지지 파(破) 관계`,WONJIN:`지지 원진(怨嗔) 관계`,HYEONG:`지지 형(刑) 관계`,HAP:`지지 합(合) 관계`,SAMHAP:`지지 삼합(三合) 관계`,BANGHAP:`지지 방합(方合) 관계`},Ws={CHUNG:`충(沖)`,HAE:`해(害)`,PA:`파(破)`,WONJIN:`원진(怨嗔)`,HYEONG:`형(刑)`,HAP:`합(合)`,SAMHAP:`삼합(三合)`,BANGHAP:`방합(方合)`},Gs={HAP:`천간 합(合) 관계`,CHUNG:`천간 충(沖) 관계`,GEUK:`천간 극(剋) 관계`},Ks={KOREAN_MAINSTREAM:{dayCutMode:`YAZA_23_30_TO_01_30_NEXTDAY`,includeEquationOfTime:!1,lmtBaselineLongitude:135},TRADITIONAL_CHINESE:{dayCutMode:`YAZA_23_30_TO_01_30_NEXTDAY`,includeEquationOfTime:!1,lmtBaselineLongitude:120},MODERN_INTEGRATED:{dayCutMode:`JOJA_SPLIT`,includeEquationOfTime:!0,lmtBaselineLongitude:135}},qs=!1,Js=!0,Ys=`YAZA_23_30_TO_01_30_NEXTDAY`;function Xs(e,t){let n=Number(e);return Number.isFinite(n)?Math.trunc(n):t}function Zs(e){let t=Xs(e,12);return Math.max(0,Math.min(23,t))}function Qs(e){let t=Xs(e,0);return Math.max(0,Math.min(59,t))}function $s(){return JSON.parse(JSON.stringify(E))}function ec(e){return!!e&&typeof e==`object`&&!Array.isArray(e)}function tc(e,t){if(!ec(e)||!ec(t))return e;let n={...e};for(let[e,r]of Object.entries(t)){let t=n[e];ec(t)&&ec(r)?n[e]=tc(t,r):n[e]=r}return n}function nc(e){switch(e){case`MIDNIGHT_00`:return{dayBoundary:`midnight`,dayCutShiftMinutes:0};case`JOJA_SPLIT`:return{dayBoundary:`midnight`,dayCutShiftMinutes:0};case`YAZA_23_TO_01_NEXTDAY`:return{dayBoundary:`ziSplit23`,dayCutShiftMinutes:0};case`YAZA_23_30_TO_01_30_NEXTDAY`:return{dayBoundary:`ziSplit23`,dayCutShiftMinutes:-30};default:return{dayBoundary:`midnight`,dayCutShiftMinutes:0}}}function rc(e){return e===`YAZA_23_TO_01_NEXTDAY`||e===`YAZA_23_30_TO_01_30_NEXTDAY`}function ic(e){return typeof e.yazaEnabled==`boolean`?e.yazaEnabled?rc(e.dayCutMode)?e.dayCutMode:rc(e.yazaMode)?e.yazaMode:Ys:`MIDNIGHT_00`:e.dayCutMode?e.dayCutMode:`MIDNIGHT_00`}function ac(e){let t=e.trim().toUpperCase().replace(`UTC`,`GMT`);if(t===`GMT`||t===`GMT+0`||t===`GMT+00`||t===`GMT+00:00`)return 0;let n=t.match(/GMT([+-])(\d{1,2})(?::?(\d{2}))?$/);if(!n)return null;let r=n[1]===`-`?-1:1,i=Number(n[2]),a=Number(n[3]??0);return!Number.isFinite(i)||!Number.isFinite(a)?null:r*(i*60+a)}function oc(e,t){try{return ac(new Intl.DateTimeFormat(`en-US`,{timeZone:t,timeZoneName:`shortOffset`,hour:`2-digit`,minute:`2-digit`,hourCycle:`h23`}).formatToParts(new Date(e)).find(e=>e.type===`timeZoneName`)?.value??`GMT+00:00`)??540}catch{return 540}}function sc(e,t){let n=ac(e);if(n!=null)return n;let r=Date.UTC(t.y,t.m-1,t.d,t.h,t.min,0);return oc(r-oc(r,e)*6e4,e)}function cc(e){let t=e>=0?`+`:`-`,n=Math.abs(e);return`${t}${String(Math.floor(n/60)).padStart(2,`0`)}:${String(n%60).padStart(2,`0`)}`}function lc(e,t){if(!t)return{...e};let n=Date.UTC(e.y,e.m-1,e.d,e.h,e.min,0),r=new Date(n+t*6e4);return{y:r.getUTCFullYear(),m:r.getUTCMonth()+1,d:r.getUTCDate(),h:r.getUTCHours(),min:r.getUTCMinutes()}}function uc(e){return{y:Xs(e.birthYear,0),m:Xs(e.birthMonth,1),d:Xs(e.birthDay,1),h:Zs(e.birthHour),min:Qs(e.birthMinute)}}function dc(e,t){return`${String(e.y).padStart(4,`0`)}-${String(e.m).padStart(2,`0`)}-${String(e.d).padStart(2,`0`)}T${String(e.h).padStart(2,`0`)}:${String(e.min).padStart(2,`0`)}:00${cc(t)}`}function fc(e){let t=String(e??``);return t?Vs[t]??t:``}function pc(e){let t=Number(e);return As[Number.isFinite(t)?(Math.trunc(t)%10+10)%10:0]??``}function mc(e){let t=Number(e);return js[Number.isFinite(t)?(Math.trunc(t)%12+12)%12:0]??``}function hc(e,t){let n=Number(e);if(!Number.isFinite(n))return 0;let r=10**t;return Math.round(n*r)/r}function gc(e,t){if(!Number.isFinite(e)||!Number.isFinite(t))return .5;let n=e-t;return n<=0?.35:n>=1?1:Math.max(.35,Math.min(1,n))}function _c(e){if(!Number.isFinite(e))return 0;let t=Math.max(0,Math.min(1,e<=1?e:e/100));return Math.round(t*100)}function vc(e){let t=String(e??``).trim().toUpperCase(),n=String(e??``).trim();return Ns[t]??(n||`-`)}function yc(e){let t=String(e??``).trim().toUpperCase();return Ps[Vs[t]??t]??Ps[t]??(t||`-`)}function bc(e,t,n){let r=vc(t.element),i=vc(n||`상위`),a=_c(Number(t.score));return e===0?`${r} 기운이 가장 강해 용신 1순위입니다 (신뢰도 ${a}점).`:e===1?`${r} 기운은 ${i} 기운을 보조하는 희신 후보입니다 (신뢰도 ${a}점).`:`${r} 기운은 후순위 균형 보완 후보입니다 (신뢰도 ${a}점).`}function xc(e){let t=String(e??``);return t===`YEAR_BRANCH`?`YEAR`:t===`MONTH_BRANCH`?`MONTH`:t===`DAY_BRANCH`?`DAY`:`OTHER`}function Sc(e){let t=Number(e);return Number.isFinite(t)?t>=.85?`A`:t>=.5?`B`:`C`:`C`}function Cc(e){return[e[0]?.element??``,e[1]?.element??null]}function wc(e){let t=String(e??``).trim().toUpperCase();return!t||!Hs.has(t)?null:fc(t)}function Tc(e){let t=e.report?.facts?.[`rules.facts`],n=Array.isArray(t?.shinsal?.gongmang?.day)?t.shinsal.gongmang.day:[];return n.length<2?[]:[mc(n[0]),mc(n[1])]}function Ec(e,t){return t[String(e??``).toUpperCase()]??``}function Dc(e){return Ws[String(e??``).toUpperCase()]??null}function Oc(e){return ec(e)?e:{}}function kc(e){let t={};return e.schemaVersion&&typeof e.schemaVersion==`string`&&(t.schemaVersion=e.schemaVersion),e.school&&ec(e.school)&&(t.school=e.school),e.calendar&&ec(e.calendar)&&(t.calendar=e.calendar),e.toggles&&ec(e.toggles)&&(t.toggles=e.toggles),e.weights&&ec(e.weights)&&(t.weights=e.weights),e.strategies&&ec(e.strategies)&&(t.strategies=e.strategies),e.extensions&&ec(e.extensions)&&(t.extensions=e.extensions),t}function Ac(e,t){let n=nc(ic(e)),r=e.trueSolarTimeEnabled??qs,i=e.includeEquationOfTime??!0,a=$s();return a.calendar.dayBoundary=n.dayBoundary,a.calendar.trueSolarTime.enabled=r,a.calendar.trueSolarTime.equationOfTime=r&&i?`approx`:`off`,a.calendar.trueSolarTime.applyTo=`dayAndHour`,a.calendar.solarTerms={method:`meeus`,alwaysCompute:!1},a=tc(a,kc(e)),{config:a,dayCutShiftMinutes:n.dayCutShiftMinutes}}function jc(e){return e/60*15}function Mc(e,t,n){return Number.isFinite(t)?e-(t-n):e}function Nc(e,t,n){let r=uc(e),i=lc(r,n),a=sc(e.timezone??Ls,i),o=jc(a),s=Number.isFinite(e.longitude)?Number(e.longitude):Is,c=Number.isFinite(e.latitude)?Number(e.latitude):Fs,l=t.longitudeCorrectionEnabled??Js,u=Number.isFinite(t.lmtBaselineLongitude)?Number(t.lmtBaselineLongitude):o,d=l?Mc(s,u,o):s,f=dc(i,a),p=e.gender===`FEMALE`?`F`:`M`;return{request:{birth:{instant:f,calendar:`gregorian`},sex:p,location:{lat:c,lon:d,name:e.name}},standard:r,analysisLocal:i}}function Pc(e){return e.summary?.pillars??{year:{stem:{idx:0},branch:{idx:0}},month:{stem:{idx:0},branch:{idx:0}},day:{stem:{idx:0},branch:{idx:0}},hour:{stem:{idx:0},branch:{idx:0}}}}function Fc(e){let t=Object.entries(e).reduce((e,[,t])=>e+Number(t||0),0);if(t<=0)return{deficientElements:[],excessiveElements:[]};let n=t/5,r=[],i=[];for(let t of Ms){let a=Number(e[t]??0);a===0||a<=n*zs?r.push(t):a>=n*Bs&&i.push(t)}return{deficientElements:r,excessiveElements:i}}function Ic(e){return e===`year`?`YEAR`:e===`month`?`MONTH`:e===`day`?`DAY`:`HOUR`}function Lc(e,t,n,r,i){let a=e.report?.facts,o=a?.[`time.trueSolarCorrection`]??{},s=a?.[`time.solarLocalDateTime`]??a?.[`time.localDateTimeForHour`]??null,c=s?.date&&s?.time?{y:Xs(s.date.y,t.y),m:Xs(s.date.m,t.m),d:Xs(s.date.d,t.d),h:Xs(s.time.h,t.h),min:Xs(s.time.min,t.min)}:lc(t,Math.round(Number(o.totalCorrectionMinutes??0))),l=Pc(e),u=pc(l.year.stem.idx),d=mc(l.year.branch.idx),f=pc(l.month.stem.idx),p=mc(l.month.branch.idx),m=pc(l.day.stem.idx),h=mc(l.day.branch.idx),g=pc(l.hour.stem.idx),_=mc(l.hour.branch.idx),v=e.summary?.strength,y=Number(v?.index??0),b=Number(v?.support??0),x=Number(v?.pressure??0),S=v?.components??{},C=y>=.15?`STRONG`:y<=-.15?`WEAK`:`BALANCED`,w=C===`STRONG`?`신강`:C===`WEAK`?`신약`:`중화`,T=e.summary?.yongshin,E=Array.isArray(T?.ranking)?T.ranking.map(e=>({element:String(e?.element??``),score:Number(e?.score??0)})):[],[D,O]=Cc(E),k=E.length?E[E.length-1]?.element??null:null,A=E.length>1?E[E.length-2]?.element??null:null,j=_c(gc(Number(E[0]?.score??0),Number(E[1]?.score??0))),M=e.summary?.gyeokguk,N=String(M?.best??``).replace(/^gyeokguk\./,``),P=wc(N),F=Number(M?.ranking?.[0]?.score??0),I=N.startsWith(`CONG_`)||N===`ZHUAN_WANG`,L=e.summary?.elementDistribution?.total??{},R={WOOD:hc(L.WOOD??0,Rs),FIRE:hc(L.FIRE??0,Rs),EARTH:hc(L.EARTH??0,Rs),METAL:hc(L.METAL??0,Rs),WATER:hc(L.WATER??0,Rs)},{deficientElements:z,excessiveElements:B}=Fc(R),V=(Array.isArray(e.summary?.stemRelations)?e.summary.stemRelations:[]).map(e=>({type:String(e?.type??``),members:Array.isArray(e?.members)?e.members.map(e=>pc(e?.idx)):[],resultOhaeng:e?.resultElement?String(e.resultElement):null,note:Ec(String(e?.type??``),Gs)})),H=(Array.isArray(e.summary?.relations)?e.summary.relations:[]).map(e=>{let t=String(e?.type??``),n=Ec(t,Us);return{type:t,members:Array.isArray(e?.members)?e.members.map(e=>mc(e?.idx)):[],note:n,outcome:Dc(t),reasoning:null}}),U=e.summary?.tenGods,W=e.summary?.hiddenStems,G=e.summary?.tenGodsHiddenStems,ee={};for(let e of[`year`,`month`,`day`,`hour`]){let t=Ic(e),n=Array.isArray(G?.[e])?G[e]:[],r=Array.isArray(W?.[e])?W[e]:[];ee[t]={cheonganSipseong:e===`year`?fc(U?.yearStem):e===`month`?fc(U?.monthStem):e===`hour`?fc(U?.hourStem):`BI_GYEON`,jijiPrincipalSipseong:fc(n[0]?.tenGod),hiddenStems:r.map(e=>({stem:pc(e?.stem?.idx),ratio:Number(e?.weight??0)})),hiddenStemSipseong:n.map(e=>({entry:{stem:pc(e?.stem?.idx)},sipseong:fc(e?.tenGod)}))}}let K=Array.isArray(e.summary?.shinsalHits)?e.summary.shinsalHits:[],q=new Map;for(let e of K){let t=String(e?.name??``),n=xc(e?.basedOn),r=Sc(e?.qualityWeight),i=Number(e?.qualityWeight??.6),a=Math.max(0,Math.min(100,Math.round(i*100))),o=a*1,s={hit:{type:t,position:n,grade:r},baseWeight:a,positionMultiplier:1,weightedScore:o},c=`${t}|${n}`,l=q.get(c);(!l||o>l.weightedScore)&&q.set(c,s)}let J=[...q.values()],te=J.map(e=>e.hit),Y=Tc(e),ne=e.summary?.fortune,re=Array.isArray(ne?.decades)?ne.decades:[],ie=Array.isArray(ne?.years)?ne.years:[],ae=typeof r==`number`?ie.filter(e=>Number(e?.solarYear)>=r):ie,oe=typeof i==`number`&&i>0?ae.slice(0,i):ae,se=(typeof n==`number`&&n>0?re.slice(0,n):re).map(e=>({pillar:{cheongan:pc(e?.pillar?.stem?.idx),jiji:mc(e?.pillar?.branch?.idx)},startAge:Number(e?.startAgeYears??0),endAge:Number(e?.endAgeYears??0),order:Number(e?.index??0)})),ce=oe.map(e=>({year:Number(e?.solarYear??0),pillar:{cheongan:pc(e?.pillar?.stem?.idx),jiji:mc(e?.pillar?.branch?.idx)}})),le=(Array.isArray(e.report?.trace?.nodes)?e.report.trace.nodes:[]).map(e=>({key:String(e?.id??``),summary:String(e?.formula??e?.explain??``),evidence:Array.isArray(e?.deps)?e.deps.map(String):[],citations:[],reasoning:e?.explain?[String(e.explain)]:[],confidence:null}));return{pillars:{year:{cheongan:u,jiji:d},month:{cheongan:f,jiji:p},day:{cheongan:m,jiji:h},hour:{cheongan:g,jiji:_}},coreResult:{standardYear:t.y,standardMonth:t.m,standardDay:t.d,standardHour:t.h,standardMinute:t.min,adjustedYear:c.y,adjustedMonth:c.m,adjustedDay:c.d,adjustedHour:c.h,adjustedMinute:c.min,dstCorrectionMinutes:0,longitudeCorrectionMinutes:Number(o.longitudeCorrectionMinutes??0),equationOfTimeMinutes:Number(o.equationOfTimeMinutes??0)},strengthResult:{dayMasterElement:String(l?.day?.stem?.element??``),level:C,isStrong:y>=0,score:{totalSupport:b,totalOppose:x,deukryeong:Number(S.companions??0),deukji:Number(S.resources??0),deukse:Number(S.companions??0)+Number(S.resources??0)},details:[`강약 판정: ${w}`,`강약 지수: ${y.toFixed(3)}`,`생조 합: ${b.toFixed(3)}`,`극설 합: ${x.toFixed(3)}`]},yongshinResult:{finalYongshin:D,finalHeesin:O,gisin:k,gusin:A,finalConfidence:j,agreement:`RANKING`,recommendations:E.slice(0,3).map((e,t)=>({type:t===0?`JOHU`:`RANKING`,primaryElement:e.element,secondaryElement:E[t+1]?.element??null,confidence:_c(Math.max(0,Math.min(1,Number(e.score)))),reasoning:bc(t,e,D)}))},gyeokgukResult:{type:N,category:I?`JONGGYEOK`:`NORMAL`,baseSipseong:P,confidence:Math.max(0,Math.min(1,F)),reasoning:N?`격국 후보 중 ${yc(N)}이(가) 가장 유력합니다.`:`격국 후보를 확정하기 어려워 추가 검토가 필요합니다.`},ohaengDistribution:R,deficientElements:z,excessiveElements:B,cheonganRelations:V,scoredCheonganRelations:[],jijiRelations:H,resolvedJijiRelations:[],tenGodAnalysis:{dayMaster:m,byPosition:ee},shinsalHits:te,weightedShinsalHits:J,shinsalComposites:[],gongmangVoidBranches:Y,daeunInfo:{isForward:String(ne?.start?.direction??`FORWARD`)!==`BACKWARD`,firstDaeunStartAge:Number(ne?.start?.startAgeYears??0),firstDaeunStartMonths:Number(ne?.start?.startAgeParts?.months??0),boundaryMode:String((e.report?.facts)?.[`policy.calendar`]?.dayBoundary??``),warnings:[],daeunPillars:se},saeunPillars:ce,trace:le}}function Rc(e){return{birthYear:Xs(e.birthYear,0),birthMonth:Xs(e.birthMonth,1),birthDay:Xs(e.birthDay,1),birthHour:Zs(e.birthHour),birthMinute:Qs(e.birthMinute),gender:e.gender===`FEMALE`?`FEMALE`:`MALE`,calendarType:e.calendarType===`LUNAR`?`LUNAR`:`SOLAR`,isLeapMonth:e.isLeapMonth,timezone:e.timezone??Ls,latitude:Number.isFinite(e.latitude)?Number(e.latitude):Fs,longitude:Number.isFinite(e.longitude)?Number(e.longitude):Is,name:e.name}}function zc(e){return{...Ks[String(e??``).trim().toUpperCase()]??Ks.KOREAN_MAINSTREAM}}function Bc(e,t,n){let r=Rc(e);if(r.calendarType===`LUNAR`)throw Error(`Legacy lunar input is not supported in the current engine bridge.`);let i=Oc(t),{config:a,dayCutShiftMinutes:o}=Ac(i,r.timezone??Ls),{request:s,standard:c}=Nc(r,i,o);return Lc(ks(a).analyze(s),c,n?.daeunCount,n?.saeunStartYear,n?.saeunYearCount)}export{Bc as analyzeSaju,T as applySchoolPreset,H as branchElement,B as branchHanja,W as branchYinYang,lo as buildNarrationArtifact,Fi as compileGyeokgukRuleSpec,ya as compileShinsalConditionsRuleSpec,ua as compileShinsalRuleSpec,di as compileYongshinRuleSpec,zc as configFromPreset,Rc as createBirthInput,ks as createEngine,E as defaultConfig,Tt as detectBranchRelations,zt as elementDistributionFromPillars,x as getSchoolPreset,Lt as hiddenStemsOfBranch,b as listSchoolPresets,Es as packAnalysisBundleZip,Pt as rawHiddenStemsTable,V as stemElement,z as stemHanja,U as stemYinYang,rn as tenGodOf,Ds as unpackAnalysisBundleZip};